<html lang="en">
<head>
<title>Scheduling and Event Management</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Scheduling and Event Management">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="top" href="#Top">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
@font-face {
    font-family: 'CFE_FONT';
    src: url('fonts/eot/opensans-regular-webfont.eot');
    src: local('â˜º'),  url('fonts/ttf/opensans-regular-webfont.ttf') format('truetype'), url('fonts/svg/opensans-regular-webfont.svg') format('svg');
    font-weight: normal;
    font-style: normal;
}    
pre {
    background-color: #EEFFDD;
    border: 1px solid #CCCCCC;
    font-family: courier;
    margin-bottom: 10px;
    margin-top: 10px;
    padding: 5px;
    font-size: 90%;
    }
pre.display { font-family:inherit }
pre.format  { font-family:inherit }
pre.smallexample
pre.smalllisp,
pre.smallformat,
pre.smalldisplay {
  font-size: 90%;
} 

span.sc    { font-variant:small-caps }
span.roman { font-family:serif; font-weight:normal; } 
span.sansserif { font-family:sans-serif; font-weight:normal; } 

body {
    font:  90%  'CFE_FONT', arial, Helvetica,sans-serif; 
    color: #646464;
    padding: 10px 20px;
    width: 960px;
    margin: 0 auto;
}
.node
{
    text-align: right;
    padding: 2px;
    font-size: smaller;
}
.node hr {
    border: 0;
    width: 100%;
    color: #CCC;
    background-color: #CCC;
    height: 5px;
}
.section {
    padding-right: 0px;
    padding-bottom: 0px;
    padding-left: 0px;
}

h1 {
    font-size: 26px;
    font-weight: normal;
    line-height: 32px;
    margin: 32px 0 16px;
    text-align: left;
    text-transform: uppercase;
}

h2 {
    color: #9E9981 !important;
    font-size: 16px;
    line-height: 18px;
    font-weight: normal;
    margin: 16px 0 26px;
    text-align: left;
}
h3 {
    margin-top: 3px;
    margin-right: 0px;
    margin-bottom: 10px;
    margin-left: 0px;
    line-height: 20px;
    font-size: 16px;
    font-weight: normal;
}

.contents
{
    background-color: #CCC;
    padding-top: 2px;
    padding-right: 2px;
    padding-bottom: 2px;
    padding-left: 10px;
}

.index-cp
{  
background: #fff url(index-cp.png) right repeat-y;
}

.index-vr
{  
background: #fff url(index-vr.png) right repeat-y;
}

.index-mb
{  
background: #eee url(index-faq.png) right repeat-y;
}

table.border
{
	border-color: #666;
	border-width: 0px;
}

FONT.liten {font-size: 80%; }
 
.tynn {
    font-family: Arial, Helvetica, sans-serif;
    font-size: smaller;
    font-style: normal;
    font-weight: lighter;
    margin-bottom: 0em;
    font-size: 11pt;
}
.verbatim {
    color: #000;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 20px;
    margin-left: 0px;
}
.example {
    color: #000;
    width: 100%;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 20px;
    margin-left: 0px;
}
.smallexample {
    color: #000;
    padding-top: 10px;
    padding-right: 30px;
    padding-bottom: 5px;
    padding-left: 30px;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 0px;
    margin-left: 0px;
}
.cartouche {
    padding: 5px;
    font-style: italic;
    font-size: 85%;
}

table.cartouche {
    border: none !important;
}

 .cartouche td  {
    background: none !important;
    border: none !important;
    padding: 5px; 

/*    background-color: #ddd;
    border: 1px solid #ccc;
    padding: 5px;*/
}

A:link { color: #2c2e70 }
A:visited { color: black }
A:active { color: #600041 }
dt em {font-weight: bold}
/* don't change this rule */    
pre.sp {
    background: none !important;   
    border:none !important
}
/* --- */
/*code hightlight*/
.red { color: #b80047; font-weight: bold; }

.blue { color: blue;  /*font-weight: bold;*/ }

.green { color: darkgreen; }

.comment { font-style: italic; }
--></style>
</head>
<body>
<h1 class="settitle">Scheduling and Event Management</h1>
<div class="node">
<a name="Top"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#What-is-scheduling_003f">What is scheduling?</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#dir">(dir)</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#dir">(dir)</a>

</div>

<h2 class="unnumbered">Scheduling</h2>

<ul class="menu">
<li><a accesskey="1" href="#What-is-scheduling_003f">What is scheduling?</a>
<li><a accesskey="2" href="#How-can-CFEngine-help_003f">How can CFEngine help?</a>
<li><a accesskey="3" href="#Define-jobs-with-basic-profile-information">Define jobs with basic profile information </a>
<li><a accesskey="4" href="#Chaining-jobs-together">Chaining jobs together</a>
<li><a accesskey="5" href="#Calendars">Calendars </a>
<li><a accesskey="6" href="#Logging-execution">Logging execution</a>
<li><a accesskey="7" href="#Scheduling-by-Sensing-Events-and-Patterns">Scheduling by Sensing Events and Patterns</a>
<li><a accesskey="8" href="#Working-with-Unix-cron">Working with Unix cron</a>
<li><a accesskey="9" href="#Commands-promises">Commands promises</a>
<li><a href="#Splaying-host-times">Splaying host times</a>
<li><a href="#Choosing-a-scheduling-interval">Choosing a scheduling interval</a>
<li><a href="#Appendix-_002d-Did-you-know_003f">Appendix - Did you know?</a>
</ul>

   <p><a href="#Contents"><h1>COMPLETE TABLE OF CONTENTS</h1></a>
<h2>Summary of contents</h2>

<div class="node">
<a name="What-is-scheduling%3f"></a>
<a name="What-is-scheduling_003f"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#How-can-CFEngine-help_003f">How can CFEngine help?</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Top">Top</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">What is scheduling?</h3>

<pre class="sp">

</pre>

Scheduling refers to the execution of non-interactive processes or
tasks (usually called `jobs') at designated times and places around a
network of computers. On a given computer, jobs might be run
sequentially in a queue, one after the other, or they might be run in
parallel. 
Jobs can also be started by triggers when sensors see certain system
activity. CFEngine supports a full range of features for customizing
hands-free scheduling.

<div class="node">
<a name="How-can-CFEngine-help%3f"></a>
<a name="How-can-CFEngine-help_003f"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Define-jobs-with-basic-profile-information">Define jobs with basic profile information</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#What-is-scheduling_003f">What is scheduling?</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">How can CFEngine help?</h3>

<p>CFEngine is able to schedule processes or jobs across all managed
nodes, in a platform independent manner. This eliminates the
distributed configuration of shedulers like cron. The time resolution
for this depends on the frequency with with the cf-agent is scheduled
to run. A normal recommendation is that cf-agent runs every 5 minutes,
which is sufficiently often for most batch scheduling requirements.

<div class="node">
<a name="Define-jobs-with-basic-profile-information"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Chaining-jobs-together">Chaining jobs together</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#How-can-CFEngine-help_003f">How can CFEngine help?</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Define jobs with basic profile information</h3>

<p>Jobs are scheduled using CFEngine as <code>commands</code> promises. 
To determine the conditions under which a job should be promised
one uses <code>classes</code>.

<pre class="verbatim"> bundle agent batch_jobs
 {
 commands:

   # Always run job on these three hosts

   host1||host2||host3::

     "/usr/local/bin/my_special_job $(sys.host)"

        comment => "Run the cluster task for this host";
 }
</pre>

<p class="noindent">To limit the job to a special time, we use time-classes:

<pre class="verbatim"> bundle agent batch_jobs
 {
 commands:

   # Run job on all hosts at 13:05pm

   Hr13.Min00_05::

     "/usr/local/bin/my_special_job $(sys.host)"

        comment => "Run the cluster task for this host";
 }
</pre>

<p class="noindent">To combine, location and time coordinates, simply join the classes:

<pre class="verbatim"> bundle agent batch_jobs
 {
 commands:

   # Run job on all hosts at 13:05pm

   (host1||host2||host3).Hr13.Min00_05::

     "/usr/local/bin/my_special_job $(sys.host)"

        comment => "Run the cluster task for this host";
 }
</pre>

<div class="node">
<a name="Chaining-jobs-together"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Calendars">Calendars</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Define-jobs-with-basic-profile-information">Define jobs with basic profile information</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Chaining jobs together</h3>

<p>Creating a managed process by chaining jobs together is also done
using classes. To chain jobs into a sequence, you simply set a
class if when the predecessor completes, and predicate the
antecedant on that class:

<pre class="verbatim">
 bundle agent order
 {
 commands:

  # Dummy jobs to illustrate chaining

  Monday.Hr12.Min30_35::

   "/bin/echo Job one" classes => if_else("success","failure");

  success::

    "/bin/echo Next job";

  failure::

   "/bin/echo Error condition?";

 }

</pre>

<div class="node">
<a name="Calendars"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Logging-execution">Logging execution</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Chaining-jobs-together">Chaining jobs together</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Calendars</h3>

<p>You can define classes based on any combination of events in
CFEngine, and in this way build up special calendars.

<pre class="verbatim"> bundle agent jobs
 {
 classes:

   "holiday" or => { 
                   "July.Day4", 
                   "May.(Day1|Day2|Day3|Day4|Day5|Day6).Monday",
                   "December.Day25" 
                   };

 commands:

   !holidays::

     "/usr/local/bin/my_special_job $(sys.host)"

       comment => "Run the cluster task for this host",
       action  => if_elapsed("240");
 }
</pre>

<p class="noindent">Avoiding weekends is a simple matter, as is testing
to see if the target system fulfills the requirements for the job:

<pre class="verbatim"> bundle agent batch_jobs 
 { 
 classes:

  "weekend" expression => "Saturday|Sunday";

  "have_update_db" expression => fileexists("/usr/bin/updatedb");

 commands:

  (host1||host2||host3).!weekend::

    "/usr/local/bin/my_special_job $(sys.host)"

       comment => "Run the cluster task for this host every six hours",
       action  => if_elapsed("240");

  have_locate_db.Hr01::

    "/usr/bin/updatedb"

       comment => "Update the locate db at 1 a.m. each night, if exists",
       action  => if_elapsed("240");
 }
</pre>

<p class="noindent">Here are some other calendar ideas:

<pre class="verbatim">classes:

"LunchAndTeaBreaks" expression => "!(Saturday|Sunday).(Hr12|Hr10|Hr15)";

"NightShift"        or => { "Hr22", "Hr23", "Night" };

"ConferenceDays"    or => { "Day26", "Day27", "Day29", "Day30" };

"TimeSlices"        or => { "Min01", "Min02", "Min03", "Min10_15"
                            "Min33", "Min34", "Min35" };

"Exception"         not => "Hr12.Min15_20";

</pre>

<div class="node">
<a name="Logging-execution"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Scheduling-by-Sensing-Events-and-Patterns">Scheduling by Sensing Events and Patterns</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Calendars">Calendars</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Logging execution</h3>

<p class="noindent">There are many ways to log events in CFEngine.

<pre class="verbatim"> bundle agent test
 {
 commands:
     
  "/usr/local/myjob"

      action => logme("myjob");     
 }
     
     
 body action logme(x)
 {
 log_repaired => "/tmp/private_$(x)_keptlog.log";
 log_string => "$(sys.date) $(x) promised job succeeded";
 }

</pre>

<p class="noindent">This results in a log file <samp><span class="file">/tmp/private_myjob_keptlog.log</span></samp>
which contains data of the form:

<pre class="smallexample">     Sat Aug 22 11:11:01 2009 myjob promised job succeeded
     Sat Aug 22 11:11:01 2009 myjob promised job succeeded
</pre>
   <div class="node">
<a name="Scheduling-by-Sensing-Events-and-Patterns"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Working-with-Unix-cron">Working with Unix cron</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Logging-execution">Logging execution</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Scheduling by Sensing Events and Patterns</h3>

<p class="noindent">Any measurable event on a system can trigger a response from
cf-agent.

<pre class="verbatim"> bundle agent test
 {
 commands:

   special_event::
      
     "/usr/local/open_help_ticket args";     
 }

</pre>

   <p>For example, the monitoring agent <code>cf-monitord</code> sets system classes
based events that are classified as anomalies on the system, as well as
custom defined observations.

<div class="node">
<a name="Working-with-Unix-cron"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Commands-promises">Commands promises</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Scheduling-by-Sensing-Events-and-Patterns">Scheduling by Sensing Events and Patterns</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Working with Unix <code>cron</code>.</h3>

<p>One of CFEngine's strengths is its use of classes to identify systems
from a single file or set of files. This allows you to have a single,
central CFEngine file which contains all the `cron' jobs on your
system without losing any of the fine control which cron affords
you.

   <p>One way to achieve this is to set up a regular cron job on every
system which executes <code>cf-agent</code> at frequent intervals.  Each
time <code>cf-agent</code> is started, it evaluates time classes and
executes the shell commands defined in its configuration file. 
CFEngine's time classes are much more powerful than
<code>cron</code>'s time specification possibilities, and they add control
over location too.

   <pre class="sp">

</pre>
<p><table class="cartouche" summary="cartouche" border="1"><tr><td>
DO I NEED TO USE CRON? No. With CFEngine's <code>cf-execd</code> you don't
need to use cron at all &ndash; CFEngine can schedule itself. Whether you choose
to run <code>cf-execd</code> in daemon mode, or in wrapper mode is entirely
up to you. 
</td></tr></table>

   <pre class="sp">

</pre>

<div class="node">
<a name="Commands-promises"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Splaying-host-times">Splaying host times</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Working-with-Unix-cron">Working with Unix cron</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Commands promises</h3>

<p>CFEngine commands promises have the general form:

<pre class="smallexample">     
     <var>promise-type</var>:
     
           <var>time-based classes::</var>
     
              <var>Promise</var>
     
</pre>
   <p class="noindent">For example:

<pre class="verbatim">bundle agent example
{
commands:

# Exec during every first quarter-hour after noon

  Hr12.Q1::

    "/path/myscript -arg1 -arg2";

# Exec during any second quarter-hour

  Q2::

    "/path/otherscript";

# Exec during the intervals 00:10 through 00:15 and 12:45 through 12:55
# (English says ``and'', but logic says ``if this interval or that is true''

  Hr00.Min10_15||Hr12.Min45_55::

    "/path/amongstourscripts";

}

</pre>

<p class="noindent">If you want to get fancy, you can set parameters for the
execution of the script by building a container for it that traps its
output and privileges (this applies to root only, since only root has
this power to change privilege).

<pre class="verbatim">bundle agent example
{
commands:

# Exec on the first quarter after noon

  Hr12.Q1::

    "/path/myscript -arg1 -arg2",

          contain => my_custom_jail("nobody","true");
}

# ...

body contain my_custom_jail(owner,devnull)
{
exec_owner => "$(owner)";     # run with this setuid
no_output => "$(devnull)";    # like > /dev/null 2>&amp;1
umask => "77";                # set process umask
}

</pre>
The &lsquo;<samp><span class="samp">contain</span></samp>&rsquo;ment body provides a safe and flexible environment in which
to embed scripts.

   <p>The time resolution of the classes is limited by how often you execute
CFEngine either using cron or <code>cf-execd</code>. Five minutes is the
recommended scheduling interval.

<div class="node">
<a name="Splaying-host-times"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Choosing-a-scheduling-interval">Choosing a scheduling interval</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Commands-promises">Commands promises</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Splaying host times</h3>

<p>In a network of thousands of computers, many agents could start
executing and downloading resources from a server at the same time. 
For instance, if a thousand cf-agents all suddenly wanted to copy a
file from a master source simultaneously this would lead to a big load
on the server. We can prevent this from happening by introducing a
time delay which is unique for each host and not longer than some
given interval;  <code>cf-execd</code> uses a hashing algorithm to generate
a number
between zero and a maximum value in minutes which you define, like
this:

<pre class="verbatim">
body executor control

{
splaytime => "10"; # Minutes
}

</pre>

<div class="node">
<a name="Choosing-a-scheduling-interval"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Appendix-_002d-Did-you-know_003f">Appendix - Did you know?</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Splaying-host-times">Splaying host times</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Choosing a scheduling interval</h3>

<p>How often should you call your global CFEngine configuration? There
are several
things to think about:

     <ul>
<li>How much fine control do you need? Running cron jobs once each hour is
usually enough for most tasks, but you might need to exercise finer
control for a few special tasks.

     <li>Are you going to verify the entire CFEngine configuration file
or just selected promises?

   </ul>

   <p>CFEngine has an intelligent locking and timeout policy which should be
sufficient to handle hanging shell commands from previous crons so that
no overlap can take place.

<div class="node">
<a name="Appendix---Did-you-know%3f"></a>
<a name="Appendix-_002d-Did-you-know_003f"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Choosing-a-scheduling-interval">Choosing a scheduling interval</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h3 class="unnumberedsec">Appendix - Did you know?</h3>

<p>Here are some features that can help you with CFEngine's
scheduling capabilities:

     <ul>
<li>Batch jobs can be made to run in parallel by using <code>background =&gt; "true"</code>
in an <code>action</code> body.

     <li>You can limit the frequency with which a batch job is executed with or without
specifying an actual time of execution using the <code>ifelapsed</code> settings. 
Then a job will only be started if a certain number of minutes have elapsed since it
was last started.

     <li>You can make sure that jobs have not crashed or run out of control using
the <code>expireafter</code> settings. Then a job that seems to have been
running for too long will expire after a defined number of minutes and
will be killed and restarted.

     <li>The monitor agent <code>cf-monitord</code> can watch over special processes
and monitor their resource usage, e.g. memory or CPU usage and report on these
in CFEngine Nova.

     <li>You can arrange for jobs to run in a `sandbox' or `jail', running
as a special user, in a special directory without access to system resources. 
Thus system security can be addressed when running foreign applications.

   </ul>

   <p><a name="Contents">
   <div class="contents">
<h2>Table of Contents</h2>
<ul>
<li><a name="toc_Top" href="#Top">Scheduling</a>
<ul>
<li><a href="#What-is-scheduling_003f">What is scheduling?</a>
<li><a href="#How-can-CFEngine-help_003f">How can CFEngine help?</a>
<li><a href="#Define-jobs-with-basic-profile-information">Define jobs with basic profile information</a>
<li><a href="#Chaining-jobs-together">Chaining jobs together</a>
<li><a href="#Calendars">Calendars</a>
<li><a href="#Logging-execution">Logging execution</a>
<li><a href="#Scheduling-by-Sensing-Events-and-Patterns">Scheduling by Sensing Events and Patterns</a>
<li><a href="#Working-with-Unix-cron">Working with Unix <code>cron</code>.</a>
<li><a href="#Commands-promises">Commands promises</a>
<li><a href="#Splaying-host-times">Splaying host times</a>
<li><a href="#Choosing-a-scheduling-interval">Choosing a scheduling interval</a>
<li><a href="#Appendix-_002d-Did-you-know_003f">Appendix - Did you know?</a>
</li></ul>
</li></ul>
</div>



   <p><script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://
ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-
analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-2576171-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>

</body></html>

