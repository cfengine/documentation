<html lang="en">
<head>
<title>CFEngine Solutions</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="CFEngine Solutions">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="top" href="#Top">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
@font-face {
    font-family: 'CFE_FONT';
    src: url('fonts/eot/opensans-regular-webfont.eot');
    src: local('â˜º'),  url('fonts/ttf/opensans-regular-webfont.ttf') format('truetype'), url('fonts/svg/opensans-regular-webfont.svg') format('svg');
    font-weight: normal;
    font-style: normal;
}    
pre {
    background-color: #EEFFDD;
    border: 1px solid #CCCCCC;
    font-family: courier;
    margin-bottom: 10px;
    margin-top: 10px;
    padding: 5px;
    font-size: 90%;
    }
pre.display { font-family:inherit }
pre.format  { font-family:inherit }
pre.smallexample
pre.smalllisp,
pre.smallformat,
pre.smalldisplay {
  font-size: 90%;
} 

span.sc    { font-variant:small-caps }
span.roman { font-family:serif; font-weight:normal; } 
span.sansserif { font-family:sans-serif; font-weight:normal; } 

body {
    font:  90%  'CFE_FONT', arial, Helvetica,sans-serif; 
    color: #646464;
    padding: 10px 20px;
    width: 960px;
    margin: 0 auto;
}
.node
{
    text-align: right;
    padding: 2px;
    font-size: smaller;
}
.node hr {
    border: 0;
    width: 100%;
    color: #CCC;
    background-color: #CCC;
    height: 5px;
}
.section {
    padding-right: 0px;
    padding-bottom: 0px;
    padding-left: 0px;
}

h1 {
    font-size: 26px;
    font-weight: normal;
    line-height: 32px;
    margin: 32px 0 16px;
    text-align: left;
    text-transform: uppercase;
}

h2 {
    color: #9E9981 !important;
    font-size: 16px;
    line-height: 18px;
    font-weight: normal;
    margin: 16px 0 26px;
    text-align: left;
}
h3 {
    margin-top: 3px;
    margin-right: 0px;
    margin-bottom: 10px;
    margin-left: 0px;
    line-height: 20px;
    font-size: 16px;
    font-weight: normal;
}

.contents
{
    background-color: #CCC;
    padding-top: 2px;
    padding-right: 2px;
    padding-bottom: 2px;
    padding-left: 10px;
}

.index-cp
{  
background: #fff url(index-cp.png) right repeat-y;
}

.index-vr
{  
background: #fff url(index-vr.png) right repeat-y;
}

.index-mb
{  
background: #eee url(index-faq.png) right repeat-y;
}

table.border
{
	border-color: #666;
	border-width: 0px;
}

FONT.liten {font-size: 80%; }
 
.tynn {
    font-family: Arial, Helvetica, sans-serif;
    font-size: smaller;
    font-style: normal;
    font-weight: lighter;
    margin-bottom: 0em;
    font-size: 11pt;
}
.verbatim {
    color: #000;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 20px;
    margin-left: 0px;
}
.example {
    color: #000;
    width: 100%;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 20px;
    margin-left: 0px;
}
.smallexample {
    color: #000;
    padding-top: 10px;
    padding-right: 30px;
    padding-bottom: 5px;
    padding-left: 30px;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 0px;
    margin-left: 0px;
}
.cartouche {
    padding: 5px;
    font-style: italic;
    font-size: 85%;
}

table.cartouche {
    border: none !important;
}

 .cartouche td  {
    background-color: #ddd;
    border: 1px solid #ccc;
    padding: 5px;
}

A:link { color: #2c2e70 }
A:visited { color: black }
A:active { color: #600041 }
dt em {font-weight: bold}
/* don't change this rule */    
pre.sp {
    background: none !important;   
    border:none !important
}
/* --- */
/*code hightlight*/
.red { color: #b80047; font-weight: bold; }

.blue { color: blue;  /*font-weight: bold;*/ }

.green { color: darkgreen; }

.comment { font-style: italic; }
--></style>
</head>
<body>
<h1 class="settitle">CFEngine Solutions</h1>
<div class="node">
<a name="Top"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Introduction">Introduction</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#dir">(dir)</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#dir">(dir)</a>

</div>

<h2 class="unnumbered">CFEngine-Solutions</h2>

   <p><a name="Contents">
   <div class="contents">
<h2>Table of Contents</h2>
<ul>
<li><a name="toc_Top" href="#Top">CFEngine-Solutions</a>
<li><a name="toc_Introduction" href="#Introduction">1 Introduction</a>
<ul>
<li><a href="#Begin-_002d-Get-started">1.1 Begin - Get Started</a>
<li><a href="#Create-files-and-directories">1.2 Create files and directories</a>
<li><a href="#Copy-single-files">1.3 Copy single files</a>
<li><a href="#Copy-directory-trees">1.4 Copy directory trees</a>
<li><a href="#Editing-password-or-group-files">1.5 Editing password or group files</a>
<li><a href="#Editing-password-or-group-files-custom">1.6 Editing password or group files custom</a>
<li><a href="#Disabling-and-rotating-files">1.7 Disabling and rotating files</a>
<li><a href="#Hashing-for-change-detection-_002d-tripwire">1.8 Hashing for change detection (tripwire)</a>
<li><a href="#Command-or-script-execution">1.9 Command or script execution</a>
<li><a href="#Kill-process">1.10 Kill process</a>
<li><a href="#Restart-process">1.11 Restart process</a>
<li><a href="#Check-filesystem-space">1.12 Check filesystem space</a>
<li><a href="#Mount-a-filesystem">1.13 Mount a filesystem</a>
<li><a href="#Software-and-patch-installation">1.14 Software and patch installation</a>
</li></ul>
<li><a name="toc_High-level" href="#High-level">2 High level</a>
<ul>
<li><a href="#Centralized-Management">2.1 Centralized Management</a>
<li><a href="#All-hosts-the-same">2.2 All hosts the same</a>
<li><a href="#Variation-in-hosts">2.3 Variation in hosts</a>
<li><a href="#Updating-from-a-central-hub">2.4 Updating from a central hub</a>
<li><a href="#Change-detection">2.5 Change detection</a>
<li><a href="#Garbage-collection">2.6 Garbage collection</a>
<li><a href="#Distribute-root-passwords">2.7 Distribute root passwords</a>
<li><a href="#Distribute-ssh-keys">2.8 Distribute ssh keys</a>
<li><a href="#Laptop-support-configuration">2.9 Laptop support configuration</a>
<li><a href="#Find-MAC-address">2.10 Find the MAC address</a>
<li><a href="#Log-rotation">2.11 Log rotation</a>
<li><a href="#Manage-a-system-file">2.12 Manage a system file</a>
<li><a href="#Simple-template">2.13 Simple template</a>
<li><a href="#Simple-versioned-template">2.14 Simple versioned template</a>
<li><a href="#Macro-template">2.15 Macro template</a>
<li><a href="#Custom-editing">2.16 Custom editing</a>
<li><a href="#Manage-a-system-process">2.17 Manage a system process</a>
<li><a href="#Ensure-running">2.18 Ensure running</a>
<li><a href="#Ensure-not-running">2.19 Ensure not running</a>
<li><a href="#Prune-processes">2.20 Prune processes</a>
<li><a href="#Manage-users">2.21 Manage users</a>
<li><a href="#Add-users">2.22 Add users</a>
<li><a href="#Remove-users">2.23 Remove users</a>
<li><a href="#Postfix-mail-configuration">2.24 Postfix mail configuration</a>
<li><a href="#Set-up-HPC-clusters">2.25 Set up HPC clusters</a>
<li><a href="#Set-up-name-resolution">2.26 Set up name resolution</a>
<li><a href="#Set-up-sudo">2.27 Set up sudo</a>
<li><a href="#Set-up-a-web-server">2.28 Set up a web server</a>
<li><a href="#Templating">2.29 Templating</a>
</li></ul>
<li><a name="toc_Low-level" href="#Low-level">3 Low level</a>
<ul>
<li><a href="#Aborting-execution">3.1 Aborting execution</a>
<li><a href="#ACL-file-example">3.2 ACL file example</a>
<li><a href="#ACL-generic-example">3.3 ACL generic example</a>
<li><a href="#ACL-secret-example">3.4 ACL secret example</a>
<li><a href="#Active-directory-example">3.5 Active directory example</a>
<li><a href="#Active-list-users-directory-example">3.6 Active list users directory example</a>
<li><a href="#Active-directory-show-users-example">3.7 Active directory show users example</a>
<li><a href="#Add-lines-to-a-file">3.8 Add lines to a file</a>
<li><a href="#Add-users-to-passwd-and-group">3.9 Add users to passwd and group</a>
<li><a href="#Add-software-packages-to-the-system">3.10 Add software packages to the system</a>
<li><a href="#Add-variable-definitions-to-a-file">3.11 Add variable definitions to a file e.g. <samp><span class="file">/etc/system</span></samp></a>
<li><a href="#Application-baseline">3.12 Application baseline</a>
<li><a href="#Array-example">3.13 Array example</a>
<li><a href="#Back-references-in-filenames">3.14 Backreferences in filenames</a>
<li><a href="#BSD-flags">3.15 BSD flags</a>
<li><a href="#Change-directory-for-command">3.16 Change directory for command</a>
<li><a href="#Check-file-or-directory-permissions">3.17 Check file or directory permissions</a>
<li><a href="#Class-match-example">3.18 Class match example</a>
<li><a href="#Client_002dserver-example">3.19 Client-server example</a>
<li><a href="#Commands-example">3.20 Commands example</a>
<li><a href="#Commenting-lines-in-a-file">3.21 Commenting lines in a file</a>
<li><a href="#Copy-files">3.22 Copy files</a>
<li><a href="#Copy-and-flatten-directory">3.23 Copy and flatten directory</a>
<li><a href="#Copy-then-edit">3.24 Copy then edit a file convergently</a>
<li><a href="#Creating-files-and-directories">3.25 Creating files and directories</a>
<li><a href="#Database-creation">3.26 Database creation</a>
<li><a href="#Deleting-lines-from-a-file">3.27 Deleting lines from a file</a>
<li><a href="#Deleting-lines-exception">3.28 Deleting lines exception</a>
<li><a href="#Editing-files">3.29 Editing files</a>
<li><a href="#Editing-tabular-files">3.30 Editing tabular files</a>
<li><a href="#Environment-_0028virtual_0029">3.31 Environments (virtual)</a>
<li><a href="#Environment-variables">3.32 Environment variables</a>
<li><a href="#Execresult-example">3.33 Execresult example</a>
<li><a href="#Inserting-lines-in-a-file">3.34 Inserting lines in a file</a>
<li><a href="#Get-a-list-of-users">3.35 Get a list of users</a>
<li><a href="#Global-classes">3.36 Global classes</a>
<li><a href="#Hello-world">3.37 Hello world</a>
<li><a href="#LDAP-interactions">3.38 LDAP interactions</a>
<li><a href="#Linking-files">3.39 Linking files</a>
<li><a href="#Listing-files_002dpattern-in-a-directory">3.40 Listing files-pattern in a directory</a>
<li><a href="#Locate-and-transform-files">3.41 Locate and transform files</a>
<li><a href="#Logging">3.42 Logging</a>
<li><a href="#Measurements">3.43 Measurements</a>
<li><a href="#Methods">3.44 Methods</a>
<li><a href="#Method-validation">3.45 Method validation</a>
<li><a href="#Mount-NFS-filesystem">3.46 Mount NFS filesystem</a>
<li><a href="#Ordering-promises">3.47 Ordering promises</a>
<li><a href="#Process-management">3.48 Process management</a>
<li><a href="#Read-from-a-TCP-socket">3.49 Read from a TCP socket</a>
<li><a href="#Resolver-management">3.50 Resolver management</a>
<li><a href="#Search-and-replace-text">3.51 Search and replace text</a>
<li><a href="#Selecting-a-region-in-a-file">3.52 Selecting a region in a file</a>
<li><a href="#Service-management-_0028windows_0029">3.53 Service management (windows)</a>
<li><a href="#Set-up-a-PXE-boot-server">3.54 Set up a PXE boot server</a>
<li><a href="#Tidying-garbage-files">3.55 Tidying garbage files</a>
<li><a href="#Software-distribution">3.56 Software distribution</a>
<li><a href="#Trigger-classes">3.57 Trigger classes</a>
<li><a href="#Unmount-NFS-filesystem">3.58 Unmount NFS filesystem</a>
<li><a href="#Web-server-modules">3.59 Web server modules</a>
<li><a href="#Warn-if-matching-line-in-file">3.60 Warn if matching line in file</a>
<li><a href="#Windows-registry">3.61 Windows registry</a>
<li><a href="#unit_005fregistry_005fcache_002ecf">3.62 unit_registry_cache.cf</a>
<li><a href="#unit_005fregistry_002ecf">3.63 unit_registry.cf</a>
</li></ul>
</li></ul>
</div>



<ul class="menu">
<li><a accesskey="1" href="#Introduction">Introduction </a>
<li><a accesskey="2" href="#High-level">High level</a>
<li><a accesskey="3" href="#Low-level">Low level</a>
</ul>

<!-- ********************************************************************** -->
<!-- CHAPTER -->
<!-- ********************************************************************** -->
<div class="node">
<a name="Introduction"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#High-level">High level</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Top">Top</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">1 Introduction</h2>

<p>CFEngine 3 has been redesigned to allow modular solution building in
terms of a simple, regular language.  This guide explains how to use
the CFEngine Community Open Promise-Body Library to express some
simple idioms and approaches for solving common system problems.

   <p>The solutions presented here are necessarily generic and incomplete,
since local environmental issues always define the boundaries of a
solution in a real setting.  A solution guide does not present
finished solutions, but rather hints about how to achieve such
solutions with standardized idioms.

   <p>CFEngine gives you great freedom to craft specific solutions, without
the need for low level coding. For most tasks, you will find the
standardized templates sufficient for your needs, but the possibilties
do not stop there.

   <p>The following resources are available as a supplement to this guide:

     <ul>
<li>Community Open Promise-Body Library, the nuts'n'bolts definitions for the solutions presented here: <a href="http://cfengine.com/manuals/CfengineStdLibrary.html">http://cfengine.com/manuals/CfengineStdLibrary.html</a>
<li>Tutorial: <a href="http://cfengine.com/manuals/cf-manuals/cf3-tutorial.html">http://cfengine.com/manuals/cf-manuals/cf3-tutorial.html</a>
<li>Reference manual: <a href="http://cfengine.com/manuals/cf-manuals/cf3-reference.html">http://cfengine.com/manuals/cf-manuals/cf3-reference.html</a>
</ul>

   <p>If you need assistance in formulating specific solutions for your
system environment, contact CFEngine's Professional Services at
<code>contact@CFEngine.com</code>;

<ul class="menu">
<li><a accesskey="1" href="#Begin-_002d-Get-started">Begin - Get started</a>
<li><a accesskey="2" href="#Create-files-and-directories">Create files and directories</a>
<li><a accesskey="3" href="#Copy-single-files">Copy single files</a>
<li><a accesskey="4" href="#Copy-directory-trees">Copy directory trees</a>
<li><a accesskey="5" href="#Editing-password-or-group-files">Editing password or group files</a>
<li><a accesskey="6" href="#Editing-password-or-group-files-custom">Editing password or group files custom</a>
<li><a accesskey="7" href="#Disabling-and-rotating-files">Disabling and rotating files</a>
<!-- * unit_disable_and_rotate_files.cf:: -->
<!-- * unit_disable.cf:: -->
<li><a accesskey="8" href="#Hashing-for-change-detection-_002d-tripwire">Hashing for change detection - tripwire</a>
<li><a accesskey="9" href="#Command-or-script-execution">Command or script execution</a>
<li><a href="#Kill-process">Kill process</a>
<li><a href="#Restart-process">Restart process</a>
<li><a href="#Check-filesystem-space">Check filesystem space</a>
<li><a href="#Mount-a-filesystem">Mount a filesystem</a>
<li><a href="#Software-and-patch-installation">Software and patch installation</a>
</ul>

<div class="node">
<a name="Begin---Get-started"></a>
<a name="Begin-_002d-Get-started"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Create-files-and-directories">Create files and directories</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Introduction">Introduction</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.1 Begin - Get Started</h3>

<p>To get started with CFEngine, you can imagine the following template for entering examples. 
This part of the code is common to all the examples. <!-- We include it below for completeness, -->
<!-- but you might also like to hide is in yours. -->

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "main" };
<span class="red">inputs </span>=> { "cfengine_stdlib.cf" };
}


<span class="red">bundle agent</span> <span class="blue">main</span>
{
<span class="comment"># example
</span>
}

</pre>
Then you enter the cases as below. The general pattern
of the syntax is like this (colors in html version: red, CFEngine word; blue, user-defined word):

<pre class="verbatim"># The general pattern

<span class="red">bundle component</span> <span class="blue">name(parameters)</span>
{ 
<span class="red">what_type:
</span> where_when::

<span class="comment">  # Traditional comment
</span>

  "promiser" -> { "promisee1", "promisee2" },
<span class="red">        comment </span>=><span class="green"> "The intention ...",</span>
<span class="red">         handle </span>=><span class="green"> "unique_id_label",</span>
<span class="red">    attribute_1 </span>=><span class="blue"> body_or_value1,</span>
<span class="red">    attribute_2 </span>=><span class="blue"> body_or_value2;</span>
}

</pre>

<!-- ...................................... -->
<ul class="menu">
<li><a accesskey="1" href="#Create-files-and-directories">Create files and directories</a>
<li><a accesskey="2" href="#Copy-single-files">Copy single files</a>
<li><a accesskey="3" href="#Copy-directory-trees">Copy directory trees</a>
<li><a accesskey="4" href="#Editing-password-or-group-files">Editing password or group files</a>
<li><a accesskey="5" href="#Editing-password-or-group-files-custom">Editing password or group files custom</a>
<li><a accesskey="6" href="#Disabling-and-rotating-files">Disabling and rotating files</a>
<!-- * unit_disable_and_rotate_files.cf:: -->
<!-- * unit_disable.cf:: -->
<li><a accesskey="7" href="#Hashing-for-change-detection-_002d-tripwire">Hashing for change detection - tripwire</a>
<li><a accesskey="8" href="#Command-or-script-execution">Command or script execution</a>
<li><a accesskey="9" href="#Kill-process">Kill process</a>
<li><a href="#Restart-process">Restart process</a>
<li><a href="#Check-filesystem-space">Check filesystem space</a>
<li><a href="#Mount-a-filesystem">Mount a filesystem</a>
<li><a href="#Software-and-patch-installation">Software and patch installation</a>
</ul>

<div class="node">
<a name="Create-files-and-directories"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Copy-single-files">Copy single files</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Begin-_002d-Get-started">Begin - Get started</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.2 Create files and directories</h3>

<p>Create files and directories and set permissions.

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Simple test create files
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/home/mark/tmp/test_plain" 

<span class="red">       perms </span>=><span class="blue"> system,</span>
<span class="red">       create </span>=><span class="green"> "true";</span>

  "/home/mark/tmp/test_dir/." 

<span class="red">       perms </span>=><span class="blue"> system,</span>
<span class="red">       create </span>=><span class="green"> "true";</span>

}

<span class="comment">#########################################################
</span>

<span class="red">body perms</span> <span class="blue">system</span>

{
<span class="red">mode  </span>=><span class="green"> "0640";</span>
}

<span class="comment">#########################################################
</span>

</pre>

<!-- ...................................... -->
<div class="node">
<a name="Copy-single-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Copy-directory-trees">Copy directory trees</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Create-files-and-directories">Create files and directories</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.3 Copy single files</h3>

<p>Copy single files, locally (<code>local_cp</code>) or from a remote site (<code>secure_cp</code>). The Community Open Promise-Body Library (COPBL; <samp><span class="file">cfengine_stdlib.cf</span></samp>) should be included in the <samp><span class="file">/var/cfengine/inputs/</span></samp> directory and input as below.

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence  </span>=> { "mycopy" };
<span class="red">inputs </span>=> { "cfengine_stdlib.cf" };
}

<span class="red">bundle agent</span> <span class="blue">mycopy</span>
{
<span class="red">files:
</span>
  "/home/mark/tmp/test_plain"

<span class="red">    copy_from </span>=><span class="blue"> local_cp("$(sys.workdir)/bin/file");</span>

  "/home/mark/tmp/test_remote_plain"

<span class="red">    copy_from </span>=><span class="blue"> secure_cp("$(sys.workdir)/bin/file","serverhost");</span>
}


</pre>

<!-- ...................................... -->
<div class="node">
<a name="Copy-directory-trees"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Editing-password-or-group-files">Editing password or group files</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Copy-single-files">Copy single files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.4 Copy directory trees</h3>

<p>Copy directory trees, locally (<code>local_cp</code>) or from a remote site (<code>secure_cp</code>). (<code>depth_search =&gt; recurse("")</code>) defines the number of sublevels to include, (<code>"inf"</code>) gets entire tree.

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence  </span>=> { "my_recursive_copy" };
<span class="red">inputs </span>=> { "cfengine_stdlib.cf" };
}

<span class="red">bundle agent</span> <span class="blue">my_recursive_copy</span>
{
<span class="red">files:
</span>
  "/home/mark/tmp/test_dir"

<span class="red">      copy_from </span>=><span class="blue"> local_cp("$(sys.workdir)/bin/."),</span>
<span class="red">   depth_search </span>=><span class="blue"> recurse("inf");</span>

  "/home/mark/tmp/test_dir"

<span class="red">      copy_from </span>=><span class="blue"> secure_cp("$(sys.workdir)/bin","serverhost"),</span>
<span class="red">   depth_search </span>=><span class="blue"> recurse("inf");</span>

}


</pre>

<!-- ...................................... -->
<div class="node">
<a name="Editing-password-or-group-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Editing-password-or-group-files-custom">Editing password or group files custom</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Copy-directory-trees">Copy directory trees</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.5 Editing password or group files</h3>

<p>To change the password of a system, we need to edit a file. A file is
a complex object &ndash; once open there is a new world of possible
promises to make about its contents.  CFEngine has bundles of promises
that are specially for editing.

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "edit_passwd" };
}

<span class="red">bundle agent</span> <span class="blue">edit_passwd</span>
{

<span class="red">vars:
</span>
 "userset"<span class="red"> slist </span>=> { "user1", "user2", "user3" };

<span class="red">files:
</span>
  "/etc/passwd"
<span class="red">     edit_line </span>=><span class="blue"> </span>
        set_user_field("mark","7","/set/this/shell");


  "/etc/group"
<span class="red">     edit_line </span>=><span class="blue"> </span>
        append_user_field("root","4","@(main.userset)");

}

</pre>

<!-- ...................................... -->
<div class="node">
<a name="Editing-password-or-group-files-custom"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Disabling-and-rotating-files">Disabling and rotating files</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Editing-password-or-group-files">Editing password or group files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.6 Editing password or group files custom</h3>

<p>In this example the bundles from the Community Open Promise-Body Library are included directly in the policy instead of being input as a separate file.

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "addpasswd" };
}

<span class="red">bundle agent</span> <span class="blue">addpasswd</span>
{
<span class="red">vars:
</span>
<span class="comment">  # want to set these values by the names of their array keys
</span>

  "pwd[mark]"<span class="red"> string </span>=><span class="green"> "mark:x:1000:100:Mark Burgess:/home/mark:/bin/bash";</span>
  "pwd[fred]"<span class="red"> string </span>=><span class="green"> "fred:x:1001:100:Right Said:/home/fred:/bin/bash";</span>
  "pwd[jane]"<span class="red"> string </span>=><span class="green"> "jane:x:1002:100:Jane Doe:/home/jane:/bin/bash";</span>

<span class="red">files:
</span>

  "/tmp/passwd"

<span class="red">        create </span>=><span class="green"> "true",</span>
<span class="red">     edit_line </span>=><span class="blue"> append_users_starting("addpasswd.pwd");</span>

}

<span class="comment">############################################################
</span>
<span class="comment"># Library stuff
</span>
<span class="comment">############################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">append_users_starting(v)</span>

{
<span class="red">vars:
</span>
  "index"<span class="red">        slist </span>=> getindices("$(v)");

<span class="red">classes:
</span>
  "add_$(index)"<span class="red"> not </span>=> userexists("$(index)");

<span class="red">insert_lines:
</span>
  "$($(v)[$(index)])",

<span class="red">      ifvarclass </span>=><span class="green"> "add_$(index)";</span>

}

<span class="comment">############################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">append_groups_starting(v)</span>

{
<span class="red">vars:
</span>
  "index"<span class="red">        slist </span>=> getindices("$(v)");

<span class="red">classes:
</span>
  "add_$(index)"<span class="red"> not </span>=> groupexists("$(index)");

<span class="red">insert_lines:
</span>
  "$($(v)[$(index)])",

<span class="red">      ifvarclass </span>=><span class="green"> "add_$(index)";</span>

}
</pre>

<!-- ...................................... -->
<div class="node">
<a name="Disabling-and-rotating-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Hashing-for-change-detection-_002d-tripwire">Hashing for change detection - tripwire</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Editing-password-or-group-files-custom">Editing password or group files custom</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.7 Disabling and rotating files</h3>

<p>Use the following simple steps to disable and rotate files. See the Community Open Promise-Body Library if you wish more details on what <code>disable</code> and <code>rotate</code> does.

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence  </span>=> { "my_disable" };
<span class="red">inputs </span>=> { "cfengine_stdlib.cf" };
}

<span class="red">bundle agent</span> <span class="blue">my_disable</span>
{

<span class="red">files:
</span>
  "/home/mark/tmp/test_create"
<span class="red">      rename </span>=><span class="blue"> disable;</span>
 
 "/home/mark/tmp/rotate_my_log"
<span class="red">      rename </span>=><span class="blue"> rotate("4");</span>

}


</pre>

<!-- ...................................... -->
<div class="node">
<a name="Hashing-for-change-detection---tripwire"></a>
<a name="Hashing-for-change-detection-_002d-tripwire"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Command-or-script-execution">Command or script execution</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Disabling-and-rotating-files">Disabling and rotating files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.8 Hashing for change detection (tripwire)</h3>

<p>Change detection is a powerful and easy way to monitor your environment, increase awareness and harden your system against security breaches.

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Change detect
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/home/mark/tmp/web" -> "me"

<span class="red">   changes      </span>=><span class="blue"> detect_all_change,</span>
<span class="red">   depth_search </span>=><span class="blue"> recurse("inf");</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body changes</span> <span class="blue">detect_all_change</span>

{
<span class="red">report_changes </span>=><span class="green"> "all";  </span>
<span class="red">update_hashes  </span>=><span class="green"> "true";</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body depth_search</span> <span class="blue">recurse(d)</span>

{
<span class="red">depth        </span>=><span class="green"> "$(d)";</span>
}
</pre>

<!-- ...................................... -->
<div class="node">
<a name="Command-or-script-execution"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Kill-process">Kill process</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Hashing-for-change-detection-_002d-tripwire">Hashing for change detection - tripwire</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.9 Command or script execution</h3>

<p>Execute a command, for instance to start a MySQL service. Note that simple shell commands like <code>rm</code> or <code>mkdir</code> cannot be managed by CFEngine, so none of the protections that CFEngine offers can be applied to the process. Moreover, this starts a new process, adding to the burden on the system. See CFEngine 3 Best Practices <a href="http://cfengine.com/manuals/cf3-bestpractice.html">http://cfengine.com/manuals/cf3-bestpractice.html</a> for more information on how to best write policies.

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence  </span>=> { "my_commands" };
<span class="red">inputs </span>=> { "cfengine_stdlib.cf" };
}


<span class="red">bundle agent</span> <span class="blue">my_commands</span>
{
<span class="red">commands:
</span>
 Sunday.Hr04.Min05_10.myhost::

  "/usr/bin/update_db";

 any::

  "/etc/mysql/start"

<span class="red">      contain </span>=><span class="blue"> setuid("mysql");</span>

}


</pre>

<!-- ...................................... -->
<div class="node">
<a name="Kill-process"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Restart-process">Restart process</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Command-or-script-execution">Command or script execution</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.10 Kill process</h3>

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "test" };
}



<span class="red">bundle agent</span> <span class="blue">test</span>
{
<span class="red">processes:
</span>
 "sleep"

<span class="red">   signals </span>=> { "term", "kill" };

}
</pre>

<!-- ...................................... -->
<div class="node">
<a name="Restart-process"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Check-filesystem-space">Check filesystem space</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Kill-process">Kill process</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.11 Restart process</h3>

<p>A basic pattern for restarting processes:
<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "process_restart" };
}

<span class="comment">#########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">process_restart</span>
{
<span class="red">processes:
</span>
  "/usr/bin/daemon" 
<span class="red">        restart_class </span>=><span class="green"> "launch";</span>

<span class="red">commands:
</span>
  launch::

   "/usr/bin/daemon";

}
</pre>
This can be made more sophisticated to handle generic lists:
<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "process_restart" };
}

<span class="comment">#########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">process_restart</span>
{
<span class="red">vars:
</span>
  "component"<span class="red"> slist </span>=> {
                       "cf-monitord", 
                       "cf-serverd", 
                       "cf-execd" 
                       };
<span class="red">processes:
</span>
  "$(component)" 
<span class="red">        restart_class </span>=> canonify("start_$(component)");

<span class="red">commands:
</span>
   "/var/cfengine/bin/$(component)"
<span class="red">       ifvarclass </span>=> canonify("start_$(component)");

}
</pre>

   <p>Why? Separating this into two parts gives a high level of control
and conistency to CFEngine. There are many options for command execution, like
the ability to run commands in a sandbox or as `setuid'. These should not be
reproduced in <code>processes</code>.

<!-- ...................................... -->
<div class="node">
<a name="Check-filesystem-space"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Mount-a-filesystem">Mount a filesystem</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Restart-process">Restart process</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.12 Check filesystem space</h3>

<pre class="verbatim">

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "example" };
}

<span class="comment">###########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">example</span>

{     
<span class="red">vars:
</span>
  "free"<span class="red"> int </span>=> diskfree("/tmp"); 

<span class="red">reports:
</span>
  cfengine_3::

    "Freedisk $(free)";

}

</pre>

<!-- ...................................... -->
<div class="node">
<a name="Mount-a-filesystem"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Software-and-patch-installation">Software and patch installation</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Check-filesystem-space">Check filesystem space</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.13 Mount a filesystem</h3>

<pre class="verbatim">

<span class="comment">#
</span>
<span class="comment"># cfengine 3
</span>
<span class="comment">#
</span>
<span class="comment"># cf-agent -f ./cftest.cf -K
</span>
<span class="comment">#
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence </span>=> { "mounts" };
}

<span class="comment">#
</span>

<span class="red">bundle agent</span> <span class="blue">mounts</span>

{
<span class="red">storage:
</span>
  "/mnt"<span class="red"> mount  </span>=><span class="blue"> nfs("slogans.iu.hio.no","/home");</span>

}

<span class="comment">######################################################################
</span>

<span class="red">body mount</span> <span class="blue">nfs(server,source)</span>

{
<span class="red">mount_type </span>=><span class="green"> "nfs";</span>
<span class="red">mount_source </span>=><span class="green"> "$(source)";</span>
<span class="red">mount_server </span>=><span class="green"> "$(server)";</span>
<span class="comment">#mount_options => { "rw" };
</span>
<span class="red">edit_fstab </span>=><span class="green"> "true";</span>
<span class="red">unmount </span>=><span class="green"> "true";</span>
}
</pre>

<!-- ...................................... -->
<div class="node">
<a name="Software-and-patch-installation"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Mount-a-filesystem">Mount a filesystem</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Introduction">Introduction</a>

</div>

<h3 class="section">1.14 Software and patch installation</h3>

<p>Example for Debian:
<pre class="verbatim">
<span class="comment"># to see list of packages type "apt-cache pkgnames"
</span>
<span class="comment"># to see list of installed packages type "dpkg --get-selections"
</span>
<span class="comment">#
</span>
<span class="comment"># Package managment
</span>
<span class="comment">#
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "packages" };
}

<span class="red">body agent</span> <span class="blue">control</span>
{
<span class="red">environment </span>=> { "DEBIAN_FRONTEND=noninteractive" };
}

<span class="comment">#############################################
</span>

<span class="red">bundle agent</span> <span class="blue">packages</span>
{
<span class="red">vars:
</span>
<span class="comment"> # Test the simplest case -- leave everything to the yum smart manager
</span>

 "match_package"<span class="red"> slist </span>=> { 
                          "apache2" 
<span class="comment">#                          "apache2-mod_php5",
</span>
<span class="comment">#                          "apache2-prefork",
</span>
<span class="comment">#                          "php5" 
</span>
                          };
<span class="red">packages:
</span>
  "$(match_package)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> apt;</span>

}

<span class="comment">#############################################
</span>

<span class="red">body package_method</span> <span class="blue">apt</span>

{
any::

<span class="comment"># ii  acpi      0.09-3ubuntu1     
</span>

<span class="red"> package_changes </span>=><span class="green"> "bulk";</span>
<span class="red"> package_list_command </span>=><span class="green"> "/usr/bin/dpkg -l";</span>

<span class="red"> package_list_name_regex    </span>=><span class="green"> "ii\s+([^\s]+).*";</span>
<span class="red"> package_list_version_regex </span>=><span class="green"> "ii\s+[^\s]+\s+([^\s]+).*";</span>

<span class="comment"># package_list_arch_regex    => "none";
</span>

<span class="red"> package_installed_regex </span>=><span class="green"> ".*"; # all reported are installed</span>

<span class="comment"> #package_name_convention => "$(name)_$(version)_$(arch)";
</span>
<span class="red"> package_name_convention </span>=><span class="green"> "$(name)";</span>

<span class="comment"> # Use these only if not using a separate version/arch string
</span>
<span class="comment"> # package_version_regex => "";
</span>
<span class="comment"> # package_name_regex => "";
</span>
<span class="comment"> # package_arch_regex => "";
</span>

<span class="red">package_add_command </span>=><span class="green"> "/usr/bin/apt-get --yes install";</span>
<span class="red">package_delete_command </span>=><span class="green"> "/usr/bin/apt-get --yes remove";</span>
<span class="red">package_update_command </span>=><span class="green">  "/usr/bin/apt-get --yes dist-upgrade";</span>
<span class="comment">#package_verify_command => "/bin/rpm -V";
</span>
}

</pre>
Examples MSI for Windows, by name:
<pre class="verbatim">
<span class="comment">#
</span>
<span class="comment"># MSI package managment using file name
</span>
<span class="comment">#
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "packages" };
}

<span class="comment">#############################################
</span>

<span class="red">bundle agent</span> <span class="blue">packages</span>
{
<span class="red">vars:
</span>
 "match_package"<span class="red"> slist </span>=> { 
                          "7zip-4.65-x86_64.msi"
                          };
<span class="red">packages:
</span>
  "$(match_package)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> msi_fmatch;</span>

}

<span class="comment">#############################################
</span>

<span class="red">body package_method</span> <span class="blue">msi_fmatch</span>

{
<span class="red"> package_changes </span>=><span class="green"> "individual";</span>
<span class="red"> package_file_repositories </span>=> { "$(sys.workdir)\software_updates\windows", "s:\su" };

<span class="red"> package_installed_regex </span>=><span class="green"> ".*";</span>

<span class="red"> package_name_regex    </span>=><span class="green"> "^(\S+)-(\d+\.?)+";</span>
<span class="red"> package_version_regex </span>=><span class="green"> "^\S+-((\d+\.?)+)";</span>
<span class="red"> package_arch_regex    </span>=><span class="green"> "^\S+-(\d+\.?)+(^.+)";</span>
 
<span class="red"> package_name_convention </span>=><span class="green"> "$(name)-$(version)-$(arch).msi";</span>

<span class="red"> package_add_command </span>=><span class="green"> "\"$(sys.winsysdir)\msiexec.exe\" /qn /i";</span>
<span class="red"> package_update_command </span>=><span class="green"> "\"$(sys.winsysdir)\msiexec.exe\" /qn /i";</span>
<span class="red"> package_delete_command </span>=><span class="green"> "\"$(sys.winsysdir)\msiexec.exe\" /qn /x";</span>
 }
</pre>
Windows MSI by version:
<pre class="verbatim">
<span class="comment">#
</span>
<span class="comment"># MSI package managment using version criteria
</span>
<span class="comment">#
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "packages" };
}

<span class="comment">#############################################
</span>

<span class="red">bundle agent</span> <span class="blue">packages</span>
{
<span class="red">vars:
</span>
 "match_package"<span class="red"> slist </span>=> { 
                          "7zip"
                          };
<span class="red">packages:
</span>
  "$(match_package)"

<span class="red">     package_policy </span>=><span class="green"> "update",</span>
<span class="red">     package_select </span>=><span class="green"> ">=",</span>
<span class="red">     package_architectures </span>=> { "x86_64" },
<span class="red">     package_version </span>=><span class="green"> "3.00",</span>
<span class="red">     package_method </span>=><span class="blue"> msi_vmatch;</span>

}

<span class="comment">#############################################
</span>

<span class="red">body package_method</span> <span class="blue">msi_vmatch</span>

{
<span class="red"> package_changes </span>=><span class="green"> "individual";</span>
<span class="red"> package_file_repositories </span>=> { "$(sys.workdir)\software_updates\windows", "s:\su" };

<span class="red"> package_installed_regex </span>=><span class="green"> ".*";</span>
 
<span class="red"> package_name_convention </span>=><span class="green"> "$(name)-$(version)-$(arch).msi";</span>

<span class="red"> package_add_command </span>=><span class="green"> "\"$(sys.winsysdir)\msiexec.exe\" /qn /i";</span>
<span class="red"> package_update_command </span>=><span class="green"> "\"$(sys.winsysdir)\msiexec.exe\" /qn /i";</span>
<span class="red"> package_delete_command </span>=><span class="green"> "\"$(sys.winsysdir)\msiexec.exe\" /qn /x";</span>
}

</pre>
Examples for solaris are more complex:
<pre class="verbatim">

<span class="comment">#
</span>
<span class="comment"># Package managment
</span>
<span class="comment">#
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "packages" };
<span class="red">inputs </span>=> { "cfengine_stdlb.cf" };
}

<span class="comment">#############################################
</span>

<span class="red">bundle agent</span> <span class="blue">packages</span>
{
<span class="red">vars:
</span>
  "solaris_packages[SMCzlib]"<span class="red"> string </span>=><span class="green"> "zlib-1.2.3-sol10-sparc-local";</span>
  "admin_file"<span class="red">                string </span>=><span class="green"> "cfengine_admin_file";</span>

  "package_names"<span class="red">              slist </span>=> getindices("solaris_packages");

<span class="red">files:
</span>
  "/tmp/$(admin_file)"
<span class="red">	create </span>=><span class="green"> "true",</span>
<span class="red">	edit_defaults </span>=><span class="blue"> empty_file,</span>
<span class="red">	edit_line </span>=><span class="blue"> create_solaris_admin_file;</span>

<span class="red">packages:
</span>
  "$(package_names)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> solaris("$(package_names)", "$(solaris_packages[$(package_names)])", "$(admin_file)");</span>

}

</pre>
Examples for yum based systems:
<pre class="verbatim">

<span class="comment">#
</span>
<span class="comment"># Package managment
</span>
<span class="comment">#
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "packages" };
<span class="red">inputs </span>=> { "cfengine_stdlib.cf" }
}

<span class="comment">#############################################
</span>

<span class="red">bundle agent</span> <span class="blue">packages</span>
{
<span class="red">vars:
</span>
<span class="comment"> # Test the simplest case -- leave everything to the yum smart manager
</span>

 "match_package"<span class="red"> slist </span>=> { 
                          "apache2", 
                          "apache2-mod_php5",
                          "apache2-prefork",
                          "php5" 
                          };
<span class="red">packages:
</span>
  "$(match_package)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> yum;</span>

}

</pre>
SuSE Linux's package manager zypper is the most powerful alternative:
<pre class="verbatim">

<span class="comment">#
</span>
<span class="comment"># Package managment
</span>
<span class="comment">#
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "packages" };
<span class="red">inputs </span>=> { "cfengine_stdlib.cf" }
}

<span class="comment">#############################################
</span>

<span class="red">bundle agent</span> <span class="blue">packages</span>
{
<span class="red">vars:
</span>
<span class="comment"> # Test the simplest case -- leave everything to the zypper smart manager
</span>

 "match_package"<span class="red"> slist </span>=> { 
                          "apache2", 
                          "apache2-mod_php5",
                          "apache2-prefork",
                          "php5" 
                          };
<span class="red">packages:
</span>
  "$(match_package)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> zypper;</span>

}

</pre>

<!-- ********************************************************************** -->
<!-- CHAPTER -->
<!-- ********************************************************************** -->
<div class="node">
<a name="High-level"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Low-level">Low level</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Introduction">Introduction</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">2 High level</h2>

<!--  -->
<ul class="menu">
<li><a accesskey="1" href="#Centralized-Management">Centralized Management</a>
<li><a accesskey="2" href="#All-hosts-the-same">All hosts the same</a>
<li><a accesskey="3" href="#Variation-in-hosts">Variation in hosts</a>
<li><a accesskey="4" href="#Updating-from-a-central-hub">Updating from a central hub</a>
<li><a accesskey="5" href="#Change-detection">Change detection</a>
<li><a accesskey="6" href="#Garbage-collection">Garbage collection</a>
<li><a accesskey="7" href="#Distribute-root-passwords">Distribute root passwords</a>
<li><a accesskey="8" href="#Distribute-ssh-keys">Distribute ssh keys</a>
<li><a accesskey="9" href="#Laptop-support-configuration">Laptop support configuration</a>
<li><a href="#Find-MAC-address">Find MAC address</a>
<li><a href="#Log-rotation">Log rotation</a>
<li><a href="#Manage-a-system-file">Manage a system file</a>
<li><a href="#Simple-template">Simple template</a>
<li><a href="#Simple-versioned-template">Simple versioned template</a>
<li><a href="#Macro-template">Macro template</a>
<li><a href="#Custom-editing">Custom editing</a>
<li><a href="#Manage-a-system-process">Manage a system process</a>
<li><a href="#Ensure-running">Ensure running</a>
<li><a href="#Ensure-not-running">Ensure not running</a>
<li><a href="#Prune-processes">Prune processes</a>
<li><a href="#Manage-users">Manage users</a>
<li><a href="#Add-users">Add users</a>
<li><a href="#Remove-users">Remove users</a>
<li><a href="#Postfix-mail-configuration">Postfix mail configuration</a>
<li><a href="#Set-up-HPC-clusters">Set up HPC clusters</a>
<li><a href="#Set-up-name-resolution">Set up name resolution</a>
<li><a href="#Set-up-sudo">Set up sudo</a>
<li><a href="#Set-up-a-web-server">Set up a web server</a>
<li><a href="#Templating">Templating</a>
</ul>

<div class="node">
<a name="Centralized-Management"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#All-hosts-the-same">All hosts the same</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#High-level">High level</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.1 Centralized Management</h3>

<p>These examples show a simple setup for starting with a central approach to management of
servers. Centralization of management is a simple approach suitable for small environments
with few requirements. It is useful for clusters where systems are all alike.

<!--  -->
<ul class="menu">
<li><a accesskey="1" href="#All-hosts-the-same">All hosts the same</a>
<li><a accesskey="2" href="#Variation-in-hosts">Variation in hosts</a>
<li><a accesskey="3" href="#Updating-from-a-central-hub">Updating from a central hub</a>
</ul>

<div class="node">
<a name="All-hosts-the-same"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Variation-in-hosts">Variation in hosts</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Centralized-Management">Centralized Management</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.2 All hosts the same</h3>

<p>This shows the simplest approach in which all hosts are the same. It is too simple
for most environments, but it serves as a starting point. Compare it to the next
section that includes variation.

<pre class="verbatim">
<span class="red">body common control
</span>   {
<span class="red">   bundlesequence  </span>=> { "central" };
   }


<span class="comment">############################################
</span>

<span class="red">bundle agent</span> <span class="blue">central</span>

{
<span class="red">vars:
</span>
  "policy_server"<span class="red"> string </span>=><span class="green"> "myhost.domain.tld";</span>

  "mypackages"<span class="red"> slist </span>=> { 
                        "nagios"
                        "gcc",
                        "apache2", 
                        "php5" 
                        };

<span class="red">files:
</span>
<span class="comment">  # Password management can be very simple if all hosts are identical
</span>

  "/etc/passwd" 

<span class="red">    comment   </span>=><span class="green"> "Distribute a password file",</span>
<span class="red">    perms     </span>=><span class="blue"> mog("644","root","root"),</span>
<span class="red">    copy_from </span>=><span class="blue"> secure_cp("/home/mark/LapTop/words/RoadAhead","$(policy_server)");</span>

<span class="red">packages:
</span>
  "$(mypackages)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> generic;</span>


<span class="comment"># Add more promises below ...
</span>
     
}


<span class="comment">#########################################################
</span>
<span class="comment"># Server config
</span>
<span class="comment">#########################################################
</span>

<span class="red">body server</span> <span class="blue">control</span>

{
<span class="red">allowconnects         </span>=> { "127.0.0.1" , "::1", "10.20.30" };
<span class="red">allowallconnects      </span>=> { "127.0.0.1" , "::1", "10.20.30" };
<span class="red">trustkeysfrom         </span>=> { "127.0.0.1" , "::1", "10.20.30" };
<span class="comment"># allowusers
</span>
}

<span class="comment">#########################################################
</span>

<span class="red">bundle server</span> <span class="blue">access_rules()</span>

{
<span class="red">access:
</span>
<span class="comment"> # myhost.domain.tld makes this file available to 10.20.30*
</span>

 myhost_domain_tld::  

  "/etc/passwd"

<span class="red">     admit   </span>=> { "127.0.0.1", "10.20.30" };
}

</pre>

<!--  -->
<div class="node">
<a name="Variation-in-hosts"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Updating-from-a-central-hub">Updating from a central hub</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#All-hosts-the-same">All hosts the same</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.3 Variation in hosts</h3>

<pre class="verbatim">
<span class="red">body common control
</span>   {
<span class="red">   bundlesequence  </span>=> { "central" };
   }


<span class="comment">############################################
</span>

<span class="red">bundle agent</span> <span class="blue">central</span>

{
<span class="red">classes:
</span>
  "mygroup_1"<span class="red"> or </span>=> { "myhost", "host1", "host2", "host3" };
  "mygroup_2"<span class="red"> or </span>=> { "host4", "host5", "host6" };

<span class="red">vars:
</span>
  "policy_server"<span class="red"> string </span>=><span class="green"> "myhost.domain.tld";</span>

 mygroup_1::

  "mypackages"<span class="red"> slist </span>=> { 
                        "nagios"
                        "gcc",
                        "apache2", 
                        "php5" 
                        };

 mygroup_2::

  "mypackages"<span class="red"> slist </span>=> { 
                        "apache"
                        "mysql",
                        "php5" 
                        };


<span class="red">files:
</span>
<span class="comment">  # Password management can be very simple if all hosts are identical
</span>

  "/etc/passwd" 

<span class="red">    comment   </span>=><span class="green"> "Distribute a password file",</span>
<span class="red">    perms     </span>=><span class="blue"> mog("644","root","root"),</span>
<span class="red">    copy_from </span>=><span class="blue"> secure_cp("/etc/passwd","$(policy_server)");</span>

<span class="red">packages:
</span>
  "$(mypackages)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> generic;</span>


<span class="comment"># Add more promises below ...
</span>
     
}


<span class="comment">#########################################################
</span>
<span class="comment"># Server config
</span>
<span class="comment">#########################################################
</span>

<span class="red">body server</span> <span class="blue">control</span>

{
<span class="red">allowconnects         </span>=> { "127.0.0.1" , "::1", "10.20.30" };
<span class="red">allowallconnects      </span>=> { "127.0.0.1" , "::1", "10.20.30" };
<span class="red">trustkeysfrom         </span>=> { "127.0.0.1" , "::1", "10.20.30" };
<span class="comment"># allowusers
</span>
}

<span class="comment">#########################################################
</span>

<span class="red">bundle server</span> <span class="blue">access_rules()</span>

{
<span class="red">access:
</span>
<span class="comment"> # myhost.domain.tld makes this file available to 10.20.30*
</span>

 myhost_domain_tld::  

  "/etc/passwd"

<span class="red">     admit   </span>=> { "127.0.0.1", "10.20.30" };
}

</pre>

<!--  -->
<div class="node">
<a name="Updating-from-a-central-hub"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Change-detection">Change detection</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Variation-in-hosts">Variation in hosts</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.4 Updating from a central hub</h3>

<p>The configuration bundled with the CFEngine source code contains an
example of centralized updating of policy that covers more subtleties
than this example, and handles fault tolerance.  Here is the main idea
behind it. For simplicity, we assume that all hosts are on network
10.20.30.* and that the central policy server/hub is 10.20.30.123.

<pre class="verbatim">
<span class="red">bundle agent</span> <span class="blue">update</span>
{
<span class="red">vars:
</span>
 "master_location"<span class="red"> string </span>=><span class="green"> "/var/cfengine/masterfiles";</span>

 "policy_server"<span class="red">   string </span>=><span class="green"> "10.20.30.123";</span>
<span class="red">                   comment </span>=><span class="green"> "IP address to locate your policy host.";</span>

<span class="red">files:
</span>
  "$(sys.workdir)/inputs" 

<span class="red">    perms </span>=><span class="blue"> system("600"),</span>
<span class="red">    copy_from </span>=> remote_cp("$(master_location)",$(policy_server)),
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>

  "$(sys.workdir)/bin" 

<span class="red">    perms </span>=><span class="blue"> system("700"),</span>
<span class="red">    copy_from </span>=><span class="blue"> remote_cp("/usr/local/sbin","localhost"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>
}

<span class="comment">#######################################################
</span>

<span class="red">body server</span> <span class="blue">control</span>

{
<span class="red">allowconnects         </span>=> { "127.0.0.1" , "10.20.30" };
<span class="red">allowallconnects      </span>=> { "127.0.0.1" , "10.20.30" };
<span class="red">trustkeysfrom         </span>=> { "127.0.0.1" , "10.20.30" };
}

<span class="comment">#######################################################
</span>

<span class="red">bundle server</span> <span class="blue">access_rules()</span>
{
<span class="red">access:
</span>
 10_20_30_123::

  "/var/cfengine/masterfiles"

<span class="red">    admit   </span>=> { "127.0.0.1", "10.20.30" };
}


</pre>

<!--  -->
<div class="node">
<a name="Change-detection"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Garbage-collection">Garbage collection</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Updating-from-a-central-hub">Updating from a central hub</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.5 Change detection</h3>

<pre class="verbatim">
<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };

<span class="red">inputs </span>=> { "cfengine_stdlib.cf" };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/usr" 

<span class="red">       changes      </span>=><span class="blue"> detect_all_change,</span>
<span class="red">       depth_search </span>=><span class="blue"> recurse("inf"),</span>
<span class="red">       action       </span>=><span class="blue"> background;</span>
}

</pre>

<!--  -->
<div class="node">
<a name="Garbage-collection"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Distribute-root-passwords">Distribute root passwords</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Change-detection">Change detection</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.6 Garbage collection</h3>

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "garbage_collection" };
<span class="red">inputs </span>=> { "cfengine_stdlib.cf" };
}


<span class="red">bundle agent</span> <span class="blue">garbage_collection</span>
{
<span class="red">files:
</span>
 Sunday::

  "$(sys.workdir)/nova_repair.log" 

<span class="red">    comment </span>=><span class="green"> "Rotate the promises repaired logs each week",</span>
<span class="red">    rename </span>=><span class="blue"> rotate("7"),</span>
<span class="red">    action </span>=><span class="blue"> if_elapsed("10000");</span>

  "$(sys.workdir)/nova_notkept.log" 

<span class="red">    comment </span>=><span class="green"> "Rotate the promises not kept logs each week",</span>
<span class="red">    rename </span>=><span class="blue"> rotate("7"),</span>
<span class="red">    action </span>=><span class="blue"> if_elapsed("10000");</span>

  "$(sys.workdir)/promise.log" 

<span class="red">    comment </span>=><span class="green"> "Rotate the promises not kept logs each week",</span>
<span class="red">    rename </span>=><span class="blue"> rotate("7"),</span>
<span class="red">    action </span>=><span class="blue"> if_elapsed("10000");</span>

 any::

  "$(sys.workdir)/outputs" 

<span class="red">    comment </span>=><span class="green"> "Garbage collection of any output files",</span>
<span class="red">    delete </span>=><span class="blue"> tidy,</span>
<span class="red">    file_select </span>=><span class="blue"> days_old("3"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>

  "$(sys.workdir)/" 

<span class="red">    comment </span>=><span class="green"> "Garbage collection of any output files",</span>
<span class="red">    delete </span>=><span class="blue"> tidy,</span>
<span class="red">    file_select </span>=><span class="blue"> days_old("14"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>

<span class="comment">  # Other resources
</span>

  "/tmp" 

<span class="red">    comment </span>=><span class="green"> "Garbage collection of any temporary files",</span>
<span class="red">    delete </span>=><span class="blue"> tidy,</span>
<span class="red">    file_select </span>=><span class="blue"> days_old("3"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>
  
  "/var/log/apache2/.*bz" 

<span class="red">    comment </span>=><span class="green"> "Garbage collection of rotated log files",</span>
<span class="red">    delete </span>=><span class="blue"> tidy,</span>
<span class="red">    file_select </span>=><span class="blue"> days_old("30"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>

  "/var/log/apache2/.*gz" 

<span class="red">    comment </span>=><span class="green"> "Garbage collection of rotated log files",</span>
<span class="red">    delete </span>=><span class="blue"> tidy,</span>
<span class="red">    file_select </span>=><span class="blue"> days_old("30"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>

  "/var/log/zypper.log"

<span class="red">    comment </span>=><span class="green"> "Prevent the zypper log from choking the disk",</span>
<span class="red">    rename </span>=><span class="blue"> rotate("0"),</span>
<span class="red">    action </span>=><span class="blue"> if_elapsed("10000");</span>

}


</pre>

<!--  -->
<div class="node">
<a name="Distribute-root-passwords"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Distribute-ssh-keys">Distribute ssh keys</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Garbage-collection">Garbage collection</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.7 Distribute root passwords</h3>

<pre class="verbatim">######################################################################
<span class="comment">#
</span>
<span class="comment"># Root password distribution
</span>
<span class="comment"># 
</span>
<span class="comment">######################################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "SetRootPassword" };
}

<span class="comment">########################################################
</span>

<span class="red">bundle common g
</span>{
<span class="red">vars:
</span>
  "secret_keys_dir"<span class="red"> string </span>=><span class="green"> "/tmp";</span>
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">SetRootPassword</span>

{
<span class="red">files:
</span>
  "/var/cfengine/ppkeys/rootpw.txt"

<span class="red">      copy_from </span>=><span class="blue"> scp("$(sys.fqhost)-root.txt","master_host.example.org");</span>

<span class="comment">      # or $(pw_class)-root.txt
</span>

<span class="comment">  # Or get variables directly from server woth Nova
</span>

 "remote-passwd"<span class="red"> string </span>=> remotescalar("rem_password","127.0.0.1","yes");

<span class="comment">  # Test this on a copy
</span>

  "/tmp/shadow"

<span class="red">       edit_line </span>=><span class="blue"> SetRootPw;</span>

}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">SetRootPw</span>
  {
<span class="red">  vars:
</span>
<span class="comment">   # Assume this file contains a single string of the form root:passwdhash:
</span>
<span class="comment">   # with : delimiters to avoid end of line/file problems
</span>

   "pw"<span class="red"> int </span>=> readstringarray("rpw","$(sys.workdir)/ppkeys/rootpw.txt",
<span class="red">                                                    "#[^\n]*",":","1","200");
</span>
<span class="red">  field_edits:
</span>
<span class="red">   "root:.*"
</span>
<span class="comment">      # Set field of the file to parameter
</span>

<span class="red">      edit_field </span>=><span class="blue"> col(":","2","$(rpw[1])","set");</span>
  }

<span class="comment">########################################################
</span>

<span class="red">bundle server</span> <span class="blue">passwords</span>
{
<span class="red">vars:
</span>
<span class="comment">  # Read a file of format
</span>
<span class="comment">  #
</span>
<span class="comment">  # classname: host1,host2,host4,IP-address,regex.*,etc
</span>
<span class="comment">  #
</span>

       "pw_classes"<span class="red"> int </span>=> readstringarray("acl","$(g.secret_keys_dir)/classes.txt",
<span class="red">                                                       "#[^\n]*",":","100","4000");  
</span>  "each_pw_class"<span class="red"> slist </span>=> getindices("acl");
 
<span class="red">access:
</span>
  "/secret/keys/$(each_pw_class)-root.txt"

<span class="red">        admit   </span>=> splitstring("$(acl[$(each_pw_class)][1])" , ":" , "100"),
<span class="red">    ifencrypted </span>=><span class="green"> "true";</span>

}

</pre>

<!--  -->
<div class="node">
<a name="Distribute-ssh-keys"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Laptop-support-configuration">Laptop support configuration</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Distribute-root-passwords">Distribute root passwords</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.8 Distribute ssh keys</h3>

<pre class="verbatim"># Assume that we have collected all users' public keys into a single source area
<span class="comment"># on the server. First copy the ones we need to localhost, and then edit them into
</span>
<span class="comment"># the the user's local keyring.
</span>

<span class="comment">  # vars:
</span>
<span class="comment">  #
</span>
<span class="comment">  #  "users" slist => { "user1", "user2", ...};
</span>
<span class="comment">  #
</span>
<span class="comment">  # methods:
</span>
<span class="comment">  #
</span>
<span class="comment">  #  "any" usebundle => allow_ssh_login_from_authorized_keys(@(users),"sourcehost");
</span>
<span class="comment">  #
</span>

<span class="comment">########################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">allow_ssh_rootlogin_from_authorized_keys(user,sourcehost)</span>
{
<span class="red">vars:
</span>
  "local_cache"<span class="red">       string </span>=><span class="green"> "/var/cfengine/ssh_cache"; </span>
  "authorized_source"<span class="red"> string </span>=><span class="green"> "/master/CFEngine/ssh_keys";</span>

<span class="red">files:
</span>
   "$(local_cache)/$(user).pub"

<span class="red">         comment </span>=><span class="green"> "Copy public keys from a an authorized cache into a cache on localhost",</span>
<span class="red">           perms </span>=><span class="blue"> mo("600","root"),</span>
<span class="red">       copy_from </span>=><span class="blue"> remote_cp("$(authorized_source)/$(user).pub","$(sourcehost)"),</span>
<span class="red">          action </span>=><span class="blue"> if_elapsed("60");</span>

   "/root/.ssh/authorized_keys" 

<span class="red">         comment </span>=><span class="green"> "Edit the authorized keys into the user's personal keyring",</span>
<span class="red">       edit_line </span>=><span class="blue"> insert_file_if_no_line_matching("$(user)","$(local_cache)/$(user).pub"),</span>
<span class="red">          action </span>=><span class="blue"> if_elapsed("60");</span>
}

<span class="comment">########################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">allow_ssh_login_from_authorized_keys(user,sourcehost)</span>
{
<span class="red">vars:
</span>
  "local_cache"<span class="red">       string </span>=><span class="green"> "/var/cfengine/ssh_cache"; </span>
  "authorized_source"<span class="red"> string </span>=><span class="green"> "/master/CFEngine/ssh_keys";</span>

<span class="red">files:
</span>
   "$(local_cache)/$(user).pub"

<span class="red">         comment </span>=><span class="green"> "Copy public keys from a an authorized cache into a cache on localhost",</span>
<span class="red">           perms </span>=><span class="blue"> mo("600","root"),</span>
<span class="red">       copy_from </span>=><span class="blue"> remote_cp("$(authorized_source)/$(user).pub","$(sourcehost)"),</span>
<span class="red">          action </span>=><span class="blue"> if_elapsed("60");</span>

   "/home/$(user)/.ssh/authorized_keys" 

<span class="red">         comment </span>=><span class="green"> "Edit the authorized keys into the user's personal keyring",</span>
<span class="red">       edit_line </span>=><span class="blue"> insert_file_if_no_line_matching("$(user)","$(local_cache)/$(user).pub"),</span>
<span class="red">          action </span>=><span class="blue"> if_elapsed("60");</span>
}

<span class="comment">########################################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">insert_file_if_no_line_matching(user,file)</span>
{
<span class="red">classes:
</span>
  "have_user"<span class="red"> expression </span>=> regline("$(user).*","$(this.promiser)");

<span class="red">insert_lines:
</span>
  !have_user::

    "$(file)" 
<span class="red">         insert_type </span>=><span class="green"> "file";</span>
}

</pre>

<!--  -->
<div class="node">
<a name="Laptop-support-configuration"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Find-MAC-address">Find MAC address</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Distribute-ssh-keys">Distribute ssh keys</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.9 Laptop support configuration</h3>

<p>Laptops do not need a lot of confguration support. IP addresses are
set by DHCP and conditions are changeable. But you want to set your
DNS search domains to familiar settings in spite of local DHCP
configuration, and another useful trick is to keep a regular backup of
disk changes on the local disk. This won't help against disk
destruction, but it is a huge advantage when your user accidentally
deletes files while travelling or offline.

<pre class="verbatim">#######################################################
<span class="comment">#
</span>
<span class="comment"># Laptop
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { 
                   "update",
                   "garbage_collection",
                   "main",
                   "backup",
                   };

<span class="red">inputs          </span>=> {
                   "update.cf",
                   "site.cf",
                   "library.cf" 
                   };
}

<span class="comment">#######################################################
</span>

<span class="red">body agent</span> <span class="blue">control</span>
{
<span class="comment"># if default runtime is 5 mins we need this for long jobs
</span>
<span class="red">ifelapsed </span>=><span class="green"> "15";</span>
}

<span class="comment">#######################################################
</span>

<span class="red">body monitor</span> <span class="blue">control</span>
{
<span class="red">forgetrate </span>=><span class="green"> "0.7";</span>
}

<span class="comment">#######################################################
</span>

<span class="red">body executor</span> <span class="blue">control</span>

{
<span class="red">splaytime </span>=><span class="green"> "1";</span>
<span class="red">mailto </span>=><span class="green"> "mark@iu.hio.no";</span>
<span class="red">smtpserver </span>=><span class="green"> "localhost";</span>
<span class="red">mailmaxlines </span>=><span class="green"> "30";</span>

<span class="comment"># Instead of a separate update script, now do this
</span>

<span class="red">exec_command </span>=><span class="green"> "$(sys.workdir)/bin/cf-agent -f failsafe.cf &amp;&amp; $(sys.workdir)/bin/cf-agent";</span>
}

<span class="comment">#######################################################
</span>
<span class="comment"># General site issues can be in bundles like this one
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">main</span>

{
<span class="red">vars:
</span>
  "component"<span class="red"> slist </span>=> { "cf-monitord", "cf-serverd" };

<span class="comment"> # - - - - - - - - - - - - - - - - - - - - - - - -
</span>

<span class="red">files:
</span>
  "$(sys.resolv)"  # test on "/tmp/resolv.conf" #

<span class="red">     create        </span>=><span class="green"> "true",</span>
<span class="red">     edit_line     </span>=><span class="blue"> resolver,</span>
<span class="red">     edit_defaults </span>=><span class="blue"> def;</span>

<span class="red">processes:
</span>
  "$(component)"<span class="red"> restart_class </span>=> canonify("start_$(component)");

<span class="comment"> # - - - - - - - - - - - - - - - - - - - - - - - -
</span>

<span class="red">commands:
</span>
   "$(sys.workdir)/bin/$(component)"

<span class="red">       ifvarclass </span>=> canonify("start_$(component)");
}

<span class="comment">#######################################################
</span>
<span class="comment"># Backup
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">backup</span>
{
<span class="red">files:
</span>
  "/home/backup"

<span class="red">     copy_from </span>=><span class="blue"> cp("/home/mark"),</span>
<span class="red">  depth_search </span>=><span class="blue"> recurse("inf"),</span>
<span class="red">   file_select </span>=><span class="blue"> exclude_files,</span>
<span class="red">        action </span>=> longjob;

}

<span class="comment">#######################################################
</span>
<span class="comment"># Garbage collection issues
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">garbage_collection</span>
{
<span class="red">files:
</span>
  "$(sys.workdir)/outputs" 

<span class="red">    delete </span>=><span class="blue"> tidy,</span>
<span class="red">    file_select </span>=><span class="blue"> days_old("3"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>


}

</pre>

<!--  -->
<div class="node">
<a name="Find-MAC-address"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Log-rotation">Log rotation</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Laptop-support-configuration">Laptop support configuration</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.10 Find the MAC address</h3>

<p>Finding the ethernet address can be hard, but on Linux it is straightforward.

<pre class="verbatim">bundle agent test
{
<span class="red">vars:
</span>
linux::
 "interface"<span class="red"> string </span>=> execresult("/sbin/ifconfig eth0","noshell");

solaris::
 "interface"<span class="red"> string </span>=> execresult("/usr/sbin/ifconfig bge0","noshell");

freebsd::
 "interface"<span class="red"> string </span>=> execresult("/sbin/ifconfig le0","noshell");

darwin::
 "interface"<span class="red"> string </span>=> execresult("/sbin/ifconfig en0","noshell");

<span class="red">classes:
</span>
 linux::

   "ok"<span class="red"> expression </span>=> regextract(
                                ".*HWaddr ([^\s]+).*(\n.*)*",
                                "$(interface)",
                                "mac"
                                );

 solaris::

   "ok"<span class="red"> expression </span>=> regextract(
                                ".*ether ([^\s]+).*(\n.*)*",
                                "$(interface)",
                                "mac"
                                );

 freebsd::

   "ok"<span class="red"> expression </span>=> regextract(
                                ".*ether ([^\s]+).*(\n.*)*",
                                "$(interface)",
                                "mac"
                                );

 darwin::

   "ok"<span class="red"> expression </span>=> regextract(
                                "(?s).*ether ([^\s]+).*(\n.*)*",
                                "$(interface)",
                                "mac"
                                );

<span class="red">reports:
</span>
ok::

  "MAC address is $(mac[1])";

}

</pre>

<!--  -->
<div class="node">
<a name="Log-rotation"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Manage-a-system-file">Manage a system file</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Find-MAC-address">Find MAC address</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.11 Log rotation</h3>

<pre class="verbatim">
<span class="red">body common control
</span>   {
<span class="red">   bundlesequence  </span>=> { "testbundle" };
   }


<span class="comment">############################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/home/mark/tmp/rotateme"

<span class="red">      rename </span>=><span class="blue"> rotate("4");</span>
}

<span class="comment">############################################
</span>

<span class="red">body rename</span> <span class="blue">rotate(level)</span>

{
<span class="red">rotate </span>=><span class="green"> "$(level)";</span>
}

</pre>

<!--  -->
<div class="node">
<a name="Manage-a-system-file"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Simple-template">Simple template</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Log-rotation">Log rotation</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.12 Manage a system file</h3>

<ul class="menu">
<li><a accesskey="1" href="#Simple-template">Simple template</a>
<li><a accesskey="2" href="#Simple-versioned-template">Simple versioned template</a>
<li><a accesskey="3" href="#Macro-template">Macro template</a>
<li><a accesskey="4" href="#Custom-editing">Custom editing</a>
</ul>

<div class="node">
<a name="Simple-template"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Simple-versioned-template">Simple versioned template</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Manage-a-system-file">Manage a system file</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.13 Simple template</h3>

<pre class="verbatim">bundle agent hand_edited_config_file
{
<span class="red">vars:
</span>
  "file_template"<span class="red"> string </span>=><span class="blue"></span>

"
<span class="comment"># Syntax:
</span>
<span class="comment">#
</span>
<span class="comment"># IP-Address  Full-Qualified-Hostname  Short-Hostname
</span>
<span class="comment">#
</span>

127.0.0.1       localhost
::1             localhost ipv6-localhost ipv6-loopback
fe00::0         ipv6-localnet
ff00::0         ipv6-mcastprefix
ff02::1         ipv6-allnodes
ff02::2         ipv6-allrouters
ff02::3         ipv6-allhosts
10.0.0.100      host1.domain.tld host1
10.0.0.101      host2.domain.tld host2
10.0.0.20       host3.domain.tld host3
10.0.0.21       host4.domain.tld host4
";

<span class="comment">##############################################################
</span>

<span class="red">files:
</span>
   "/etc/hosts"

<span class="red">       comment </span>=><span class="green"> "Define the content of all host files from this master source",</span>
<span class="red">        create </span>=><span class="green"> "true",</span>
<span class="red">     edit_line </span>=><span class="blue"> append_if_no_lines("$(file_template)"),</span>
<span class="red"> edit_defaults </span>=><span class="blue"> empty,</span>
<span class="red">         perms </span>=><span class="blue"> mo("$(mode)","root"),</span>
<span class="red">        action </span>=><span class="blue"> if_elapsed("60");</span>
}

</pre>

<div class="node">
<a name="Simple-versioned-template"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Macro-template">Macro template</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Simple-template">Simple template</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.14 Simple versioned template</h3>

<p>The simplest approach to managing a file is to maintain a master copy by hand, keeping it
in a version controlled repository (e.g. svn), and installing this version on the end machine.

   <p>We'll assume that you have a version control repository that is located on some independent server, and has been
checked out manually once (with authentication) in <samp><span class="file">/mysite/masterfiles</span></samp>.

<pre class="verbatim">bundle agent hand_edited_config_file
{
<span class="red">vars:
</span>
  "masterfiles"<span class="red">   string </span>=><span class="green"> "/mysite/masterfiles";</span>
  "policy_server"<span class="red"> string </span>=><span class="green"> "policy_host.domain.tld";</span>

<span class="red">files:
</span>
   "/etc/hosts"

<span class="red">        comment </span>=><span class="green"> "Synchronize hosts with a hand-edited template in svn",</span>
<span class="red">          perms </span>=><span class="blue"> m("644"),</span>
<span class="red">      copy_from </span>=><span class="blue"> remote_cp("$(masterfiles)/trunk/hosts_master","$(policy_server)");</span>

<span class="red">commands:
</span>

   "/usr/bin/svn update" 

<span class="red">        comment </span>=><span class="green"> "Update the company document repository including manuals to a local copy",</span>
<span class="red">        contain </span>=><span class="blue"> silent_in_dir("$(masterfiles)/trunk"),</span>
<span class="red">     ifvarclass </span>=> canonify("$(policy_server)");

}

</pre>

<div class="node">
<a name="Macro-template"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Custom-editing">Custom editing</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Simple-versioned-template">Simple versioned template</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.15 Macro template</h3>

<p>The next simplest approach to file management is to add variables to
the template that will be expanded into local values at the end
system, e.g. using variables like &lsquo;<samp><span class="samp">$(sys.host)</span></samp>&rsquo; for the name of
the host within the body of the versioned template.

<pre class="verbatim">bundle agent hand_edited_template
{
<span class="red">vars:
</span>
  "masterfiles"<span class="red">   string </span>=><span class="green"> "/mysite/masterfiles";</span>
  "policy_server"<span class="red"> string </span>=><span class="green"> "policy_host.domain.tld";</span>

<span class="red">files:
</span>
   "/etc/hosts"

<span class="red">        comment </span>=><span class="green"> "Synchronize hosts with a hand-edited template in svn",</span>
<span class="red">          perms </span>=><span class="blue"> m("644"),</span>
<span class="red">        create </span>=><span class="green"> "true",</span>
<span class="red">     edit_line </span>=><span class="blue"> expand_template("$(masterfiles)/trunk/hosts_master"),</span>
<span class="red"> edit_defaults </span>=><span class="blue"> empty,</span>
<span class="red">        action </span>=><span class="blue"> if_elapsed("60");</span>

<span class="red">commands:
</span>

   "/usr/bin/svn update" 

<span class="red">        comment </span>=><span class="green"> "Update the company document repository including manuals to a local copy",</span>
<span class="red">        contain </span>=><span class="blue"> silent_in_dir("$(masterfiles)/trunk"),</span>
<span class="red">     ifvarclass </span>=> canonify("$(policy_server)");

}

</pre>

<p class="noindent">The macro template file may contain variables, as below,
that get expanded by CFEngine.

<pre class="smallexample">     # Syntax:
     #
     # IP-Address  Full-Qualified-Hostname  Short-Hostname
     #
     
     127.0.0.1       localhost $(sys.host)
     ::1             localhost ipv6-localhost ipv6-loopback
     fe00::0         ipv6-localnet
     ff00::0         ipv6-mcastprefix
     ff02::1         ipv6-allnodes
     ff02::2         ipv6-allrouters
     ff02::3         ipv6-allhosts
     10.0.0.100      host1.domain.tld host1
     10.0.0.101      host2.domain.tld host2
     10.0.0.20       host3.domain.tld host3
     10.0.0.21       host4.domain.tld host4
     
     # Add below this line
     
     $(definitions.more_hosts)
</pre>
   <div class="node">
<a name="Custom-editing"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Manage-a-system-process">Manage a system process</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Macro-template">Macro template</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.16 Custom editing</h3>

<p>If you do not control the starting state of the file, because it is distributed by
an operating system vendor for instance, then editing the final state is the best approach. 
That way, you will get changes that are made by the vendor, and will ensure your own
modifications are kept even when updates arrive.

<pre class="verbatim">bundle agent modifying_managed_file
{
<span class="red">vars:
</span>
  "data"<span class="red">   slist </span>=> { "10.1.2.3 sirius", "10.1.2.4 ursa-minor", "10.1.2.5 orion"};

<span class="red">files:
</span>
   "/etc/hosts"

<span class="red">        comment </span>=><span class="green"> "Append a list of lines to the end of a file if they don't exist",</span>
<span class="red">          perms </span>=><span class="blue"> m("644"),</span>
<span class="red">        create </span>=><span class="green"> "true",</span>
<span class="red">     edit_line </span>=><span class="blue"> append_if_no_lines("modifying_managed_file.data"),</span>
<span class="red">        action </span>=><span class="blue"> if_elapsed("60");</span>


}

</pre>

   <p>Another example shows how to set the values of variables
using a data-driven approach and methods from the
standard library.
<pre class="verbatim">#######################################################
<span class="comment">#
</span>
<span class="comment"># Edit variable = value in a text file
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testsetvar" };   
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testsetvar</span>

{
<span class="red">vars:
</span>
  "v[variable_1]"<span class="red"> string </span>=><span class="green"> "value_1";</span>
  "v[variable_2]"<span class="red"> string </span>=><span class="green"> "value_2";</span>

<span class="red">files:
</span>
  "/tmp/test_setvar"

<span class="red">     edit_line </span>=><span class="blue"> set_variable_values("testsetvar.v");</span>
}

</pre>

<!--  -->
<div class="node">
<a name="Manage-a-system-process"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Ensure-running">Ensure running</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Custom-editing">Custom editing</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.17 Manage a system process</h3>

<ul class="menu">
<li><a accesskey="1" href="#Ensure-running">Ensure running</a>
<li><a accesskey="2" href="#Ensure-not-running">Ensure not running</a>
<li><a accesskey="3" href="#Prune-processes">Prune processes</a>
</ul>

<div class="node">
<a name="Ensure-running"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Ensure-not-running">Ensure not running</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Manage-a-system-process">Manage a system process</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.18 Ensure running</h3>

<p>The simplest example might look like this:

<pre class="verbatim">
<span class="red">bundle agent</span> <span class="blue">restart_process</span>
{
<span class="red">processes:
</span>
  "httpd" 

<span class="red">      comment </span>=><span class="green"> "Make sure apache web server is running",</span>
<span class="red">      restart_class </span>=><span class="green"> "restart_httpd";</span>

<span class="red">commands:
</span>
 restart_httpd::

     "/etc/init.d/apache2 restart";

}

</pre>

   <p>This example shows how the CFEngine components could be started using a pattern.
<pre class="verbatim">
<span class="red">bundle agent</span> <span class="blue">CFEngine_processes</span>
{
<span class="red">vars:
</span>
  "components"<span class="red"> slist </span>=> { "cf-execd", "cf-monitord", "cf-serverd", "cf-hub" };

<span class="red">processes:
</span>
  "$(components)" 

<span class="red">      comment </span>=><span class="green"> "Make sure server parts of CFEngine are running",</span>
<span class="red">      restart_class </span>=> canonify("start_$(component)");

<span class="red">commands:
</span>
   "$(sys.workdir)/bin/$(component)"

<span class="red">          comment </span>=><span class="green"> "Make sure server parts of CFEngine are running",</span>
<span class="red">       ifvarclass </span>=> canonify("start_$(components)");

}

</pre>

<div class="node">
<a name="Ensure-not-running"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Prune-processes">Prune processes</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Ensure-running">Ensure running</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.19 Ensure not running</h3>

<pre class="verbatim">
<span class="red">bundle agent</span> <span class="blue">restart_process</span>
{
<span class="red">vars:
</span>
  "killprocs"<span class="red"> slist </span>=> { "snmpd", "gameserverd", "irc", "crack" };

<span class="red">processes:
</span>
  "$(killprocs)" 

<span class="red">      comment </span>=><span class="green"> "Make processes are not running",</span>
<span class="red">      signals </span>=> { "term", "kill" };
;
}

</pre>

<div class="node">
<a name="Prune-processes"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Manage-users">Manage users</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Ensure-not-running">Ensure not running</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.20 Prune processes</h3>

<p>This example kills processes owned by a particular user that have exceeded 100000 bytes of
resident memory.

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">processes:
</span>
 ".*"

<span class="red">    process_select  </span>=><span class="blue"> big_processes("mark"),</span>
<span class="red">            signals </span>=> { "term" };
}

<span class="comment">########################################################
</span>

<span class="red">body process_select</span> <span class="blue">big_processes(o)</span>

{
<span class="red">process_owner </span>=> { "$(o)" };
<span class="red">rsize </span>=> irange("100000","900000");
<span class="red">process_result </span>=><span class="green"> "rsize.process_owner";</span>
}

</pre>

<!--  -->
<div class="node">
<a name="Manage-users"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Add-users">Add users</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Prune-processes">Prune processes</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.21 Manage users</h3>

<p>There are many approaches to managing users. You can edit system files like <samp><span class="file">/etc/passwd</span></samp>
directly, or you can use commands on some systems like &lsquo;<samp><span class="samp">useradd</span></samp>&rsquo; or &lsquo;<samp><span class="samp">adduser</span></samp>&rsquo;. 
In all cases it is desirable to make this a data-driven process.

<ul class="menu">
<li><a accesskey="1" href="#Add-users">Add users</a>
<li><a accesskey="2" href="#Remove-users">Remove users</a>
</ul>

<div class="node">
<a name="Add-users"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Remove-users">Remove users</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Manage-users">Manage users</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.22 Add users</h3>

<p>A simple approach which adds new users to the password file, and to a
group called &lsquo;<samp><span class="samp">users</span></samp>&rsquo; in the group file. Is shown below. This example
does not edit the shadow file. A simple pattern that can be modified for
use is shown below.

   <p>Note that, although this is a simple minded approach, it is the most efficient
of the approaches shown here as all operations can be carried out in a single
operation for each file.
<pre class="verbatim">bundle agent addusers
{
<span class="red">vars:
</span>
<span class="comment">  # Add some users
</span>

  "pw[mark]"<span class="red"> string </span>=><span class="green"> "mark:x:1000:100:Mark Burgess:/home/mark:/bin/bash";</span>
  "pw[fred]"<span class="red"> string </span>=><span class="green"> "fred:x:1001:100:Right Said:/home/fred:/bin/bash";</span>
  "pw[jane]"<span class="red"> string </span>=><span class="green"> "jane:x:1002:100:Jane Doe:/home/jane:/bin/bash";</span>

  "users"<span class="red"> slist </span>=> getindices("pw");

<span class="red">files:
</span>
  "/etc/passwd"
<span class="red">     edit_line </span>=><span class="blue"> append_users_starting("addusers.pw");</span>

<span class="comment">#  "/etc/shadow"
</span>
<span class="comment">#     edit_line => append_users_starting("$(users):defaultpasswd:::::::");
</span>

  "/etc/group"
<span class="red">       edit_line </span>=><span class="blue"> append_user_field("users","4","@(addusers.users)");</span>

  "/home/$(users)/."

<span class="red">     create </span>=><span class="green"> "true",</span>
<span class="red">      perms </span>=><span class="blue"> mog("755","$(users)","users");</span>
}

</pre>

   <p>A second approach is to use the shell commands supplied by some operating systems;
this assumes that suitable defaults have been set up manually. Also the result
is not repairable in a simple convergent manner. The command needs to edit multiple
files for each user, and is quite inefficient.

<pre class="verbatim">bundle agent addusers
{
<span class="red">vars:
</span>
  "users"<span class="red"> slist </span>=> { "mark", "fred", "jane" };

<span class="red">commands:
</span>
   "/usr/sbin/useradd $(users)";
}

</pre>
An alternative approach is to use a method to wrap around the handling of a user. 
Although this looks nice, it is less efficient than the first method because it
must edit the files multiple times.
<pre class="verbatim">bundle agent addusers
{
<span class="red">vars:
</span>
<span class="comment">  # Add some users
</span>

  "pw[mark]"<span class="red"> string </span>=><span class="green"> "mark:x:1000:100:Mark Burgess:/home/mark:/bin/bash";</span>
  "pw[fred]"<span class="red"> string </span>=><span class="green"> "fred:x:1001:100:Right Said:/home/fred:/bin/bash";</span>
  "pw[jane]"<span class="red"> string </span>=><span class="green"> "jane:x:1002:100:Jane Doe:/home/jane:/bin/bash";</span>

  "users"<span class="red"> slist </span>=> getindices("pw");

<span class="red">methods:
</span>
  "any"<span class="red"> usebundle </span>=><span class="blue"> user_add("$(users)","$(pw[$(users)])");</span>

}

<span class="red">bundle agent</span> <span class="blue">user_add(x,pw)</span>
{
<span class="red">files:
</span>
  "/etc/passwd"
<span class="red">     edit_line </span>=><span class="blue"> append_users_starting("addusers.pw");</span>

<span class="comment">#  "/etc/shadow"
</span>
<span class="comment">#     edit_line => append_users_starting("$(users):defaultpasswd:::::::");
</span>

  "/etc/group"
<span class="red">       edit_line </span>=><span class="blue"> append_user_field("users","4","@(addusers.users)");</span>

  "/home/$(users)/."

<span class="red">     create </span>=><span class="green"> "true",</span>
<span class="red">      perms </span>=><span class="blue"> mog("755","$(users)","users");</span>
}

</pre>

<div class="node">
<a name="Remove-users"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Postfix-mail-configuration">Postfix mail configuration</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Add-users">Add users</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.23 Remove users</h3>

<!--  -->
<div class="node">
<a name="Postfix-mail-configuration"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Set-up-HPC-clusters">Set up HPC clusters</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Remove-users">Remove users</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.24 Postfix mail configuration</h3>

<pre class="verbatim">#######################################################
<span class="comment">#
</span>
<span class="comment"># Postfix
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
any::

<span class="red">  bundlesequence  </span>=> {
                     postfix
                     };   
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">postfix</span>

{
<span class="red">vars:
</span>
 "prefix"<span class="red">     string </span>=><span class="green"> "/etc";</span>
 "smtpserver"<span class="red"> string </span>=><span class="green"> "localhost";</span>
 "mailrelay"<span class="red">  string </span>=><span class="green"> "mailx.example.org";</span>

<span class="red">files:
</span>
  "$(prefix)/main.cf"     
<span class="red">      edit_line </span>=><span class="blue"> prefix_postfix;</span>

  "$(prefix)/sasl-passwd" 
<span class="red">      create    </span>=><span class="green"> "true",</span>
<span class="red">      perms     </span>=><span class="blue"> mo("0600","root"),</span>
<span class="red">      edit_line </span>=><span class="blue"> append_if_no_line("$(smtpserver) _$(sys.fqhost):chmsxrcynz4etfrejizhs22");</span>
}

<span class="comment">#######################################################
</span>
<span class="comment"># For the library
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">prefix_postfix</span>

{
<span class="comment">#
</span>
<span class="comment"># Value have the form NAME = "quoted space separated list"
</span>
<span class="comment">#
</span>
<span class="red">vars:
</span>
  "ps[relayhost]"<span class="red">                  string </span>=><span class="green"> "[$(postfix.mailrelay)]:587";</span>
  "ps[mydomain]"<span class="red">                   string </span>=><span class="green"> "iu.hio.no";</span>
  "ps[smtp_sasl_auth_enable]"<span class="red">      string </span>=><span class="green"> "yes";</span>
  "ps[smtp_sasl_password_maps]"<span class="red">    string </span>=><span class="green"> "hash:/etc/postfix/sasl-passwd";</span>
  "ps[smtp_sasl_security_options]"<span class="red"> string </span>=><span class="green"> "";</span>
  "ps[smtp_use_tls]"<span class="red">               string </span>=><span class="green"> "yes";</span>
  "ps[default_privs]"<span class="red">              string </span>=><span class="green"> "mailman";</span>
  "ps[inet_protocols]"<span class="red">             string </span>=><span class="green"> "all";</span>
  "ps[inet_interfaces]"<span class="red">            string </span>=><span class="green"> "127.0.0.1";</span>

  "parameter_name"<span class="red"> slist </span>=> getindices("ps");

<span class="red">delete_lines: 
</span>
  "$(parameter_name).*";

<span class="red">insert_lines:
</span>
  "$(parameter_name) = $(ps[$(parameter_name)])";

}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">AppendIfNSL(parameter)</span>
  {
<span class="red">  insert_lines:
</span>
    "$(parameter)"; # This is default
  }

</pre>

<div class="node">
<a name="Set-up-HPC-clusters"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Set-up-name-resolution">Set up name resolution</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Postfix-mail-configuration">Postfix mail configuration</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.25 Set up HPC clusters</h3>

<p>HPC cluster machines are usually all identical, so the CFEngine
configuration is very simple. HPC clients value CPU and memory
resources, so we can shut down unnecessary services to save CPU. 
We can also change the scheduling rate of CFEngine to run less frequently,
and save a little:

<pre class="verbatim">
<span class="comment">#######################################################
</span>

<span class="red">body executor</span> <span class="blue">control</span>

{
<span class="red">splaytime </span>=><span class="green"> "1";</span>
<span class="red">mailto </span>=><span class="green"> "cfengine@example.com";</span>
<span class="red">smtpserver </span>=><span class="green"> "localhost";</span>
<span class="red">mailmaxlines </span>=><span class="green"> "30";</span>

<span class="comment"># Once per hour, on the hour
</span>

<span class="red">schedule     </span>=> { "Min00_05" };
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">services_disable</span>
{
<span class="red">vars:
</span>
<span class="comment">   # list all of xinetd services (case sensitive)
</span>

   "xinetd_services"<span class="red"> slist </span>=> {
                               "imap",
                               "imaps",
                               "ipop2",
                               "ipop3",
                               "krb5-telnet",
                               "klogin",
                               "kshell",
                               "ktalk",
                               "ntalk",
                               "pop3s",

                              };
<span class="red">methods:
</span>
<span class="comment">   # perform the actual disable all xinetd services according to the list above
</span>

   "any"<span class="red">  usebundle </span>=><span class="blue"> disable_xinetd("$(xinetd_services)");</span>

<span class="red">processes:
</span>
  "$(xinetd_services)"

<span class="red">           signals </span>=> { "kill" };

}

<span class="comment">###############################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">disable_xinetd(name)</span>
{
<span class="red"> vars:
</span>   "status"<span class="red"> string </span>=> execresult("/sbin/chkconfig --list $(name)", "useshell");

<span class="red"> classes:
</span>   "on"<span class="red">  expression </span>=> regcmp(".*on.*","$(status)");
   
<span class="red"> commands:
</span>   on::
      "/sbin/chkconfig $(name) off",
<span class="red">        comment </span>=><span class="green"> "disable $(name) service";</span>

<span class="red"> reports:
</span>   on::
      "disable $(name) service.";
   
}
</pre>

<!--  -->
<div class="node">
<a name="Set-up-name-resolution"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Set-up-sudo">Set up sudo</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Set-up-HPC-clusters">Set up HPC clusters</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.26 Set up name resolution</h3>

<p>There are many ways to do name resolution setup<a rel="footnote" href="#fn-1" name="fnd-1"><sup>1</sup></a> We write a reusable
bundle using the editing features.

   <p>A simple and straightforward approach is to maintain
a separate modular bundle for this task. This avoids
too many levels of abstraction and keeps all the information
in one place. We implement this as a simple editing promise
for the <samp><span class="file">/etc/resolv.conf</span></samp> file.
<pre class="verbatim">
<span class="red">bundle agent</span> <span class="blue">system_files</span>

{
<span class="red">files:
</span>
  "$(sys.resolv)"  # test on "/tmp/resolv.conf" #

<span class="red">     comment       </span>=><span class="green"> "Add lines to the resolver configuration",</span>
<span class="red">     create        </span>=><span class="green"> "true",</span>
<span class="red">     edit_line     </span>=><span class="blue"> resolver,</span>
<span class="red">     edit_defaults </span>=><span class="blue"> std_edits;</span>

<span class="comment">   # ...other system files ...
</span>

}

<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">resolver</span>

{
<span class="red">delete_lines:
</span>
<span class="comment">  # delete any old name servers or junk we no longer need
</span>

  "search.*";
  "nameserver 80.65.58.31";
  "nameserver 80.65.58.32";
  "nameserver 82.103.128.146";
  "nameserver 78.24.145.4";
  "nameserver 78.24.145.5";
  "nameserver 128.39.89.10";

<span class="red">insert_lines:
</span>
  "search mydomain.tld"<span class="red"> location </span>=><span class="blue"> start;</span>

 special_net::

  "nameserver 128.39.89.8";
  "nameserver 128.39.74.66";

 !special_net::

  "nameserver 128.38.34.12";

 any::

  "nameserver 212.112.166.18";
  "nameserver 212.112.166.22";
}

</pre>

   <p>A second approach is to try to conceal the operational details
behind a veil of abstraction.

<pre class="verbatim">
<span class="red">bundle agent</span> <span class="blue">system_files</span>
{
<span class="red">vars:
</span>
 "searchlist"<span class="red">  string </span>=><span class="green"> "iu.hio.no CFEngine.com";</span>

 "nameservers"<span class="red"> slist </span>=> { 
                        "128.39.89.10", 
                        "128.39.74.16",
                        "192.168.1.103"
                        };
<span class="red">files:
</span>
  "$(sys.resolv)"  # test on "/tmp/resolv.conf" #
<span class="red">      create        </span>=><span class="green"> "true",</span>
<span class="red">      edit_line     </span>=><span class="blue"> doresolv("$(s)","@(this.n)"),</span>
<span class="red">      edit_defaults </span>=><span class="blue"> empty;</span>

<span class="comment"> # ....
</span>

}

<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">doresolv(search,names)</span>

{
<span class="red">insert_lines:
</span>  "search $(search)";
  "nameserver $(names)";
}

</pre>

<p class="noindent">DNS is not the only name service, of course. 
Unix has its older <samp><span class="file">/etc/hosts</span></samp> file which can also
be managed using file editing. We simply append this to the
<code>system_files</code> bundle.

<pre class="verbatim">bundle agent system_files
{

<span class="comment"># ...
</span>

<span class="red">files:
</span>
   "/etc/hosts"

<span class="red">     comment </span>=><span class="green"> "Add hosts to the /etc/hosts file",</span>
<span class="red">   edit_line </span>=><span class="blue"> fix_etc_hosts;</span>
}

<span class="comment">###########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">fix_etc_hosts</span>
{
<span class="red">vars:
</span>
 "names[127.0.0.1]"<span class="red">    string </span>=><span class="green"> "localhost localhost.CFEngine.com";</span>
 "names[128.39.89.12]"<span class="red"> string </span>=><span class="green"> "myhost myhost.CFEngine.com";</span>
 "names[128.39.89.13]"<span class="red"> string </span>=><span class="green"> "otherhost otherhost.CFEngine.com";</span>

<span class="comment"> # etc
</span>

 "i"<span class="red"> slist </span>=> getindices("names");

<span class="red">insert_lines:
</span>
 "$(i)     $(names[$(i)])";

}

</pre>

<!--  -->
<div class="node">
<a name="Set-up-sudo"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Set-up-a-web-server">Set up a web server</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Set-up-name-resolution">Set up name resolution</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.27 Set up sudo</h3>

<p>Setting up <code>sudo</code> is straightforward, and is best managed by copying trusted
files from a repository.
<pre class="verbatim">bundle agent system_files
{
<span class="red">vars:
</span>
 "masterfiles"<span class="red"> string </span>=><span class="green"> "/subversion_projects/masterfiles";</span>

<span class="comment"># ...
</span>

<span class="red">files:
</span>
   "/etc/sudoers"

<span class="red">     comment </span>=><span class="green"> "Make sure the sudo configuration is secure and up to date",</span>
<span class="red">       perms </span>=><span class="blue"> mog("440","root","root"),</span>
<span class="red">   copy_from </span>=><span class="blue"> secure_cp("$(masterfiles)/sudoers","$(policy_server)");</span>

}

</pre>

<!--  -->
<div class="node">
<a name="Set-up-a-web-server"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Templating">Templating</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Set-up-sudo">Set up sudo</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.28 Set up a web server</h3>

<p>Adapt this template to your operating system by adding multiple
classes.  Each web server runs something like the present module,
which is entered into the bundlesequence like this:

<pre class="verbatim">#####################################################
<span class="comment">#
</span>
<span class="comment"># Apache webserver module
</span>
<span class="comment"># 
</span>
<span class="comment">#####################################################
</span>

<span class="red">bundle agent</span> <span class="blue">web_server(state)</span>
{
<span class="red">vars:
</span>
  "document_root"<span class="red"> string </span>=><span class="green"> "/";</span>

<span class="comment"> ####################################################
</span>
<span class="comment"> # Site specific configuration - put it in this file
</span>
<span class="comment"> ####################################################
</span>

  "site_http_conf"<span class="red"> string </span>=><span class="green"> "/home/mark/CFEngine-inputs/httpd.conf";</span>

<span class="comment"> ####################################################
</span>
<span class="comment"> # Software base
</span>
<span class="comment"> ####################################################
</span>

  "match_package"<span class="red"> slist </span>=> { 
                           "apache2", 
                           "apache2-mod_php5",
                           "apache2-prefork",
                           "php5" 
                           };

<span class="comment"> #########################################################
</span>

<span class="red">processes:
</span>
  web_ok.on::

   "apache2"
 
<span class="red">     restart_class </span>=><span class="green"> "start_apache";</span>

  off::

   "apache2"

<span class="red">     process_stop </span>=><span class="green"> "/etc/init.d/apache2 stop";</span>


<span class="comment"> #########################################################
</span>

<span class="red">commands:
</span>
 start_apache::

   "/etc/init.d/apache2 start"; # or startssl

<span class="comment"> #########################################################
</span>

<span class="red">packages:
</span>
  "$(match_package)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> zypper,</span>
<span class="red">     classes </span>=><span class="blue"> if_ok("software_ok");</span>

<span class="comment"> #########################################################
</span>

<span class="red">files:
</span>
 software_ok::

  "/etc/sysconfig/apache2" 

<span class="red">     edit_line </span>=><span class="blue"> fixapache,</span>
<span class="red">     classes </span>=><span class="blue"> if_ok("web_ok");</span>

<span class="comment"> #########################################################
</span>

<span class="red">reports:
</span>
 !software_ok.on::

    "The web server software could not be installed";
 
<span class="comment"> #########################################################
</span>

<span class="red">classes:
</span>
  "on"<span class="red">  expression </span>=> strcmp("$(state)","on");
  "off"<span class="red"> expression </span>=> strcmp("$(state)","off");
}

<span class="comment">#######################################################
</span>
<span class="comment"># For the library
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">fixapache</span>

{
<span class="red">vars:
</span>
 "add_modules"<span class="red">     slist </span>=> { 
                            "ssl", 
                            "php5" 
                            };

 "del_modules"<span class="red">     slist </span>=> { 
                            "php3",
                            "php4",
                            "jk"
                            };

<span class="red">insert_lines:
</span>
 "APACHE_CONF_INCLUDE_FILES=\"$(web_server.site_http_conf)\"";

<span class="red">field_edits:
</span>
<span class="comment"> #####################################################################
</span>
<span class="comment"> # APACHE_MODULES="actions alias ssl php5 dav_svn authz_default jk" etc..
</span>
<span class="comment"> #####################################################################
</span>

   "APACHE_MODULES=.*"

<span class="comment">      # Insert module "columns" between the quoted RHS 
</span>
<span class="comment">      # using space separators
</span>

<span class="red">      edit_field </span>=><span class="blue"> quotedvar("$(add_modules)","append");</span>

   "APACHE_MODULES=.*"

<span class="comment">      # Delete module "columns" between the quoted RHS 
</span>
<span class="comment">      # using space separators
</span>

<span class="red">      edit_field </span>=><span class="blue"> quotedvar("$(del_modules)","delete");</span>

<span class="comment">   # if this line already exists, edit it  
</span>

}

</pre>

<!--  -->
<div class="node">
<a name="Templating"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Set-up-a-web-server">Set up a web server</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#High-level">High level</a>

</div>

<h3 class="section">2.29 Templating</h3>

<p>With CFEngine you have a choice between editing `deltas' into files
or distributing more-or-less finished templates. Which method you
should choose depends should be made by whatever is easiest.

     <ul>
<li>If you are managing only part of the file, and something else (e.g. a package manager)
is managing most of it, then it makes sense to use CFEngine file editing.

     <li>If you are managing everything in the file, then it makes sense to make the edits
by hand and install them using CFEngine. You can use variables within
source text files and let CFEngine expand them locally in situ, so
that you can make generic templates that apply netwide.

   </ul>
   Example template:

<pre class="verbatim">#
<span class="comment"># System file X
</span>
<span class="comment">#
</span>

MYVARIABLE = something or other
HOSTNAME = $(sys.host)           # CFEngine fills this in

<span class="comment"># ...
</span>

</pre>
To copy and expand this template, you can use a pattern like this:
<pre class="verbatim">
<span class="red">bundle agent</span> <span class="blue">test</span>
{
<span class="red">methods:
</span>
 "any"<span class="red"> usebundle </span>=><span class="blue"> get_template("/etc/sudoers","400");</span>
 "any"<span class="red"> usebundle </span>=><span class="blue"> get_template("/etc/hosts","644");</span>

}

</pre>
The the following driving code (based on `copy then edit') can be
placed in a library, after configuring to your environmental
locations:

<pre class="verbatim">bundle agent get_template(final_destination,mode)
{
<span class="red">vars:
</span>
<span class="comment"> # This needs to ne preconfigured to your site
</span>

 "masterfiles"<span class="red">   string </span>=><span class="green"> "/home/mark/tmp";</span>
 "this_template"<span class="red"> string </span>=> lastnode("$(final_destination)","/");

<span class="red">files:
</span>
  "$(final_destination).staging"

<span class="red">       comment </span>=><span class="green"> "Get template and expand variables for this host",</span>
<span class="red">         perms </span>=><span class="blue"> mo("400","root"),</span>
<span class="red">     copy_from </span>=><span class="blue"> remote_cp("$(masterfiles)/templates/$(this_template)","$(policy_server)"),</span>
<span class="red">        action </span>=><span class="blue"> if_elapsed("60");</span>

  "$(final_destination)"

<span class="red">       comment </span>=><span class="green"> "Expand the template",</span>
<span class="red">        create </span>=><span class="green"> "true",</span>
<span class="red">     edit_line </span>=> expand_template("$(final_destination).staging"),
<span class="red"> edit_defaults </span>=><span class="blue"> empty,</span>
<span class="red">         perms </span>=><span class="blue"> mo("$(mode)","root"),</span>
<span class="red">        action </span>=><span class="blue"> if_elapsed("60");</span>

}

</pre>

<!-- ********************************************************************** -->
<!-- CHAPTER -->
<!-- ********************************************************************** -->
<div class="node">
<a name="Low-level"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#High-level">High level</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Top">Top</a>

</div>

<h2 class="chapter">3 Low level</h2>

<!--  -->
<!--  -->
<ul class="menu">
<li><a accesskey="1" href="#Aborting-execution">Aborting execution</a>
<li><a accesskey="2" href="#ACL-file-example">ACL file example</a>
<li><a accesskey="3" href="#ACL-generic-example">ACL generic example</a>
<li><a accesskey="4" href="#ACL-secret-example">ACL secret example</a>
<li><a accesskey="5" href="#Active-directory-example">Active directory example</a>
<li><a accesskey="6" href="#Active-list-users-directory-example">Active list users directory example</a>
<li><a accesskey="7" href="#Active-directory-show-users-example">Active directory show users example</a>
<li><a accesskey="8" href="#Add-lines-to-a-file">Add lines to a file</a>
<li><a accesskey="9" href="#Add-users-to-passwd-and-group">Add users to passwd and group</a>
<li><a href="#Add-software-packages-to-the-system">Add software packages to the system</a>
<li><a href="#Add-variable-definitions-to-a-file">Add variable definitions to a file</a>
<li><a href="#Application-baseline">Application baseline</a>
<li><a href="#Array-example">Array example</a>
<li><a href="#Back-references-in-filenames">Back references in filenames</a>
<li><a href="#BSD-flags">BSD flags</a>
<li><a href="#Change-directory-for-command">Change directory for command</a>
<li><a href="#Check-file-or-directory-permissions">Check file or directory permissions</a>
<li><a href="#Class-match-example">Class match example</a>
<li><a href="#Client_002dserver-example">Client-server example</a>
<li><a href="#Commands-example">Commands example</a>
<li><a href="#Commenting-lines-in-a-file">Commenting lines in a file</a>
<li><a href="#Copy-files">Copy files</a>
<li><a href="#Copy-and-flatten-directory">Copy and flatten directory</a>
<li><a href="#Copy-then-edit">Copy then edit</a>
<li><a href="#Creating-files-and-directories">Creating files and directories</a>
<li><a href="#Database-creation">Database creation</a>
<li><a href="#Deleting-lines-from-a-file">Deleting lines from a file</a>
<li><a href="#Deleting-lines-exception">Deleting lines exception</a>
<li><a href="#Editing-files">Editing files</a>
<li><a href="#Editing-tabular-files">Editing tabular files</a>
<li><a href="#Environment-_0028virtual_0029">Environment (virtual)</a>
<li><a href="#Environment-variables">Environment variables</a>
<li><a href="#Execresult-example">Execresult example</a>
<li><a href="#Inserting-lines-in-a-file">Inserting lines in a file</a>
<li><a href="#Get-a-list-of-users">Get a list of users</a>
<li><a href="#Global-classes">Global classes</a>
<li><a href="#Hello-world">Hello world</a>
<li><a href="#LDAP-interactions">LDAP interactions</a>
<li><a href="#Linking-files">Linking files</a>
<li><a href="#Listing-files_002dpattern-in-a-directory">Listing files-pattern in a directory</a>
<li><a href="#Locate-and-transform-files">Locate and transform files</a>
<li><a href="#Logging">Logging</a>
<li><a href="#Measurements">Measurements</a>
<li><a href="#Methods">Methods</a>
<li><a href="#Method-validation">Method validation</a>
<li><a href="#Mount-NFS-filesystem">Mount NFS filesystem</a>
<li><a href="#Ordering-promises">Ordering promises</a>
<li><a href="#Process-management">Process management</a>
<li><a href="#Read-from-a-TCP-socket">Read from a TCP socket</a>
<li><a href="#Resolver-management">Resolver management</a>
<li><a href="#Search-and-replace-text">Search and replace text</a>
<li><a href="#Selecting-a-region-in-a-file">Selecting a region in a file</a>
<li><a href="#Service-management-_0028windows_0029">Service management (windows)</a>
<li><a href="#Set-up-a-PXE-boot-server">Set up a PXE boot server</a>
<li><a href="#Tidying-garbage-files">Tidying garbage files</a>
<li><a href="#Software-distribution">Software distribution</a>
<li><a href="#Trigger-classes">Trigger classes</a>
<li><a href="#Unmount-NFS-filesystem">Unmount NFS filesystem</a>
<li><a href="#Web-server-modules">Web server modules</a>
<li><a href="#Warn-if-matching-line-in-file">Warn if matching line in file</a>
<li><a href="#Windows-registry">Windows registry</a>
<li><a href="#unit_005fregistry_005fcache_002ecf">unit_registry_cache.cf</a>
<li><a href="#unit_005fregistry_002ecf">unit_registry.cf</a>
</ul>

<div class="node">
<a name="Aborting-execution"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#ACL-file-example">ACL file example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Low-level">Low level</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.1 Aborting execution</h3>

<pre class="verbatim">

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };

<span class="red">version </span>=><span class="green"> "1.2.3";</span>
}

<span class="comment">###########################################
</span>

<span class="red">body agent</span> <span class="blue">control</span>

{
<span class="red">abortbundleclasses </span>=> { "invalid.Hr16" };
}

<span class="comment">###########################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>
{
<span class="red">vars:
</span>
 "userlist"<span class="red"> slist </span>=> { "xyz", "mark", "jeang", "jonhenrik", "thomas", "eben" };

<span class="red">methods:
</span>
 "any"<span class="red"> usebundle </span>=><span class="blue"> subtest("$(userlist)");</span>

}

<span class="comment">###########################################
</span>

<span class="red">bundle agent</span> <span class="blue">subtest(user)</span>

{
<span class="red">classes:
</span>
  "invalid"<span class="red"> not </span>=> regcmp("[a-z][a-z][a-z][a-z]","$(user)");

<span class="red">reports:
</span>
 !invalid::

  "User name $(user) is valid at 4 letters";

 invalid::

  "User name $(user) is invalid";
}
</pre>

<div class="node">
<a name="ACL-file-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#ACL-generic-example">ACL generic example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Aborting-execution">Aborting execution</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.2 ACL file example</h3>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "acls" };
}

<span class="comment">#########################################
</span>

<span class="red">bundle agent</span> <span class="blue">acls</span>

{
<span class="red">files:
</span>
  "/media/flash/acl/test_dir"
 
<span class="red">    depth_search </span>=><span class="blue"> include_base,</span>
<span class="red">    acl </span>=><span class="blue"> template;</span>
}

<span class="comment">#########################################
</span>

<span class="red">body acl</span> <span class="blue">template</span>

{
<span class="red">acl_method </span>=><span class="green"> "overwrite";</span>
<span class="red">acl_type </span>=><span class="green"> "posix";</span>
<span class="red">acl_directory_inherit </span>=><span class="green"> "parent";</span>
<span class="red">aces </span>=> { "user:*:r(wwx),-r:allow", "group:*:+rw:allow", "mask:x:allow", "all:r"};
}

<span class="comment">#########################################
</span>

<span class="red">body acl</span> <span class="blue">win</span>

{
<span class="red">acl_method </span>=><span class="green"> "overwrite";</span>
<span class="red">acl_type </span>=><span class="green"> "ntfs";</span>
<span class="red">acl_directory_inherit </span>=><span class="green"> "nochange";</span>
<span class="red">aces </span>=> { "user:Administrator:rw", "group:Bad:rwx(Dpo):deny" };
}

<span class="comment">#########################################
</span>

<span class="red">body depth_search</span> <span class="blue">include_base</span>

{
<span class="red">include_basedir </span>=><span class="green"> "true";</span>
}
</pre>

<div class="node">
<a name="ACL-generic-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#ACL-secret-example">ACL secret example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#ACL-file-example">ACL file example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.3 ACL generic example</h3>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "acls" };
}

<span class="comment">#########################################
</span>

<span class="red">bundle agent</span> <span class="blue">acls</span>

{
<span class="red">files:
</span>
  "/media/flash/acl/test_dir"
   
<span class="red">    depth_search </span>=><span class="blue"> include_base,</span>
<span class="red">    acl </span>=><span class="blue"> test;</span>
}

<span class="comment">#########################################
</span>

<span class="red">body acl</span> <span class="blue">test</span>

{
<span class="red">acl_type </span>=><span class="green"> "generic";</span>
<span class="red">aces </span>=> {"user:bob:rwx", "group:staff:rx", "all:r"};
}

<span class="comment">#########################################
</span>

<span class="red">body depth_search</span> <span class="blue">include_base</span>

{
<span class="red">include_basedir </span>=><span class="green"> "true";</span>
}
</pre>

<div class="node">
<a name="ACL-secret-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Active-directory-example">Active directory example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#ACL-generic-example">ACL generic example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.4 ACL secret example</h3>

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "acls" };
}

<span class="comment">#########################################
</span>

<span class="red">bundle agent</span> <span class="blue">acls</span>

{
<span class="red">files:
</span>
 windows::

<span class="red">  "c:\Secret"
</span><span class="red">    acl </span>=><span class="blue"> win,</span>
<span class="red">    depth_search </span>=><span class="blue"> include_base,</span>
<span class="red">    comment </span>=><span class="green"> "Secure the secret directory from unauthorized access";</span>
}

<span class="comment">#########################################
</span>

<span class="red">body acl</span> <span class="blue">win</span>

{
<span class="red">acl_method </span>=><span class="green"> "overwrite";</span>
<span class="red">aces </span>=> { "user:Administrator:rwx" };
}

<span class="comment">#########################################
</span>

<span class="red">body depth_search</span> <span class="blue">include_base</span>

{
<span class="red">include_basedir </span>=><span class="green"> "true";</span>
}
</pre>

<div class="node">
<a name="Active-directory-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Active-list-users-directory-example">Active list users directory example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#ACL-secret-example">ACL secret example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.5 Active directory example</h3>

<pre class="verbatim">
<span class="comment">#########################################################################
</span>
<span class="comment">#   active_directory.cf - Extract Data From Windows Domain Controllers
</span>
<span class="comment">#
</span>
<span class="comment">#   NOTE: Since we don't supply any credentials in this policy file,
</span>
<span class="comment">#         the Domain Controller must allow anonymous bind. Also,
</span>
<span class="comment">#         the user "NT AUTHORITY\ANONYMOUS LOGON" must be granted access
</span>
<span class="comment">#         to the resources we want to read.
</span>
<span class="comment">#
</span>
<span class="comment">#########################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">active_directory</span>
{
<span class="red">vars:
</span><span class="comment"># NOTE: Edit this to your domain, e.g. "corp", may also need more DC's after it
</span>
  "domain_name"<span class="red"> string </span>=><span class="green"> "cftesting";</span>
  "user_name"<span class="red">    string </span>=><span class="green"> "Guest";</span>

  
<span class="comment"># NOTE: We can also extract data from remote Domain Controllers
</span>

dummy.DomainController::
  "domain_controller"<span class="red">  string </span>=><span class="green"> "localhost";</span>

  "userlist"<span class="red">    slist </span>=> ldaplist(
<span class="red">                                  "ldap://$(domain_controller)",
</span>                                  "CN=Users,DC=$(domain_name),DC=com",
                                  "(objectClass=user)",
                                  "sAMAccountName",
                                  "subtree",
                                  "none");

<span class="red">classes:
</span>
dummy.DomainController::

   "gotuser"<span class="red"> expression </span>=> ldaparray(
                                    "userinfo",
<span class="red">                                    "ldap://$(domain_controller)",
</span>                                    "CN=$(user_name),CN=Users,DC=$(domain_name),DC=com",
                                    "(name=*)",
                                    "subtree",
                                    "none");

								  
<span class="red">reports:
</span>dummy.DomainController::
  "Username is \"$(userlist)\"";

dummy.gotuser::
  "Got user data; $(userinfo[name]) has logged on $(userinfo[logonCount]) times";

}

</pre>

<div class="node">
<a name="Active-list-users-directory-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Active-directory-show-users-example">Active directory show users example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Active-directory-example">Active directory example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.6 Active list users directory example</h3>

<pre class="verbatim">
<span class="comment"># List users from Active Directory through LDAP
</span>
<span class="comment"># Note: Anonymous LDAP binding must be allowed, and the Anonymous user
</span>
<span class="comment"># must have read access to CN=Users
</span>

<span class="red">bundle agent</span> <span class="blue">ldap</span>
{
<span class="red">vars:
</span>   "userlist"<span class="red"> slist </span>=> ldaplist(
<span class="red">                                    "ldap://cf-win2003",
</span>                                    "CN=Users,DC=domain,DC=cf-win2003",
                                    "(objectClass=user)",
                                    "sAMAccountName",
                                    "subtree",
                                    "none");
<span class="red">reports:
</span>Yr2010::
<span class="red">  "Username: \"$(userlist)\"";
</span>}

</pre>

<div class="node">
<a name="Active-directory-show-users-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Add-lines-to-a-file">Add lines to a file</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Active-list-users-directory-example">Active list users directory example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.7 Active directory show users example</h3>

<pre class="verbatim">
<span class="comment"># List users from Active Directory through LDAP
</span>
<span class="comment"># Note: Anonymous LDAP binding must be allowed, and the Anonymous user
</span>
<span class="comment"># must have read access to CN=Users and CN=theusername
</span>
<span class="comment"># Run the agent in verbose mode to see the data
</span>

<span class="red">bundle agent</span> <span class="blue">ldap</span>
{
<span class="red">classes:
</span>   "gotdata"<span class="red"> expression </span>=> ldaparray(
                                    "myarray",
<span class="red">                                    "ldap://cf-win2003",
</span>                                    "CN=Test Pilot,CN=Users,DC=domain,DC=cf-win2003",
                                    "(name=*)",
                                    "subtree",
                                    "none");
<span class="red">reports:
</span>gotdata::
  "Got user data";
!gotdata::
  "Did not get user data";
}
</pre>

<div class="node">
<a name="Add-lines-to-a-file"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Add-users-to-passwd-and-group">Add users to passwd and group</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Active-directory-show-users-example">Active directory show users example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.8 Add lines to a file</h3>

<p>There are  numerous approaches to adding lines to a file. 
Often the order of a configuration file is unimportant, we just need to ensure
settings within it. A simple way of adding lines is show below.

<pre class="verbatim">body common control

{
any::

<span class="red">  bundlesequence  </span>=> { "insert" };   
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">insert</span>

{
<span class="red">vars:
</span>
  "lines"<span class="red"> string </span>=><span class="blue"> </span>
                "
                One potato
                Two potato
                Three potatoe
                Four
                ";
 
<span class="red">files:
</span>
  "/tmp/test_insert"

<span class="red">            create </span>=><span class="green"> "true",</span>
<span class="red">         edit_line </span>=><span class="blue"> append_if_no_line("$(insert.lines)");</span>

}

</pre>
Also you could write this using a list variable:
<pre class="verbatim">body common control

{
any::

<span class="red">  bundlesequence  </span>=> { "insert" };   
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">insert</span>

{
<span class="red">vars:
</span>
  "lines"<span class="red"> slist </span>=> { "One potato", "Two potato",
                "Three potatoe", "Four" };
 
<span class="red">files:
</span>
  "/tmp/test_insert"

<span class="red">            create </span>=><span class="green"> "true",</span>
<span class="red">         edit_line </span>=><span class="blue"> append_if_no_line("@(insert.lines)");</span>

}

</pre>

<!--  -->
<div class="node">
<a name="Add-users-to-passwd-and-group"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Add-software-packages-to-the-system">Add software packages to the system</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Add-lines-to-a-file">Add lines to a file</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.9 Add users to passwd and group</h3>

<p>Add lines to the password file, and users to group if they are not already there.
<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "addpasswd" };
<span class="red">inputs </span>=> { "cf_std_library.cf" };
}

<span class="red">bundle agent</span> <span class="blue">addpasswd</span>
{
<span class="red">vars:
</span>
<span class="comment">  # want to set these values by the names of their array keys
</span>

  "pwd[mark]"<span class="red"> string </span>=><span class="green"> "mark:x:1000:100:Mark Burgess:/home/mark:/bin/bash";</span>
  "pwd[fred]"<span class="red"> string </span>=><span class="green"> "fred:x:1001:100:Right Said:/home/fred:/bin/bash";</span>
  "pwd[jane]"<span class="red"> string </span>=><span class="green"> "jane:x:1002:100:Jane Doe:/home/jane:/bin/bash";</span>

  "users"<span class="red"> slist </span>=> getindices("pwd");

<span class="red">files:
</span>
  "/etc/passwd"

<span class="red">        create </span>=><span class="green"> "true",</span>
<span class="red">     edit_line </span>=><span class="blue"> append_users_starting("addpasswd.pwd");</span>

  "/etc/group"

<span class="red">       edit_line </span>=><span class="blue"> append_user_field("users","4","@(addpasswd.users)");</span>

}

</pre>

<!--  -->
<div class="node">
<a name="Add-software-packages-to-the-system"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Add-variable-definitions-to-a-file">Add variable definitions to a file</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Add-users-to-passwd-and-group">Add users to passwd and group</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.10 Add software packages to the system</h3>

<pre class="verbatim">#
<span class="comment"># Package managment
</span>
<span class="comment">#
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "packages" };
}

<span class="comment">#############################################
</span>

<span class="red">bundle agent</span> <span class="blue">packages</span>
{
<span class="red">vars:
</span>
 "match_package"<span class="red"> slist </span>=> { 
                          "apache2", 
                          "apache2-mod_php5",
                          "apache2-prefork",
                          "php5" 
                          };
<span class="red">packages:
</span>
 solaris::

  "$(match_package)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> solaris;</span>

 redhat|SuSE::

  "$(match_package)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> yum;</span>

}
</pre>

<p>Note you can also arrange to hide all the differences between package managers
on an OS basis, but since some OSs have multiple managers, this might not
be 100 percent correct.

<!--  -->
<div class="node">
<a name="Add-variable-definitions-to-a-file"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Application-baseline">Application baseline</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Add-software-packages-to-the-system">Add software packages to the system</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.11 Add variable definitions to a file e.g. <samp><span class="file">/etc/system</span></samp></h3>

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "setvars" };
<span class="red">inputs </span>=> { "cf_std_library.cf" };
}


<span class="red">bundle agent</span> <span class="blue">setvars</span>
{
<span class="red">vars:
</span>
<span class="comment">  # want to set these values by the names of their array keys
</span>

  "rhs[lhs1]"<span class="red"> string </span>=><span class="green"> " Mary had a little pig";</span>
  "rhs[lhs2]"<span class="red"> string </span>=><span class="green"> "Whose Fleece was white as snow";</span>
  "rhs[lhs3]"<span class="red"> string </span>=><span class="green"> "And everywhere that Mary went";</span>

<span class="comment">  # oops, now change pig -> lamb
</span>

<span class="red">files:
</span>
  "/tmp/system"

<span class="red">        create </span>=><span class="green"> "true",</span>
<span class="red">     edit_line </span>=><span class="blue"> set_variable_values("setvars.rhs");</span>

}

</pre>

<p class="noindent">Results in:

<pre class="verbatim">lhs1= Mary had a little pig
lhs2=Whose Fleece was white as snow
lhs3=And everywhere that Mary went
</pre>

<p class="noindent">An example of this would be to add variables to <samp><span class="file">/etc/sysctl.conf</span></samp> on Linux:

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "setvars" };
<span class="red">inputs </span>=> { "cf_std_library.cf" };
}


<span class="red">bundle agent</span> <span class="blue">setvars</span>
{
<span class="red">vars:
</span>
<span class="comment">  # want to set these values by the names of their array keys
</span>

  "rhs[net/ipv4/tcp_syncookies]"<span class="red"> string </span>=><span class="green"> "1";</span>
  "rhs[net/ipv4/icmp_echo_ignore_broadcasts]"<span class="red"> string </span>=><span class="green"> "1";</span>
  "rhs[net/ipv4/ip_forward]"<span class="red"> string </span>=><span class="green"> "1";</span>

<span class="comment">  # oops, now change pig -> lamb
</span>

<span class="red">files:
</span>
  "/etc/sysctl"

<span class="red">        create </span>=><span class="green"> "true",</span>
<span class="red">     edit_line </span>=><span class="blue"> set_variable_values("setvars.rhs");</span>

}

</pre>

<ul class="menu">
<li><a accesskey="1" href="#Application-baseline">Application baseline</a>
<li><a accesskey="2" href="#Array-example">Array example</a>
<li><a accesskey="3" href="#Back-references-in-filenames">Back references in filenames</a>
<li><a accesskey="4" href="#BSD-flags">BSD flags</a>
<li><a accesskey="5" href="#Change-directory-for-command">Change directory for command</a>
</ul>

<div class="node">
<a name="Application-baseline"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Array-example">Array example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Add-variable-definitions-to-a-file">Add variable definitions to a file</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.12 Application baseline</h3>

<pre class="verbatim">
<span class="comment">#########################################################################
</span>
<span class="comment">#
</span>
<span class="comment">#   app_baseline.cf - Verify Existence of Applications
</span>
<span class="comment">#
</span>
<span class="comment">#   NOTE: Sometimes applications are not correctly installed even
</span>
<span class="comment">#         though the native package manager reports them to be.
</span>
<span class="comment">#         Cfengine can check for application-specific configuration
</span>
<span class="comment">#         and act upon or report any anomalies.
</span>
<span class="comment">#
</span>
<span class="comment">#########################################################################
</span>


<span class="red">bundle agent</span> <span class="blue">app_baseline</span>
{

<span class="red">methods:
</span>windows::
"any"<span class="red"> usebundle </span>=><span class="blue"> detect_adobereader;</span>

}

<span class="comment">###
</span>

<span class="red">bundle agent</span> <span class="blue">detect_adobereader</span>
{
<span class="red">vars:
</span>
windows::
  "value1"<span class="red"> string </span>=> registryvalue("HKEY_LOCAL_MACHINE\SOFTWARE\Adobe\Acrobat Reader\9.0\Installer", "ENU_GUID");
  "value2"<span class="red"> string </span>=> registryvalue("HKEY_LOCAL_MACHINE\SOFTWARE\Adobe\Acrobat Reader\9.0\Installer", "VersionMax");
  "value3"<span class="red"> string </span>=> registryvalue("HKEY_LOCAL_MACHINE\SOFTWARE\Adobe\Acrobat Reader\9.0\Installer", "VersionMin");
 
<span class="red">classes:
</span>
windows::
  "is_correct"<span class="red"> and </span>=> { 
                       strcmp("$(value1)", "{AC76BA86-7AD7-1033-7B44-A93000000001}"),
                       strcmp("$(value2)", "90003"),
                       islessthan("$(value3)", "10001" )
                      };
 
<span class="red"> reports:
</span>
windows.!is_correct::
 "Adobe Reader is not correctly deployed - got \"$(value1)\", \"$(value2)\", \"$(value3)\"";
}
</pre>

<div class="node">
<a name="Array-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Back-references-in-filenames">Back references in filenames</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Application-baseline">Application baseline</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.13 Array example</h3>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "array" };
}


<span class="red">bundle common g
</span>{
<span class="red">vars:
</span>
  "array[1]"<span class="red"> string </span>=><span class="green"> "one"; </span>
  "array[2]"<span class="red"> string </span>=><span class="green"> "two"; </span>
}

<span class="red">bundle agent</span> <span class="blue">array</span>
{
<span class="red">vars:
</span>
  "localarray[1]"<span class="red"> string </span>=><span class="green"> "one"; </span>
  "localarray[2]"<span class="red"> string </span>=><span class="green"> "two"; </span>

<span class="red">reports:
</span>
 linux::

   "Global $(g.array[1]) and $(localarray[2])";
}

</pre>

<!--  -->
<div class="node">
<a name="Back-references-in-filenames"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#BSD-flags">BSD flags</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Array-example">Array example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.14 Backreferences in filenames</h3>

<pre class="verbatim">
<span class="comment">######################################################################
</span>
<span class="comment">#
</span>
<span class="comment"># File editing - back reference
</span>
<span class="comment">#
</span>
<span class="comment">######################################################################
</span>


<span class="red">body common control
</span>
{
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
<span class="comment">  # The back reference in a path only applies to the last link
</span>
<span class="comment">  # of the pathname, so the (tmp) gets ignored
</span>

  "/tmp/(cf3)_(.*)"

<span class="red">       edit_line </span>=> myedit("second $(match.2)");


<span class="comment">  # but ...
</span>

<span class="comment">#  "/tmp/cf3_test"
</span>
<span class="comment">#       create    => "true",
</span>
<span class="comment">#       edit_line => myedit("second $(match.1)");
</span>


}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">myedit(parameter)</span>
  {
<span class="red">  vars:
</span>
   "edit_variable"<span class="red"> string </span>=><span class="green"> "private edit variable is $(parameter)"; </span>

<span class="red">  insert_lines:
</span>
     "$(edit_variable)";
  
  }

</pre>

<div class="node">
<a name="BSD-flags"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Change-directory-for-command">Change directory for command</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Back-references-in-filenames">Back references in filenames</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.15 BSD flags</h3>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "test" };
}

<span class="red">bundle agent</span> <span class="blue">test</span>
{
<span class="red">files:
</span>
 freebsd::

   "/tmp/newfile"

<span class="red">       create </span>=><span class="green"> "true",</span>
<span class="red">       perms </span>=><span class="blue"> setbsd;</span>

}


<span class="red">body perms</span> <span class="blue">setbsd</span>
{
<span class="red">bsdflags </span>=> { "+uappnd","+uchg", "+uunlnk", "-nodump" };
}

</pre>

<!--  -->
<div class="node">
<a name="Change-directory-for-command"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Check-file-or-directory-permissions">Check file or directory permissions</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#BSD-flags">BSD flags</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.16 Change directory for command</h3>

<pre class="verbatim">


<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "example" };
}

<span class="comment">###########################################################
</span>

<span class="red">body contain</span> <span class="blue">cd(dir)</span>
{
<span class="red">chdir </span>=><span class="green"> "${dir}";</span>
<span class="red">useshell </span>=><span class="green"> "true";</span>
}

<span class="red">bundle agent</span> <span class="blue">example</span>
{
<span class="red">commands:
</span>
   "/bin/pwd"
<span class="red">       contain </span>=><span class="blue"> cd("/tmp");</span>
}

</pre>

<div class="node">
<a name="Check-file-or-directory-permissions"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Class-match-example">Class match example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Change-directory-for-command">Change directory for command</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.17 Check file or directory permissions</h3>

<pre class="verbatim">
<span class="red">bundle agent</span> <span class="blue">check_perms</span>
{
<span class="red">vars:
</span>
  "ns_files"<span class="red"> slist </span>=> {
                      "/local/iu/logs/admin",
                      "/local/iu/logs/security",
                      "/local/iu/logs/updates",
                      "/local/iu/logs/xfer"
                      };
<span class="red">files:
</span>
   NameServers::

    "/local/dns/pz"

<span class="red">            perms </span>=><span class="blue"> mo("644","dns")</span>
<span class="red">     depth_search </span>=><span class="blue"> recurse("1"),</span>
<span class="red">      file_select </span>=><span class="blue"> exclude("secret_file");</span>

    "/local/iu/dns/pz/FixSerial"

<span class="red">            perms </span>=><span class="blue"> m("755"),</span>
<span class="red">      file_select </span>=><span class="blue"> plain;</span>

    "$(ns_files)"

<span class="red">            perms </span>=><span class="blue"> mo("644","dns"),</span>
<span class="red">      file_select </span>=><span class="blue"> plain;</span>


    "$(ftp)/pub"      
<span class="red">             perms </span>=><span class="blue"> mog("644","root","other");</span>

    "$(ftp)/pub"      
<span class="red">             perms </span>=><span class="blue"> m("644"),</span>
<span class="red">      depth_search </span>=><span class="blue"> recurse("inf");</span>

    "$(ftp)/etc"<span class="red">        perms </span>=><span class="blue"> mog("111","root","other");</span>
    "$(ftp)/usr/bin/ls"<span class="red"> perms </span>=><span class="blue"> mog("111","root","other");</span>
    "$(ftp)/dev"<span class="red">        perms </span>=><span class="blue"> mog("555","root","other");</span>
    "$(ftp)/usr"<span class="red">        perms </span>=><span class="blue"> mog("555","root","other");</span>
}
</pre>

<ul class="menu">
<li><a accesskey="1" href="#Class-match-example">Class match example</a>
<li><a accesskey="2" href="#Client_002dserver-example">Client-server example</a>
<li><a accesskey="3" href="#Commands-example">Commands example</a>
<li><a accesskey="4" href="#Commenting-lines-in-a-file">Commenting lines in a file</a>
</ul>

<div class="node">
<a name="Class-match-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Client_002dserver-example">Client-server example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Check-file-or-directory-permissions">Check file or directory permissions</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.18 Class match example</h3>

<pre class="verbatim">

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "example" };
}

<span class="comment">###########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">example</span>

{     
<span class="red">classes:
</span>
  "do_it"<span class="red"> and </span>=> { classmatch(".*_3"), "linux" }; 

<span class="red">reports:
</span>
  do_it::

    "Host matches pattern";

}

</pre>

<div class="node">
<a name="Client-server-example"></a>
<a name="Client_002dserver-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Commands-example">Commands example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Class-match-example">Class match example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.19 Client-server example</h3>

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Simple test copy from server connection to cfServer
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="comment"> #
</span>
<span class="comment"> # run this as follows:
</span>
<span class="comment"> #
</span>
<span class="comment"> # cf-serverd -f runtest_1.cf [-v]
</span>
<span class="comment"> # cf-agent   -f runtest_2.cf
</span>
<span class="comment"> #
</span>
<span class="comment"> # Notice that the same file configures all parts of cfengine
</span>


<span class="comment">########################################################
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence  </span>=> { "testbundle" };
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="comment">#fips_mode => "true";
</span>
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>
{
<span class="red">files: 
</span>
  "/home/mark/tmp/testcopy" 
<span class="red">        comment  </span>=><span class="green"> "test copy promise",</span>
<span class="red">    copy_from    </span>=><span class="blue"> mycopy("/home/mark/LapTop/words","127.0.0.1"),</span>
<span class="red">    perms        </span>=><span class="blue"> system,</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf"),</span>
<span class="red">    classes      </span>=><span class="blue"> satisfied("copy_ok");</span>

  "/home/mark/tmp/testcopy/single_file" 

<span class="red">        comment  </span>=><span class="green"> "test copy promise",</span>
<span class="red">    copy_from    </span>=><span class="blue"> mycopy("/home/mark/LapTop/Cfengine3/trunk/README","127.0.0.1"),</span>
<span class="red">    perms        </span>=><span class="blue"> system;</span>

<span class="red">reports:
</span>
  copy_ok::

    "Files were copied..";
}

<span class="comment">#########################################################
</span>

<span class="red">body perms</span> <span class="blue">system</span>

{
<span class="red">mode  </span>=><span class="green"> "0644";</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body depth_search</span> <span class="blue">recurse(d)</span>

{
<span class="red">depth </span>=><span class="green"> "$(d)";</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body copy_from</span> <span class="blue">mycopy(from,server)</span>

{
<span class="red">source      </span>=><span class="green"> "$(from)";</span>
<span class="red">servers     </span>=> { "$(server)" };
<span class="red">compare     </span>=><span class="green"> "digest";</span>
<span class="red">encrypt     </span>=><span class="green"> "true";</span>
<span class="red">verify      </span>=><span class="green"> "true";</span>
<span class="red">copy_backup </span>=><span class="green"> "true";                  #/false/timestamp</span>
<span class="red">purge       </span>=><span class="green"> "false";</span>
<span class="red">type_check  </span>=><span class="green"> "true";</span>
<span class="red">force_ipv4  </span>=><span class="green"> "true";</span>
<span class="red">trustkey </span>=><span class="green"> "true";</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body classes</span> <span class="blue">satisfied(x)</span>
{
<span class="red">promise_repaired </span>=> { "$(x)" };
<span class="red">persist_time </span>=><span class="green"> "0";</span>
}

<span class="comment">#########################################################
</span>
<span class="comment"># Server config
</span>
<span class="comment">#########################################################
</span>

<span class="red">body server</span> <span class="blue">control</span>

{
<span class="red">allowconnects         </span>=> { "127.0.0.1" , "::1" };
<span class="red">allowallconnects      </span>=> { "127.0.0.1" , "::1" };
<span class="red">trustkeysfrom         </span>=> { "127.0.0.1" , "::1" };
<span class="comment"># allowusers
</span>
}

<span class="comment">#########################################################
</span>

<span class="red">bundle server</span> <span class="blue">access_rules()</span>

{

<span class="red">access:
</span>
  "/home/mark/LapTop"

<span class="red">    admit   </span>=> { "127.0.0.1" };
}



</pre>

<div class="node">
<a name="Commands-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Commenting-lines-in-a-file">Commenting lines in a file</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Client_002dserver-example">Client-server example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.20 Commands example</h3>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence  </span>=> { "my_commands" };
<span class="red">inputs </span>=> { "cfengine_stdlib.cf" };
}


<span class="red">bundle agent</span> <span class="blue">my_commands</span>
{
<span class="red">commands:
</span>
 Sunday.Hr04.Min05_10.myhost::

  "/usr/bin/update_db";

 any::

  "/etc/mysql/start"

<span class="red">      contain </span>=><span class="blue"> setuid("mysql");</span>

}


</pre>

<div class="node">
<a name="Commenting-lines-in-a-file"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Copy-files">Copy files</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Commands-example">Commands example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.21 Commenting lines in a file</h3>

<pre class="verbatim">
<span class="comment">######################################################################
</span>
<span class="comment">#
</span>
<span class="comment"># File editing
</span>
<span class="comment">#
</span>
<span class="comment"># Normal ordering:
</span>
<span class="comment"># - delete
</span>
<span class="comment"># - replace | colum_edit
</span>
<span class="comment"># - insert
</span>
<span class="comment"># 
</span>
<span class="comment">######################################################################
</span>


<span class="red">body common control
</span>
{
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{

<span class="red">files:
</span>
  "/home/mark/tmp/cf3_test"

<span class="red">       create    </span>=><span class="green"> "true",</span>
<span class="red">       edit_line </span>=> myedit("second");
}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">myedit(parameter)</span>
  {
<span class="red">  vars:
</span>
   "edit_variable"<span class="red"> string </span>=><span class="green"> "private edit variable is $(parameter)"; </span>

  
<span class="red">  replace_patterns:
</span>
<span class="comment">  # replace shell comments with C comments
</span>

   "#(.*)"

<span class="red">      replace_with </span>=><span class="blue"> C_comment,</span>
<span class="red">     select_region </span>=> MySection("New section");

  }

<span class="comment">########################################
</span>
<span class="comment"># Bodies
</span>
<span class="comment">########################################
</span>

<span class="red">body replace_with</span> <span class="blue">C_comment</span>

{
<span class="red">replace_value </span>=><span class="green"> "/* $(match.1) */"; # backreference 0</span>
<span class="red">occurrences </span>=><span class="green"> "all";  # first, last all</span>
}

<span class="comment">########################################################
</span>

<span class="red">body select_region</span> <span class="blue">MySection(x)</span>

{
<span class="red">select_start </span>=><span class="green"> "\[$(x)\]";</span>
<span class="red">select_end </span>=><span class="green"> "\[.*\]";</span>
}
</pre>

<pre class="verbatim">
<span class="comment">######################################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Comment lines
</span>
<span class="comment">#
</span>
<span class="comment">######################################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/home/mark/tmp/comment_test"

<span class="red">       create    </span>=><span class="green"> "true",</span>
<span class="red">       edit_line </span>=><span class="blue"> comment_lines_matching;</span>
}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">comment_lines_matching</span>
  {
<span class="red">  vars:
</span>
    "regexes"<span class="red"> slist </span>=> { "one.*", "two.*", "four.*" };

<span class="red">  replace_patterns:
</span>
   "^($(regexes))$"
<span class="red">      replace_with </span>=><span class="blue"> comment("# ");</span>
  }

<span class="comment">########################################
</span>
<span class="comment"># Bodies
</span>
<span class="comment">########################################
</span>

<span class="red">body replace_with</span> <span class="blue">comment(c)</span>

{
<span class="red">replace_value </span>=><span class="green"> "$(c) $(match.1)";</span>
<span class="red">occurrences </span>=><span class="green"> "all";</span>
}

</pre>

<pre class="verbatim">
<span class="comment">######################################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Uncomment lines
</span>
<span class="comment">#
</span>
<span class="comment">######################################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment"># try this on some test data like
</span>

<span class="comment"># one
</span>
<span class="comment"># two
</span>
<span class="comment"># mark one
</span>
<span class="comment">#mark two
</span>

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/home/mark/tmp/comment_test"

<span class="red">       create    </span>=><span class="green"> "true",</span>
<span class="red">       edit_line </span>=><span class="blue"> uncomment_lines_matching("\s*mark.*","#");</span>
}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">uncomment_lines_matching(regex,comment)</span>
{
<span class="red">replace_patterns:
</span>
 "#($(regex))$"<span class="red"> replace_with </span>=><span class="blue"> uncomment;</span>
}

<span class="comment">########################################################
</span>

<span class="red">body replace_with</span> <span class="blue">uncomment</span>
{
<span class="red">replace_value </span>=><span class="green"> "$(match.1)";</span>
<span class="red">occurrences </span>=><span class="green"> "all";</span>
}

</pre>

<div class="node">
<a name="Copy-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Copy-and-flatten-directory">Copy and flatten directory</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Commenting-lines-in-a-file">Commenting lines in a file</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.22 Copy files</h3>

<pre class="verbatim">files:

  "/var/cfengine/inputs" 

<span class="red">    handle </span>=><span class="green"> "update_policy",</span>
<span class="red">    perms </span>=><span class="blue"> m("600"),</span>
<span class="red">    copy_from </span>=> u_scp("$(master_location)",@(policy_server)),
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf"),</span>
<span class="red">    file_select </span>=><span class="blue"> input_files,</span>
<span class="red">    action </span>=><span class="blue"> immediate;</span>

  "/var/cfengine/bin" 

<span class="red">    perms </span>=><span class="blue"> m("700"),</span>
<span class="red">    copy_from </span>=><span class="blue"> u_scp("/usr/local/sbin","localhost"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf"),</span>
<span class="red">    file_select </span>=><span class="blue"> cf3_files,</span>
<span class="red">    action </span>=><span class="blue"> immediate,</span>
<span class="red">    classes </span>=> on_change("reload");

</pre>

<ul class="menu">
<li><a accesskey="1" href="#Copy-and-flatten-directory">Copy and flatten directory</a>
</ul>

<div class="node">
<a name="Copy-and-flatten-directory"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Copy-then-edit">Copy then edit</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Copy-files">Copy files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.23 Copy and flatten directory</h3>

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Simple test copy from server connection to cfServer
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="comment"> #
</span>
<span class="comment"> # run this as follows:
</span>
<span class="comment"> #
</span>
<span class="comment"> # cf-serverd -f runtest_1.cf [-d2]
</span>
<span class="comment"> # cf-agent   -f runtest_2.cf
</span>
<span class="comment"> #
</span>
<span class="comment"> # Notice that the same file configures all parts of cfengine
</span>

<span class="comment">########################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle" };
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/home/mark/tmp/testflatcopy" 

<span class="red">        comment  </span>=><span class="green"> "test copy promise",</span>
<span class="red">    copy_from    </span>=><span class="blue"> mycopy("/home/mark/LapTop/words","127.0.0.1"),</span>
<span class="red">    perms        </span>=><span class="blue"> system,</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf"),</span>
<span class="red">    classes      </span>=><span class="blue"> satisfied("copy_ok");</span>


  "/home/mark/tmp/testcopy/single_file" 

<span class="red">        comment  </span>=><span class="green"> "test copy promise",</span>
<span class="red">    copy_from    </span>=><span class="blue"> mycopy("/home/mark/LapTop/Cfengine3/trunk/README","127.0.0.1"),</span>
<span class="red">    perms        </span>=><span class="blue"> system;</span>

<span class="red">reports:
</span>
  copy_ok::

    "Files were copied..";
}

<span class="comment">#########################################################
</span>

<span class="red">body perms</span> <span class="blue">system</span>

{
<span class="red">mode  </span>=><span class="green"> "0644";</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body depth_search</span> <span class="blue">recurse(d)</span>

{
<span class="red">depth </span>=><span class="green"> "$(d)";</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body copy_from</span> <span class="blue">mycopy(from,server)</span>

{
<span class="red">source      </span>=><span class="green"> "$(from)";</span>
<span class="red">servers     </span>=> { "$(server)" };
<span class="red">compare     </span>=><span class="green"> "digest";</span>
<span class="red">verify      </span>=><span class="green"> "true";</span>
<span class="red">copy_backup </span>=><span class="green"> "true";                  #/false/timestamp</span>
<span class="red">purge       </span>=><span class="green"> "false";</span>
<span class="red">type_check  </span>=><span class="green"> "true";</span>
<span class="red">force_ipv4  </span>=><span class="green"> "true";</span>
<span class="red">trustkey </span>=><span class="green"> "true";</span>
<span class="red">collapse_destination_dir </span>=><span class="green"> "true";</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body classes</span> <span class="blue">satisfied(x)</span>
{
<span class="red">promise_repaired </span>=> { "$(x)" };
<span class="red">persist_time </span>=><span class="green"> "0";</span>
}

<span class="comment">#########################################################
</span>
<span class="comment"># Server config
</span>
<span class="comment">#########################################################
</span>

<span class="red">body server</span> <span class="blue">control</span>

{
<span class="red">allowconnects         </span>=> { "127.0.0.1" , "::1" };
<span class="red">allowallconnects      </span>=> { "127.0.0.1" , "::1" };
<span class="red">trustkeysfrom         </span>=> { "127.0.0.1" , "::1" };
}

<span class="comment">#########################################################
</span>

<span class="red">bundle server</span> <span class="blue">access_rules()</span>

{
<span class="red">access:
</span>
  "/home/mark/LapTop"

<span class="red">    admit   </span>=> { "127.0.0.1" };
}

</pre>

<div class="node">
<a name="Copy-then-edit"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Creating-files-and-directories">Creating files and directories</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Copy-and-flatten-directory">Copy and flatten directory</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.24 Copy then edit a file convergently</h3>

<p>To convergently chain a copy followed by edit, you need a staging file. 
First you copy to the staging file. Then you edit the final file and
insert the staging file into it as part of the editing. This is convergent
with respect to both stages of the process.

<pre class="verbatim">bundle agent master
{
<span class="red">files:
</span>
  "$(final_destination)"

<span class="red">         create </span>=><span class="green"> "true",</span>
<span class="red">     edit_line </span>=><span class="blue"> fix_file("$(staging_file)"),</span>
<span class="red"> edit_defaults </span>=><span class="blue"> empty,</span>
<span class="red">         perms </span>=><span class="blue"> mo("644","root"),</span>
<span class="red">        action </span>=><span class="blue"> ifelapsed("60");</span>
}

<span class="comment">#
</span>

<span class="red">bundle edit_line</span> <span class="blue">fix_file(f)</span>
{
<span class="red">insert_lines:
</span>
  "$(f)"
 
<span class="comment">     # insert this into an empty file to reconstruct
</span>
 
<span class="red">     insert_type </span>=><span class="green"> "file";</span>

<span class="red">replace_patterns:
</span>
    "searchstring"

<span class="red">          replace_with </span>=><span class="blue"> With("replacestring");</span>
}


</pre>

<ul class="menu">
<li><a accesskey="1" href="#Creating-files-and-directories">Creating files and directories</a>
<li><a accesskey="2" href="#Database-creation">Database creation</a>
<li><a accesskey="3" href="#Deleting-lines-from-a-file">Deleting lines from a file</a>
<li><a accesskey="4" href="#Deleting-lines-exception">Deleting lines exception</a>
</ul>

<div class="node">
<a name="Creating-files-and-directories"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Database-creation">Database creation</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Copy-then-edit">Copy then edit</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.25 Creating files and directories</h3>

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Simple test create files
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/home/mark/tmp/test_plain" 

<span class="red">       perms </span>=><span class="blue"> system,</span>
<span class="red">       create </span>=><span class="green"> "true";</span>

  "/home/mark/tmp/test_dir/." 

<span class="red">       perms </span>=><span class="blue"> system,</span>
<span class="red">       create </span>=><span class="green"> "true";</span>

}

<span class="comment">#########################################################
</span>

<span class="red">body perms</span> <span class="blue">system</span>

{
<span class="red">mode  </span>=><span class="green"> "0640";</span>
}

<span class="comment">#########################################################
</span>

</pre>

<!--  -->
<div class="node">
<a name="Database-creation"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Deleting-lines-from-a-file">Deleting lines from a file</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Creating-files-and-directories">Creating files and directories</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.26 Database creation</h3>

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "dummy" };
}

<span class="red">body knowledge</span> <span class="blue">control</span>

{
<span class="comment">#sql_database => "postgres";
</span>
<span class="red">sql_owner </span>=><span class="green"> "postgres";</span>
<span class="red">sql_passwd </span>=><span class="green"> ""; # No passwd</span>
<span class="red">sql_type </span>=><span class="green"> "postgres";</span>
}

<span class="red">bundle knowledge</span> <span class="blue">dummy</span>
{
<span class="red">topics:
</span>}
</pre>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "databases" };
}

<span class="red">bundle agent</span> <span class="blue">databases</span>

{
<span class="comment">#commands:
</span>

<span class="comment">#  "/usr/bin/createdb cf_topic_maps",
</span>

<span class="comment">#        contain => as_user("mysql");
</span>

<span class="red">databases:
</span>
  "knowledge_bank/topics"

<span class="red">    database_operation </span>=><span class="green"> "create",</span>
<span class="red">    database_type </span>=><span class="green"> "sql",</span>
<span class="red">    database_columns </span>=> { 
                        "topic_name,varchar,256",
                        "topic_comment,varchar,1024",
                        "topic_id,varchar,256",
                        "topic_type,varchar,256",
                        "topic_extra,varchar,26" 
                        },

<span class="red">    database_server </span>=><span class="blue"> myserver;</span>



}

<span class="comment">################################################
</span>

<span class="red">body database_server</span> <span class="blue">myserver</span>
{
none::
<span class="red"> db_server_owner </span>=><span class="green"> "postgres";</span>
<span class="red"> db_server_password </span>=><span class="green"> "";</span>
<span class="red"> db_server_host </span>=><span class="green"> "localhost";</span>
<span class="red"> db_server_type </span>=><span class="green"> "postgres";</span>
<span class="red"> db_server_connection_db </span>=><span class="green"> "postgres";</span>
any::
<span class="red"> db_server_owner </span>=><span class="green"> "root";</span>
<span class="red"> db_server_password </span>=><span class="green"> "";</span>
<span class="red"> db_server_host </span>=><span class="green"> "localhost";</span>
<span class="red"> db_server_type </span>=><span class="green"> "mysql";</span>
<span class="red"> db_server_connection_db </span>=><span class="green"> "mysql";</span>
}

<span class="red">body contain</span> <span class="blue">as_user(x)</span>
{
<span class="red">exec_owner </span>=><span class="green"> "$(x)";</span>
}
</pre>

<div class="node">
<a name="Deleting-lines-from-a-file"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Deleting-lines-exception">Deleting lines exception</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Database-creation">Database creation</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.27 Deleting lines from a file</h3>

<pre class="verbatim">


<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "test" };
}



<span class="red">bundle agent</span> <span class="blue">test</span>
{
<span class="red">files:
</span>
  "/tmp/resolv.conf"  # test on "/tmp/resolv.conf" #

<span class="red">     create        </span>=><span class="green"> "true",</span>
<span class="red">     edit_line     </span>=><span class="blue"> resolver,</span>
<span class="red">     edit_defaults </span>=><span class="blue"> def;</span>

}


<span class="comment">#######################################################
</span>
<span class="comment"># For the library
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">resolver</span>

{
<span class="red">vars:
</span>
 "search"<span class="red"> slist </span>=> { "search iu.hio.no cfengine.com", "nameserver 128.39.89.10" };

<span class="red">delete_lines:
</span>
  "search.*";

<span class="red">insert_lines:
</span>
  "$(search)"<span class="red"> location </span>=><span class="blue"> end;</span>
}

<span class="comment">#######################################################
</span>

<span class="red">body edit_defaults</span> <span class="blue">def</span>
{
<span class="red">empty_file_before_editing </span>=><span class="green"> "false";</span>
<span class="red">edit_backup </span>=><span class="green"> "false";</span>
<span class="red">max_file_size </span>=><span class="green"> "100000";</span>
}

<span class="comment">########################################################
</span>

<span class="red">body location</span> <span class="blue">start</span>

{
<span class="comment"># If not line to match, applies to whole text body
</span>
<span class="red">before_after </span>=><span class="green"> "before";</span>
}

<span class="comment">########################################################
</span>

<span class="red">body location</span> <span class="blue">end</span>

{
<span class="comment"># If not line to match, applies to whole text body
</span>
<span class="red">before_after </span>=><span class="green"> "after";</span>
}
</pre>

<div class="node">
<a name="Deleting-lines-exception"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Editing-files">Editing files</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Deleting-lines-from-a-file">Deleting lines from a file</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.28 Deleting lines exception</h3>

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Simple test editfile
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="comment">#
</span>
<span class="comment"># This assumes a file format like:
</span>
<span class="comment">#
</span>
<span class="comment"># [section 1]
</span>
<span class="comment">#
</span>
<span class="comment"># lines....
</span>
<span class="comment">#
</span>
<span class="comment"># [section 2]
</span>
<span class="comment">#
</span>
<span class="comment"># lines... etc
</span>


<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle" };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/tmp/passwd_excerpt"

<span class="red">       create    </span>=><span class="green"> "true",</span>
<span class="red">       edit_line </span>=><span class="blue"> MarkNRoot;</span>
}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">MarkNRoot</span>
  {
<span class="red">  delete_lines:
</span>
       "mark.*|root.*"<span class="red"> not_matching </span>=><span class="green"> "true";</span>

  }

</pre>

<!--  -->
<div class="node">
<a name="Editing-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Editing-tabular-files">Editing tabular files</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Deleting-lines-exception">Deleting lines exception</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.29 Editing files</h3>

<p>This is a huge topic. See also See <a href="#Add-lines-to-a-file">Add lines to a file</a>, See <a href="#Editing-tabular-files">Editing tabular files</a>, etc. 
Editing a file can be complex or simple, depending on needs.

   <p>Here is an example of how to comment out lines matching a number of patterns:
<pre class="verbatim">######################################################################
<span class="comment">#
</span>
<span class="comment"># Comment lines
</span>
<span class="comment">#
</span>
<span class="comment">######################################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">version         </span>=><span class="green">   "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "testbundle"  };
<span class="red">inputs          </span>=> { "cf_std_library.cf" };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">vars:
</span>
  "patterns"<span class="red"> slist </span>=> { "finger.*", "echo.*", "exec.*", "rstat.*", 
                                               "uucp.*", "talk.*" };

<span class="red">files:
</span>
  "/etc/inetd.conf"

<span class="red">      edit_line </span>=><span class="blue"> comment_lines_matching("@(testbundle.patterns)","#");</span>
}

</pre>

<!--  -->
<div class="node">
<a name="Editing-tabular-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Environment-_0028virtual_0029">Environment (virtual)</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Editing-files">Editing files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.30 Editing tabular files</h3>

<pre class="verbatim">
<span class="comment">######################################################################
</span>
<span class="comment">#
</span>
<span class="comment"># File editing
</span>
<span class="comment">#
</span>
<span class="comment"># Normal ordering:
</span>
<span class="comment"># - delete
</span>
<span class="comment"># - replace | colum_edit
</span>
<span class="comment"># - insert
</span>
<span class="comment"># 
</span>
<span class="comment">######################################################################
</span>


<span class="red">body common control
</span>
{
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">vars:
</span>
 "userset"<span class="red"> slist </span>=> { "one-x", "two-x", "three-x" };

<span class="red">files:
</span>
<span class="comment">  # Make a copy of the password file
</span>

  "/home/mark/tmp/passwd"

<span class="red">       create    </span>=><span class="green"> "true",</span>
<span class="red">       edit_line </span>=><span class="blue"> SetUserParam("mark","6","/set/this/shell");</span>

  "/home/mark/tmp/group"

<span class="red">       create    </span>=><span class="green"> "true",</span>
<span class="red">       edit_line </span>=><span class="blue"> AppendUserParam("root","4","@(userset)");</span>

<span class="red">commands:
</span>
  "/bin/echo"<span class="red"> args </span>=><span class="green"> "$(userset)";</span>

}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">SetUserParam(user,field,val)</span>
  {
<span class="red">  field_edits:
</span>
<span class="red">   "$(user):.*"
</span>
<span class="comment">      # Set field of the file to parameter
</span>

<span class="red">      edit_field </span>=><span class="blue"> col(":","$(field)","$(val)","set");</span>
  }

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">AppendUserParam(user,field,allusers)</span>
  {
<span class="red">  vars:
</span>
    "val"<span class="red"> slist </span>=> { @(allusers) };

<span class="red">  field_edits:
</span>
<span class="red">   "$(user):.*"
</span>
<span class="comment">      # Set field of the file to parameter
</span>

<span class="red">      edit_field </span>=><span class="blue"> col(":","$(field)","$(val)","alphanum");</span>

  }

<span class="comment">########################################
</span>
<span class="comment"># Bodies
</span>
<span class="comment">########################################
</span>

<span class="red">body edit_field</span> <span class="blue">col(split,col,newval,method)</span>

{
<span class="red">field_separator </span>=><span class="green"> "$(split)";</span>
<span class="red">select_field    </span>=><span class="green"> "$(col)";</span>
<span class="red">value_separator  </span>=><span class="green"> ",";</span>
<span class="red">field_value     </span>=><span class="green"> "$(newval)";</span>
<span class="red">field_operation </span>=><span class="green"> "$(method)";</span>
<span class="red">extend_fields </span>=><span class="green"> "true";</span>
}


</pre>

<ul class="menu">
<li><a accesskey="1" href="#Environment-_0028virtual_0029">Environment (virtual)</a>
<li><a accesskey="2" href="#Environment-variables">Environment variables</a>
<li><a accesskey="3" href="#Execresult-example">Execresult example</a>
<li><a accesskey="4" href="#Inserting-lines-in-a-file">Inserting lines in a file</a>
<li><a accesskey="5" href="#Get-a-list-of-users">Get a list of users</a>
<li><a accesskey="6" href="#Global-classes">Global classes</a>
<li><a accesskey="7" href="#Hello-world">Hello world</a>
<li><a accesskey="8" href="#LDAP-interactions">LDAP interactions</a>
<li><a accesskey="9" href="#Linking-files">Linking files</a>
<li><a href="#Listing-files_002dpattern-in-a-directory">Listing files-pattern in a directory</a>
<li><a href="#Locate-and-transform-files">Locate and transform files</a>
<li><a href="#Logging">Logging</a>
<li><a href="#Measurements">Measurements</a>
<li><a href="#Methods">Methods</a>
<li><a href="#Method-validation">Method validation</a>
<li><a href="#Mount-NFS-filesystem">Mount NFS filesystem</a>
</ul>

<div class="node">
<a name="Environment-(virtual)"></a>
<a name="Environment-_0028virtual_0029"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Environment-variables">Environment variables</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Editing-tabular-files">Editing tabular files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.31 Environments (virtual)</h3>

<pre class="verbatim">
<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Virtual environments
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "my_vm_cloud" };   
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">my_vm_cloud</span>

{
<span class="red">vars:
</span>
  "vms[atlas]"<span class="red"> slist </span>=> { "guest1", "guest2", "guest3" };

<span class="red">environments:
</span>
 scope||any::  # These should probably be in class "any" to ensure uniqueness

   "$(vms[$(sys.host)])"

<span class="red">       environment_resources </span>=><span class="blue"> virt_xml("$(xmlfile[$(this.promiser)])"),</span>
<span class="red">       environment_interface </span>=><span class="blue"> vnet("eth0,192.168.1.100/24"),</span>
<span class="red">       environment_type      </span>=><span class="green"> "test",</span>
<span class="red">       environment_host      </span>=><span class="green"> "atlas";</span>

<span class="comment">      # default environment_state => "create" on host, and "suspended elsewhere"
</span>
}

<span class="comment">#######################################################
</span>

<span class="red">body environment_resources</span> <span class="blue">virt_xml(specfile)</span>
{
<span class="red">env_spec_file </span>=><span class="green"> "$(specfile)";</span>
}

<span class="comment">#######################################################
</span>

<span class="red">body environment_interface</span> <span class="blue">vnet(primary)</span>
{
<span class="red">env_name      </span>=><span class="green"> "$(this.promiser)";</span>
<span class="red">env_addresses </span>=> { "$(primary)" };

host1::

<span class="red">  env_network </span>=><span class="green"> "default_vnet1";</span>

host2::

<span class="red">  env_network </span>=><span class="green"> "default_vnet2";</span>

}
</pre>

<div class="node">
<a name="Environment-variables"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Execresult-example">Execresult example</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Environment-_0028virtual_0029">Environment (virtual)</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.32 Environment variables</h3>

<pre class="verbatim"></pre>

<pre class="verbatim">
<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Virtual environments
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "my_vm_cloud" };   
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">my_vm_cloud</span>

{
<span class="red">environments:
</span>
   "centos5"

<span class="red">       environment_resources </span>=><span class="blue"> virt_xml,</span>
<span class="red">       environment_type      </span>=><span class="green"> "xen",</span>
<span class="red">       environment_host      </span>=><span class="green"> "ursa-minor";</span>

<span class="comment">      # default environment_state => "create" on host, and "suspended elsewhere"
</span>
}

<span class="comment">#######################################################
</span>

<span class="red">body environment_resources</span> <span class="blue">virt_xml</span>
{
<span class="red">env_spec_file </span>=><span class="green"> "/srv/xen/centos5-libvirt-create.xml";</span>
}

</pre>

<div class="node">
<a name="Execresult-example"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Inserting-lines-in-a-file">Inserting lines in a file</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Environment-variables">Environment variables</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.33 Execresult example</h3>

<pre class="verbatim">

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "example" };
}

<span class="comment">###########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">example</span>

{     
<span class="red">vars:
</span>
  "my_result"<span class="red"> string </span>=> execresult("/bin/ls /tmp","noshell");

<span class="red">reports:
</span>
  linux::

    "Variable is $(my_result)";

}

</pre>

<!--  -->
<div class="node">
<a name="Inserting-lines-in-a-file"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Get-a-list-of-users">Get a list of users</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Execresult-example">Execresult example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.34 Inserting lines in a file</h3>

<pre class="verbatim">

<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Insert a number of lines with vague whitespace
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
any::

<span class="red">  bundlesequence  </span>=> { "insert" };   
}


<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">insert</span>

{
<span class="red">vars:
</span>
  "v"<span class="red"> string </span>=><span class="green"> "  One potato";</span>
 
<span class="red">files:
</span>
  "/tmp/test_insert"

<span class="red">            create </span>=><span class="green"> "true",</span>
<span class="red">         edit_line </span>=><span class="blue"> Insert("$(insert.v)");</span>

}

<span class="comment">#######################################################
</span>
<span class="comment"># For the library
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">Insert(name)</span>

{
<span class="red">insert_lines:
</span>
  "  $(name)"

<span class="red">      whitespace_policy </span>=> { "ignore_leading", "ignore_embedded" };

}

<span class="comment">#######################################################
</span>

<span class="red">body edit_defaults</span> <span class="blue">empty</span>

{
<span class="red">empty_file_before_editing </span>=><span class="green"> "true";</span>
}
</pre>

<pre class="verbatim">

<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Insert a number of lines
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
any::

<span class="red">  bundlesequence  </span>=> { "insert" };   
}


<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">insert</span>

{
<span class="red">vars:
</span>
  "v"<span class="red"> string </span>=><span class="green"> "</span>
                One potato
                Two potato
                Three potatoe
                Four
                ";
 
<span class="red">files:
</span>
  "/tmp/test_insert"

<span class="red">            create </span>=><span class="green"> "true",</span>
<span class="red">         edit_line </span>=><span class="blue"> Insert("$(insert.v)"),</span>
<span class="red">     edit_defaults </span>=><span class="blue"> empty;</span>

}

<span class="comment">#######################################################
</span>
<span class="comment"># For the library
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">Insert(name)</span>

{
<span class="red">insert_lines:
</span>
  "Begin$(const.n)$(name)$(const.n)End";

}

<span class="comment">#######################################################
</span>

<span class="red">body edit_defaults</span> <span class="blue">empty</span>

{
<span class="red">empty_file_before_editing </span>=><span class="green"> "false";</span>
}
</pre>

<pre class="verbatim">

<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Insert a number of lines
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
any::

<span class="red">  bundlesequence  </span>=> { "insert" };   
}


<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">insert</span>

{
<span class="red">vars:
</span>
  "v"<span class="red"> slist </span>=> {
                "One potato",
                "Two potato",
                "Three potatoe",
                "Four"    
               };
 
<span class="red">files:
</span>
  "/tmp/test_insert"

<span class="red">            create </span>=><span class="green"> "true",</span>
<span class="red">         edit_line </span>=><span class="blue"> Insert("@(insert.v)");</span>
<span class="comment">   #  edit_defaults => empty;
</span>

}

<span class="comment">#######################################################
</span>
<span class="comment"># For the library
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">Insert(name)</span>

{
<span class="red">insert_lines:
</span>
  "$(name)";

}

<span class="comment">#######################################################
</span>

<span class="red">body edit_defaults</span> <span class="blue">empty</span>

{
<span class="red">empty_file_before_editing </span>=><span class="green"> "true";</span>
}
</pre>

<!--  -->
<div class="node">
<a name="Get-a-list-of-users"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Global-classes">Global classes</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Inserting-lines-in-a-file">Inserting lines in a file</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.35 Get a list of users</h3>

<pre class="verbatim">
<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># GetUsers
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
any::

<span class="red">  bundlesequence  </span>=> {
                     test
                     };   
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">test</span>

{
<span class="red">vars:
</span>
  "allusers"<span class="red"> slist </span>=> getusers("zenoss,mysql,at","12,0");

<span class="red">reports:
</span>
 linux::

  "Found user $(allusers)";

}
</pre>

<div class="node">
<a name="Global-classes"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Hello-world">Hello world</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Get-a-list-of-users">Get a list of users</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.36 Global classes</h3>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "g","tryclasses_1", "tryclasses_2" };

}

<span class="comment">#################################
</span>

<span class="red">bundle common g
</span>{
<span class="red">classes:
</span>
  "one"<span class="red"> expression </span>=><span class="green"> "any";</span>

  "client_network"<span class="red"> expression </span>=> iprange("128.39.89.0/24");
}

<span class="comment">#################################
</span>

<span class="red">bundle agent</span> <span class="blue">tryclasses_1</span>
{
<span class="red">classes:
</span>
  "two"<span class="red"> expression </span>=><span class="green"> "any";</span>
}

<span class="comment">#################################
</span>

<span class="red">bundle agent</span> <span class="blue">tryclasses_2</span>
{
<span class="red">classes:
</span>
  "three"<span class="red"> expression </span>=><span class="green"> "any";</span>

<span class="red">reports:
</span>
  one.three.!two::

    "Success";
}


<span class="comment">#################################
</span>
</pre>

<!--  -->
<div class="node">
<a name="Hello-world"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#LDAP-interactions">LDAP interactions</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Global-classes">Global classes</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.37 Hello world</h3>

<pre class="verbatim">
<span class="comment"># Hard promises
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "hello" };
}

<span class="comment"># soft promises
</span>

<span class="red">bundle agent</span> <span class="blue">hello</span>
{
<span class="red">reports:
</span>
 linux::

   "Hello world!";
}
</pre>

<!--  -->
<div class="node">
<a name="LDAP-interactions"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Linking-files">Linking files</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Hello-world">Hello world</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.38 LDAP interactions</h3>

<pre class="verbatim">

<span class="comment">#
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "ldap" , "followup"};
}

<span class="comment">###################################################################################################
</span>
<span class="comment">#  NOTE!! relying on LDAP or other network data without validation is EXTREMELY dangerous. 
</span>
<span class="comment">#         You could destroy a system by assuming that the service will respond with a 
</span>
<span class="comment">#         sensible result. Cfengine does not recommend reliance on network services in configuration.
</span>
<span class="comment">###################################################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">ldap</span>
{
<span class="red">vars:
</span>
<span class="comment">   # Get the first matching value for "uid"
</span>

  "value"<span class="red"> string </span>=> ldapvalue("ldap://eternity.iu.hio.no","dc=cfengine,dc=com","(sn=User)","uid","subtree","none");

<span class="comment">   # Geta all matching values for "uid" - should be a single record match
</span>

  "list"<span class="red"> slist </span>=>  ldaplist("ldap://eternity.iu.hio.no","dc=cfengine,dc=com","(sn=User)","uid","subtree","none");

<span class="red">classes:
</span>
   "gotdata"<span class="red"> expression </span>=> ldaparray("myarray","ldap://eternity.iu.hio.no","dc=cfengine,dc=com","(uid=mark)","subtree","none");

   "found"<span class="red"> expression </span>=> regldap("ldap://eternity.iu.hio.no","dc=cfengine,dc=com","(sn=User)","uid","subtree","jon.*","none");

<span class="red">reports:
</span>
 linux::

   "LDAP VALUE $(value) found";
   "LDAP LIST VALUE $(list)";

 gotdata::

   "Found specific entry data  ...$(ldap.myarray[uid]),$(ldap.myarray[gecos]), etc";

  found::

    "Matched regex";

}

<span class="red">bundle agent</span> <span class="blue">followup</span>

{
<span class="red">reports:
</span>
 linux::

<span class="red">"Different bundle</span> <span class="blue">...$(ldap.myarray[uid]),$(ldap.myarray[gecos]),</span>

}
</pre>

<div class="node">
<a name="Linking-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Listing-files_002dpattern-in-a-directory">Listing files-pattern in a directory</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#LDAP-interactions">LDAP interactions</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.39 Linking files</h3>

<pre class="verbatim">
<span class="comment">######################################################################
</span>
<span class="comment">#
</span>
<span class="comment"># File editing
</span>
<span class="comment">#
</span>
<span class="comment"># Normal ordering:
</span>
<span class="comment"># - delete
</span>
<span class="comment"># - replace | colum_edit
</span>
<span class="comment"># - insert
</span>
<span class="comment"># 
</span>
<span class="comment">######################################################################
</span>


<span class="red">body common control
</span>
{
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
<span class="comment">  # Make a copy of the password file
</span>

  "/home/mark/tmp/passwd"

<span class="red">       link_from     </span>=><span class="blue"> linkdetails("/etc/passwd"),</span>
<span class="red">       move_obstructions </span>=><span class="green"> "true";</span>


  "/home/mark/tmp/linktest"

<span class="red">       link_from     </span>=><span class="blue"> linkchildren("/usr/local/sbin");</span>


<span class="comment">#child links
</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body link_from</span> <span class="blue">linkdetails(tofile)</span>

{
<span class="red">source        </span>=><span class="green"> "$(tofile)";</span>
<span class="red">link_type     </span>=><span class="green"> "symlink";</span>
<span class="red">when_no_source  </span>=><span class="green"> "force";      # kill</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body link_from</span> <span class="blue">linkchildren(tofile)</span>

{
<span class="red">source        </span>=><span class="green"> "$(tofile)";</span>
<span class="red">link_type     </span>=><span class="green"> "symlink";</span>
<span class="red">when_no_source  </span>=><span class="green"> "force";      # kill</span>
<span class="red">link_children </span>=><span class="green"> "true";</span>
<span class="red">when_linking_children </span>=><span class="green"> "if_no_such_file"; # "override_file";</span>
}


</pre>

<p>Removing deadlinks from a directory:
<pre class="verbatim">
<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Test dead link removal
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>   {
   any::

<span class="red">      bundlesequence  </span>=> { 
<span class="red">"testbundle" </span> <span class="blue"></span>
                         };
   }


<span class="comment">############################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/home/mark/tmp/test_to" -> "someone"

<span class="red">      depth_search </span>=><span class="blue"> recurse("inf"),</span>
<span class="red">      perms </span>=><span class="blue"> modestuff,</span>
<span class="red">      action </span>=><span class="blue"> tell_me;</span>

}

<span class="comment">############################################
</span>

<span class="red">body depth_search</span> <span class="blue">recurse(d)</span>

{
<span class="red">rmdeadlinks </span>=><span class="green"> "true";</span>
<span class="red">depth </span>=><span class="green"> "$(d)";</span>
}

<span class="comment">############################################
</span>

<span class="red">body perms</span> <span class="blue">modestuff</span>

{
<span class="red">mode </span>=><span class="green"> "o-w";</span>
}

<span class="comment">############################################
</span>

<span class="red">body action</span> <span class="blue">tell_me</span>

{
<span class="red">report_level </span>=><span class="green"> "inform";</span>
}
</pre>

<div class="node">
<a name="Listing-files-pattern-in-a-directory"></a>
<a name="Listing-files_002dpattern-in-a-directory"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Locate-and-transform-files">Locate and transform files</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Linking-files">Linking files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.40 Listing files-pattern in a directory</h3>

<pre class="verbatim">

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "example" };
}

<span class="comment">###########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">example</span>

{     
<span class="red">vars:
</span>
  "ls"<span class="red"> slist </span>=><span class="blue"> lsdir("/etc","p.*","true");</span>

<span class="red">reports:
</span>
  !sdfkjh::

<span class="red">    "ls: $(ls)";
</span>
}


</pre>

<div class="node">
<a name="Locate-and-transform-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Logging">Logging</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Listing-files_002dpattern-in-a-directory">Listing files-pattern in a directory</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.41 Locate and transform files</h3>

<pre class="verbatim">
<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Compressing files
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>   {
   any::

<span class="red">      bundlesequence  </span>=> { 
<span class="red">"testbundle" </span> <span class="blue"></span>
                         };

<span class="red">   version </span>=><span class="green"> "1.2.3";</span>
   }

<span class="comment">############################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/home/mark/tmp/testcopy" 

<span class="red">    file_select </span>=><span class="blue"> pdf_files,</span>
<span class="red">    transformer </span>=><span class="green"> "/usr/bin/gzip $(this.promiser)",</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>

}

<span class="comment">############################################
</span>

<span class="red">body file_select</span> <span class="blue">pdf_files</span>

{
<span class="red">leaf_name </span>=> { ".*.pdf" , ".*.fdf" };
<span class="red">file_result </span>=><span class="green"> "leaf_name";</span>
}

<span class="comment">############################################
</span>

<span class="red">body depth_search</span> <span class="blue">recurse(d)</span>

{
<span class="red">depth </span>=><span class="green"> "$(d)";</span>
}

</pre>

<div class="node">
<a name="Logging"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Measurements">Measurements</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Locate-and-transform-files">Locate and transform files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.42 Logging</h3>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "test" };
}

<span class="red">bundle agent</span> <span class="blue">test</span>
{
<span class="red">vars:
</span>
  "software"<span class="red"> slist </span>=> { "/root/xyz", "/tmp/xyz" };

<span class="red">files:
</span>
  "$(software)"

<span class="red">    create </span>=><span class="green"> "true",</span>
<span class="red">     action </span>=><span class="blue"> logme("$(software)");</span>

}

<span class="comment">#
</span>

<span class="red">body action</span> <span class="blue">logme(x)</span>
{
<span class="red">log_kept </span>=><span class="green"> "/tmp/private_keptlog.log";</span>
<span class="red">log_failed </span>=><span class="green"> "/tmp/private_faillog.log";</span>
<span class="red">log_repaired </span>=><span class="green"> "/tmp/private_replog.log";</span>
<span class="red">log_string </span>=><span class="green"> "$(sys.date) $(x) promise status";</span>
}
</pre>

<pre class="verbatim"></pre>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "one" };
}



<span class="red">bundle agent</span> <span class="blue">one</span>
{
<span class="red">files:
</span>
  "/tmp/xyz"

<span class="red">       create </span>=><span class="green"> "true",</span>
<span class="red">       action </span>=><span class="blue"> log;</span>

}

<span class="red">body action</span> <span class="blue">log</span>
{
<span class="red">log_level </span>=><span class="green"> "inform";</span>
}


</pre>

<!--  -->
<div class="node">
<a name="Measurements"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Methods">Methods</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Logging">Logging</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.43 Measurements</h3>

<pre class="verbatim"></pre>

<pre class="verbatim">
<span class="comment">#cop measurements,example
</span>

<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Test file:
</span>
<span class="comment">#
</span>
<span class="comment"># First line
</span>
<span class="comment"># Blonk blonk bnklkygsuilnm
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "report" };
}

<span class="comment">#######################################################
</span>

<span class="red">body monitor</span> <span class="blue">control</span>
{
<span class="red">forgetrate </span>=><span class="green"> "0.7";</span>
<span class="red">histograms </span>=><span class="green"> "true";</span>
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">report</span>
{
<span class="red">reports:
</span>
 cfengine_3::

   "
   Free memory read at $(mon.av_free_memory_watch)
   cf_monitord read $(mon.value_monitor_self_watch)   
   ";
}

<span class="comment">#######################################################
</span>

<span class="red">bundle monitor</span> <span class="blue">watch</span>
{
<span class="red">measurements:
</span>
<span class="comment">  # Test 1 - extract string matching
</span>

  "/home/mark/tmp/testmeasure"

<span class="red">      handle </span>=><span class="green"> "blonk_watch",</span>
<span class="red">      stream_type </span>=><span class="green"> "file",</span>
<span class="red">      data_type </span>=><span class="green"> "string",</span>
<span class="red">      history_type </span>=><span class="green"> "weekly",</span>
<span class="red">      units </span>=><span class="green"> "blonks",</span>
<span class="red">      match_value </span>=> find_blonks,
<span class="red">      action </span>=><span class="blue"> sample_min("10");</span>

<span class="comment">  # Test 2 - follow a special process over time
</span>
<span class="comment">  # using cfengine's process cache to avoid resampling
</span>

   "/var/cfengine/state/cf_rootprocs"

<span class="red">      handle </span>=><span class="green"> "monitor_self_watch",</span>
<span class="red">      stream_type </span>=><span class="green"> "file",</span>
<span class="red">      data_type </span>=><span class="green"> "int",</span>
<span class="red">      history_type </span>=><span class="green"> "static",</span>
<span class="red">      units </span>=><span class="green"> "kB",</span>
<span class="red">      match_value </span>=> proc_value(".*cf-monitord.*",
                                "root\s+[0-9.]+\s+[0-9.]+\s+[0-9.]+\s+[0-9.]+\s+([0-9]+).*");

<span class="comment">  # Test 3, discover disk device information
</span>

  "/bin/df"

<span class="red">      handle </span>=><span class="green"> "free_disk_watch",</span>
<span class="red">      stream_type </span>=><span class="green"> "pipe",</span>
<span class="red">      data_type </span>=><span class="green"> "slist",</span>
<span class="red">      history_type </span>=><span class="green"> "static",</span>
<span class="red">      units </span>=><span class="green"> "device",</span>
<span class="red">      match_value </span>=><span class="blue"> file_system;</span>
<span class="comment">      # Update this as often as possible
</span>

<span class="comment">  # Test 4
</span>

   "/tmp/file"

<span class="red">         handle </span>=><span class="green"> "line_counter",</span>
<span class="red">    stream_type </span>=><span class="green"> "file",</span>
<span class="red">      data_type </span>=><span class="green"> "counter",</span>
<span class="red">    match_value </span>=><span class="blue"> scanlines("MYLINE.*"),</span>
<span class="red">   history_type </span>=><span class="green"> "log";</span>

}

<span class="comment">##########################################################
</span>

<span class="red">body match_value</span> <span class="blue">scanlines(x)</span>
{
<span class="red">select_line_matching </span>=><span class="green"> "^$(x)$";</span>
}

<span class="comment">##########################################################
</span>

<span class="red">body action</span> <span class="blue">sample_min(x)</span>
{
<span class="red">ifelapsed </span>=><span class="green"> "$(x)";</span>
<span class="red">expireafter </span>=><span class="green"> "$(x)";</span>
}

<span class="comment">##########################################################
</span>

<span class="red">body match_value</span> <span class="blue">find_blonks</span>
{
<span class="red">select_line_number </span>=><span class="green"> "2";</span>
<span class="red">extraction_regex </span>=><span class="green"> "Blonk blonk ([blonk]+).*";</span>
}

<span class="comment">##########################################################
</span>

<span class="red">body match_value</span> <span class="blue">free_memory</span>
{
<span class="red">select_line_matching </span>=><span class="green"> "MemFree:.*";</span>
<span class="red">extraction_regex </span>=><span class="green"> "MemFree:\s+([0-9]+).*";</span>
}

<span class="comment">##########################################################
</span>

<span class="red">body match_value</span> <span class="blue">proc_value(x,y)</span>
{
<span class="red">select_line_matching </span>=><span class="green"> "$(x)";</span>
<span class="red">extraction_regex </span>=><span class="green"> "$(y)";</span>
}

<span class="comment">##########################################################
</span>

<span class="red">body match_value</span> <span class="blue">file_system</span>
{
<span class="red">select_line_matching </span>=><span class="green"> "/.*";</span>
<span class="red">extraction_regex </span>=><span class="green"> "(.*)";</span>
}

</pre>

<div class="node">
<a name="Methods"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Method-validation">Method validation</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Measurements">Measurements</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.44 Methods</h3>

<pre class="verbatim">

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };

<span class="red">version </span>=><span class="green"> "1.2.3";</span>
}

<span class="comment">###########################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>
{
<span class="red">vars:
</span>
 "userlist"<span class="red"> slist </span>=> { "mark", "jeang", "jonhenrik", "thomas", "eben" };

<span class="red">methods:
</span>
 "any"<span class="red"> usebundle </span>=><span class="blue"> subtest("$(userlist)");</span>

}

<span class="comment">###########################################
</span>

<span class="red">bundle agent</span> <span class="blue">subtest(user)</span>

{
<span class="red">commands:
</span>
 "/bin/echo Fix $(user)";

<span class="red">reports:
</span>
 linux::

  "Finished doing stuff for $(user)";
}

</pre>

<div class="node">
<a name="Method-validation"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Mount-NFS-filesystem">Mount NFS filesystem</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Methods">Methods</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.45 Method validation</h3>

<pre class="verbatim">

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };

<span class="red">version </span>=><span class="green"> "1.2.3";</span>
}

<span class="comment">###########################################
</span>

<span class="red">body agent</span> <span class="blue">control</span>

{
<span class="red">abortbundleclasses </span>=> { "invalid" };
}

<span class="comment">###########################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>
{
<span class="red">vars:
</span>
 "userlist"<span class="red"> slist </span>=> { "xyz", "mark", "jeang", "jonhenrik", "thomas", "eben" };

<span class="red">methods:
</span>
 "any"<span class="red"> usebundle </span>=><span class="blue"> subtest("$(userlist)");</span>

}

<span class="comment">###########################################
</span>

<span class="red">bundle agent</span> <span class="blue">subtest(user)</span>

{
<span class="red">classes:
</span>
  "invalid"<span class="red"> not </span>=> regcmp("[a-z][a-z][a-z][a-z]","$(user)");

<span class="red">reports:
</span>
 !invalid::

  "User name $(user) is valid at 4 letters";

 invalid::

  "User name $(user) is invalid";
}
</pre>

<div class="node">
<a name="Mount-NFS-filesystem"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Ordering-promises">Ordering promises</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Method-validation">Method validation</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.46 Mount NFS filesystem</h3>

<pre class="verbatim">

<span class="comment">#
</span>
<span class="comment"># cfengine 3
</span>
<span class="comment">#
</span>
<span class="comment"># cf-agent -f ./cftest.cf -K
</span>
<span class="comment">#
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence </span>=> { "mounts" };
}

<span class="comment">#
</span>

<span class="red">bundle agent</span> <span class="blue">mounts</span>

{
<span class="red">storage:
</span>
  "/mnt"<span class="red"> mount  </span>=><span class="blue"> nfs("slogans.iu.hio.no","/home");</span>

}

<span class="comment">######################################################################
</span>

<span class="red">body mount</span> <span class="blue">nfs(server,source)</span>

{
<span class="red">mount_type </span>=><span class="green"> "nfs";</span>
<span class="red">mount_source </span>=><span class="green"> "$(source)";</span>
<span class="red">mount_server </span>=><span class="green"> "$(server)";</span>
<span class="comment">#mount_options => { "rw" };
</span>
<span class="red">edit_fstab </span>=><span class="green"> "true";</span>
<span class="red">unmount </span>=><span class="green"> "true";</span>
}
</pre>

<div class="node">
<a name="Ordering-promises"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Process-management">Process management</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Mount-NFS-filesystem">Mount NFS filesystem</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.47 Ordering promises</h3>

<p>This counts to five by default. If we change &lsquo;<samp><span class="samp">/bin/echo one</span></samp>&rsquo;
to &lsquo;<samp><span class="samp">/bin/echox one</span></samp>&rsquo;, then the command will fail, causing us
to skip five and go to six instead.

   <p>This shows how dependencies can be chained in spite of the
order of promises in the bundle.

   <p>Normally the order of promises in a bundle is followed, within each
promise type, and the types are ordered according to <i>normal
ordering</i>.

<pre class="verbatim">
<span class="comment">##################################################################
</span>
<span class="comment">#
</span>
<span class="comment"># cfengine 3 - ordering promises into dependent chains
</span>
<span class="comment">#
</span>
<span class="comment">##
</span>
<span class="comment">#
</span>
<span class="comment"># cf-agent -f ./cftest.cf -K
</span>
<span class="comment">#
</span>
<span class="comment">##################################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence </span>=> { "order" };
}

<span class="comment">##################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">order</span>

{
<span class="red">vars:
</span>
 "list"<span class="red"> slist </span>=> { "three", "four" };

<span class="red">commands:
</span>
 ok_later::

   "/bin/echo five";

 otherthing::

   "/bin/echo six";

 any::


  "/bin/echo one"<span class="red">     classes </span>=><span class="blue"> d("ok_later","otherthing");</span>
  "/bin/echo two";
  "/bin/echo $(list)";

 preserved_class::

  "/bin/echo seven";

}

<span class="comment">############################################
</span>

<span class="red">body classes</span> <span class="blue">d(if,else)</span>

{
<span class="red">promise_repaired </span>=> { "$(if)" };
<span class="red">repair_failed </span>=> { "$(else)" };
<span class="red">persist_time </span>=><span class="green"> "0";</span>
}
</pre>

<!--  -->
<ul class="menu">
<li><a accesskey="1" href="#Process-management">Process management</a>
<li><a accesskey="2" href="#Read-from-a-TCP-socket">Read from a TCP socket</a>
<li><a accesskey="3" href="#Resolver-management">Resolver management</a>
<li><a accesskey="4" href="#Search-and-replace-text">Search and replace text</a>
<li><a accesskey="5" href="#Selecting-a-region-in-a-file">Selecting a region in a file</a>
<li><a accesskey="6" href="#Service-management-_0028windows_0029">Service management (windows)</a>
</ul>

<div class="node">
<a name="Process-management"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Read-from-a-TCP-socket">Read from a TCP socket</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Ordering-promises">Ordering promises</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.48 Process management</h3>

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "test" };
}



<span class="red">bundle agent</span> <span class="blue">test</span>
{
<span class="red">processes:
</span>
 "sleep"

<span class="red">   signals </span>=> { "term", "kill" };

}
</pre>

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Simple test processes 
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">processes:
</span>
 "sleep"

<span class="red">    process_count   </span>=><span class="blue"> up("sleep");</span>

<span class="red">reports:
</span>
 sleep_out_of_control::

   "Out of control";
}

<span class="comment">########################################################
</span>

<span class="red">body process_count</span> <span class="blue">up(s)</span>

{
<span class="red">match_range </span>=><span class="green"> "5,10"; # or irange("1","10");</span>
<span class="red">out_of_range_define </span>=> { "$(s)_out_of_control" };
}

</pre>

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Simple test processes 
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">processes:
</span>
 ".*"

<span class="red">    process_select  </span>=><span class="blue"> proc_finder("a.*"),</span>
<span class="red">    process_count   </span>=><span class="blue"> up("cfservd");</span>
}

<span class="comment">########################################################
</span>

<span class="red">body process_count</span> <span class="blue">up(s)</span>

{
<span class="red">match_range </span>=><span class="green"> "1,10"; # or irange("1","10");</span>
<span class="red">out_of_range_define </span>=> { "$(s)_out_of_control" };
}

<span class="comment">########################################################
</span>

<span class="red">body process_select</span> <span class="blue">proc_finder(p)</span>

{
<span class="red">stime_range </span>=> irange(ago("0","0","0","2","0","0"),now);
<span class="red">process_result </span>=><span class="green"> "stime";</span>
}


</pre>

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Simple test processes 
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">processes:
</span>
 ".*"

<span class="red">    process_select  </span>=><span class="blue"> proc_finder("a.*"),</span>
<span class="red">    process_count   </span>=><span class="blue"> up("cfservd");</span>
}

<span class="comment">########################################################
</span>

<span class="red">body process_count</span> <span class="blue">up(s)</span>

{
<span class="red">match_range </span>=><span class="green"> "1,10"; # or irange("1","10");</span>
<span class="red">out_of_range_define </span>=> { "$(s)_out_of_control" };
}

<span class="comment">########################################################
</span>

<span class="red">body process_select</span> <span class="blue">proc_finder(p)</span>

{
<span class="red">process_owner  </span>=> { "avahi", "bin" };
<span class="red">command        </span>=><span class="green"> "$(p)";</span>
<span class="red">pid            </span>=><span class="green"> "100,199";</span>
<span class="red">vsize          </span>=><span class="green"> "0,1000";</span>
<span class="red">process_result </span>=><span class="green"> "command.(process_owner|vsize)";</span>
}


</pre>

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "process_restart" };
}

<span class="comment">#########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">process_restart</span>
{
<span class="red">processes:
</span>
  "/usr/bin/daemon" 
<span class="red">        restart_class </span>=><span class="green"> "launch";</span>

<span class="red">commands:
</span>
  launch::

   "/usr/bin/daemon";

}
</pre>

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "process_restart" };
}

<span class="comment">#########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">process_restart</span>
{
<span class="red">vars:
</span>
  "component"<span class="red"> slist </span>=> {
                       "cf-monitord", 
                       "cf-serverd", 
                       "cf-execd" 
                       };
<span class="red">processes:
</span>
  "$(component)" 
<span class="red">        restart_class </span>=> canonify("start_$(component)");

<span class="red">commands:
</span>
   "/var/cfengine/bin/$(component)"
<span class="red">       ifvarclass </span>=> canonify("start_$(component)");

}
</pre>

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Simple test process restart
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">processes:
</span>
 "cfservd"

<span class="red">        process_count   </span>=><span class="blue"> up("cfservd");</span>

 cfservd_out_of_control::

   "cfservd"

<span class="red">        signals         </span>=> { "stop" , "term" },
<span class="red">        restart_class   </span>=><span class="green"> "start_cfserv";</span>


<span class="red">commands:
</span>
  start_cfserv::

    "/usr/local/sbin/cfservd";

}

<span class="comment">########################################################
</span>

<span class="red">body process_count</span> <span class="blue">up(s)</span>

{
<span class="red">match_range </span>=><span class="green"> "1,10"; # or irange("1","10");</span>
<span class="red">out_of_range_define </span>=> { "$(s)_out_of_control" };
}
</pre>

<!--  -->
<div class="node">
<a name="Read-from-a-TCP-socket"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Resolver-management">Resolver management</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Process-management">Process management</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.49 Read from a TCP socket</h3>

<pre class="verbatim">


<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "example" };
}

<span class="comment">###########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">example</span>

{     
<span class="red">vars:
</span>
  "my80"<span class="red"> string </span>=> readtcp("research.iu.hio.no","80","GET /index.php HTTP/1.1$(const.r)$(const.n)Host: research.iu.hio.no$(const.r)$(const.n)$(const.r)$(const.n)",20);

<span class="red">classes:
</span>
  "server_ok"<span class="red"> expression </span>=> regcmp(".*200 OK.*\n.*","$(my80)");

<span class="red">reports:
</span>
  server_ok::

    "Server is alive";

  !server_ok::

    "Server is not responding - got $(my80)";
}


</pre>

<div class="node">
<a name="Resolver-management"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Search-and-replace-text">Search and replace text</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Read-from-a-TCP-socket">Read from a TCP socket</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.50 Resolver management</h3>

<pre class="verbatim">
<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Resolve conf
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle common g # globals
</span>{
<span class="red">vars:
</span>
 "searchlist"<span class="red">  slist </span>=> { 
                        "search iu.hio.no", 
                        "search cfengine.com" 
                        };

 "nameservers"<span class="red"> slist </span>=> { 
                        "128.39.89.10", 
                        "128.39.74.16",
                        "192.168.1.103"
                        };
<span class="red">classes:
</span>
  "am_name_server"<span class="red"> expression </span>=> reglist("@(nameservers)","$(sys.ipv4[eth1])");
}

<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
any::

<span class="red">  bundlesequence  </span>=> {
                     "g",
                     resolver(@(g.searchlist),@(g.nameservers))
                     };   

<span class="red">  domain </span>=><span class="green"> "iu.hio.no";</span>
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">resolver(s,n)</span>

{
<span class="red">files:
</span>
<span class="comment">  # When passing parameters down, we have to refer to
</span>
<span class="comment">  # a source context
</span>

  "$(sys.resolv)"  # test on "/tmp/resolv.conf" #

<span class="red">      create        </span>=><span class="green"> "true",</span>
<span class="red">      edit_line     </span>=><span class="blue"> doresolv("@(this.s)","@(this.n)"),</span>
<span class="red">      edit_defaults </span>=> reconstruct;
<span class="comment"> # or edit_defaults => modify
</span>
}

<span class="comment">#######################################################
</span>
<span class="comment"># For the library
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">doresolv(s,n)</span>

{
<span class="red">vars:
</span>
 "line"<span class="red"> slist </span>=> { @(s), @(n) };

<span class="red">insert_lines:
</span>
  "$(line)";

}

<span class="comment">#######################################################
</span>

<span class="red">body edit_defaults</span> <span class="blue">reconstruct</span>
{
<span class="red">empty_file_before_editing </span>=><span class="green"> "true";</span>
<span class="red">edit_backup </span>=><span class="green"> "false";</span>
<span class="red">max_file_size </span>=><span class="green"> "100000";</span>
}

<span class="comment">#######################################################
</span>

<span class="red">body edit_defaults</span> <span class="blue">modify</span>
{
<span class="red">empty_file_before_editing </span>=><span class="green"> "false";</span>
<span class="red">edit_backup </span>=><span class="green"> "false";</span>
<span class="red">max_file_size </span>=><span class="green"> "100000";</span>
}


</pre>

<!--  -->
<div class="node">
<a name="Search-and-replace-text"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Selecting-a-region-in-a-file">Selecting a region in a file</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Resolver-management">Resolver management</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.51 Search and replace text</h3>

<pre class="verbatim">
<span class="comment">######################################################################
</span>
<span class="comment">#
</span>
<span class="comment"># File editing
</span>
<span class="comment">#
</span>
<span class="comment"># Normal ordering:
</span>
<span class="comment"># - delete
</span>
<span class="comment"># - replace | colum_edit
</span>
<span class="comment"># - insert
</span>
<span class="comment"># 
</span>
<span class="comment">######################################################################
</span>


<span class="red">body common control
</span>
{
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{

<span class="red">files:
</span>
  "/tmp/replacestring"

<span class="red">       create    </span>=><span class="green"> "true",</span>
<span class="red">       edit_line </span>=> myedit("second");
}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">myedit(parameter)</span>
  {
<span class="red">  vars:
</span>
   "edit_variable"<span class="red"> string </span>=><span class="green"> "private edit variable is $(parameter)"; </span>

  
<span class="red">  replace_patterns:
</span>
<span class="comment">  # replace shell comments with C comments
</span>

   "puppet"

<span class="red">      replace_with </span>=><span class="blue"> With("cfengine 3");</span>

  }

<span class="comment">########################################
</span>
<span class="comment"># Bodies
</span>
<span class="comment">########################################
</span>

<span class="red">body replace_with</span> <span class="blue">With(x)</span>

{
<span class="red">replace_value </span>=><span class="green"> "$(x)";</span>
<span class="red">occurrences </span>=><span class="green"> "first";</span>
}

<span class="comment">########################################
</span>

<span class="red">body select_region</span> <span class="blue">MySection(x)</span>

{
<span class="red">select_start </span>=><span class="green"> "\[$(x)\]";</span>
<span class="red">select_end </span>=><span class="green"> "\[.*\]";</span>
}

</pre>

<div class="node">
<a name="Selecting-a-region-in-a-file"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Service-management-_0028windows_0029">Service management (windows)</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Search-and-replace-text">Search and replace text</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.52 Selecting a region in a file</h3>

<pre class="verbatim">

<span class="red">body common control
</span>
{
<span class="red">version </span>=><span class="green"> "1.2.3";</span>
<span class="red">bundlesequence  </span>=> { "testbundle"  };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{

<span class="red">files:
</span>
  "/tmp/testfile"

<span class="red">       create    </span>=><span class="green"> "true",</span>
<span class="red">       edit_line </span>=> myedit("second");
}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">myedit(parameter)</span>
  {
<span class="red">  vars:
</span>
   "edit_variable"<span class="red"> string </span>=><span class="green"> "private edit variable is $(parameter)"; </span>

  
<span class="red">  replace_patterns:
</span>
<span class="comment">  # comment out lines after start
</span>

   "([^#].*)"

<span class="red">      replace_with </span>=><span class="blue"> comment,</span>
<span class="red">     select_region </span>=><span class="blue"> ToEnd("Start.*");</span>

  }

<span class="comment">########################################
</span>
<span class="comment"># Bodies
</span>
<span class="comment">########################################
</span>

<span class="red">body replace_with</span> <span class="blue">comment</span>

{
<span class="red">replace_value </span>=><span class="green"> "# $(match.1)"; # backreference 0</span>
<span class="red">occurrences </span>=><span class="green"> "all";  # first, last all</span>
}

<span class="comment">########################################################
</span>

<span class="red">body select_region</span> <span class="blue">ToEnd(x)</span>

{
<span class="red">select_start </span>=><span class="green"> "$(x)";</span>
}
</pre>

<div class="node">
<a name="Service-management-(windows)"></a>
<a name="Service-management-_0028windows_0029"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Set-up-a-PXE-boot-server">Set up a PXE boot server</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Selecting-a-region-in-a-file">Selecting a region in a file</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.53 Service management (windows)</h3>

<pre class="verbatim">
<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "winservice" };
}

<span class="comment">###########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">winservice</span>

{
<span class="red">vars:
</span>
  "bad_services"<span class="red"> slist </span>=> { "Alerter",  "ClipSrv" };

<span class="red">services:
</span>
 windows::

  "$(bad_services)"

<span class="red">       service_policy </span>=><span class="green"> "disable",</span>
<span class="red">       comment </span>=><span class="green"> "Disable services that create security issues";</span>
}
</pre>

<pre class="verbatim"></pre>

<div class="node">
<a name="Set-up-a-PXE-boot-server"></a>
<p><hr>
<span class="red">Next:&nbsp;<a rel="next" accesskey="n" href="#Tidying-garbage-files">Tidying garbage files</a>,
</span><span class="red">Previous:&nbsp;<a rel="previous" accesskey="p" href="#Service-management-_0028windows_0029">Service management (windows)</a>,
</span><span class="red">Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>
</span>
</div>

<h3 class="section">3.54 Set up a PXE boot server</h3>

<p>Use CFEngine to set up a PXE boot server.

<pre class="verbatim">body common control
{
<span class="red"> bundlesequence </span>=> { "pxe" };
<span class="red"> inputs </span>=> { "/var/cfengine/inputs/cfengine_stdlib.cf" };
}


<span class="comment">#
</span>
<span class="comment"># PXE boot server
</span>
<span class="comment">#
</span>


<span class="red">bundle agent</span> <span class="blue">pxe</span>
{
<span class="red">vars:
</span>
  "software"<span class="red"> slist </span>=> {
                      "atftp",
                      "dhcp-server",
                      "syslinux",
                      "apache2"
                      };


   "dirs"<span class="red"> slist </span>=> {
                   "/tftpboot",
                   "/tftpboot/CFEngine/rpm",
                   "/tftpboot/CFEngine/inputs",
                   "/tftpboot/pxelinux.cfg",
                   "/tftpboot/kickstart",
                   "/srv/www/repos"
                   };

   "tmp_location"<span class="red">    string </span>=><span class="green"> "/tftpboot/CFEngine/inputs";</span>

<span class="comment">   # Distros that we can install
</span>


   "rh_distros"<span class="red"> slist </span>=> { "4.7", "5.2" };
   "centos_distros"<span class="red"> slist </span>=> { "5.2" }; 

<span class="comment">   # File contents of atftp configuration
</span>


   "atftpd_conf"<span class="red"> string </span>=><span class="blue"></span>
       "
<span class="comment">###########################################
</span>

<span class="comment">### This file is protected by CFEngine. ###
</span>

<span class="comment">### Whatever you do, it will be changed ###
</span>

<span class="comment">###     back to a promising state.      ###
</span>

<span class="comment">###########################################
</span>


ATFTPD_OPTIONS=\"--daemon \"
ATFTPD_USE_INETD=\"no\"
ATFTPD_DIRECTORY=\"/tftpboot\"
ATFTPD_BIND_ADDRESSES=\"\"
       ";

<span class="comment">   # File contents of DHCP configuration
</span>


   "dhcpd"<span class="red"> string </span>=><span class="blue"></span>
       "
<span class="comment">###########################################
</span>

<span class="comment">### This file is protected by CFEngine. ###
</span>

<span class="comment">### Whatever you do, it will be changed ###
</span>

<span class="comment">###     back to a promising state.      ###
</span>

<span class="comment">###########################################
</span>


DHCPD_INTERFACE=\"eth0\"
DHCPD_RUN_CHROOTED=\"yes\"
DHCPD_CONF_INCLUDE_FILES=\"\"
DHCPD_RUN_AS=\"dhcpd\"
DHCPD_OTHER_ARGS=\"\"
DHCPD_BINARY=\"\"
       ";

   "dhcpd_conf"<span class="red"> string </span>=><span class="blue"></span>
       "
<span class="comment">###########################################
</span>

<span class="comment">### This file is protected by CFEngine. ###
</span>

<span class="comment">### Whatever you do, it will be changed ###
</span>

<span class="comment">###     back to a promising state.      ###
</span>

<span class="comment">###########################################
</span>


allow booting;
allow bootp;
ddns-update-style none; ddns-updates off;
 subnet 192.168.0.0 netmask 255.255.255.0 {
   range 192.168.0.20 192.168.0.254;
   default-lease-time 3600;
   max-lease-time 4800;
   option routers 192.168.0.1;
   option domain-name \"test.CFEngine.com\";
   option domain-name-servers 192.168.0.1;
   next-server 192.168.0.1;
   filename \"pxelinux.0\";
 }
 group {
   host node1 {
<span class="comment">     # Dummy machine
</span>

<span class="red">     hardware ethernet 00:0F:1F:94:FE:07;
</span>     fixed-address 192.168.0.11;
     option host-name \"node1\";
   }
   host node2 {
<span class="comment">     # Dell Inspiron 1150
</span>

<span class="red">     hardware ethernet 00:0F:1F:0E:70:E7;
</span>     fixed-address 192.168.0.12;
     option host-name \"node2\";
   }
 }
        ";

<span class="comment">   # File contains of Apache2 HTTP configuration
</span>


   "httpd_conf"<span class="red"> string </span>=><span class="blue"></span>
        "
<span class="comment"># Repository for RHEL5
</span>

&lt;Directory /srv/www/repos>
Options Indexes 
AllowOverride None 
&lt;/Directory> 
Alias /repos /srv/www/repos

<span class="comment"># PXE boot server
</span>

&lt;Directory /tftpboot/distro/RHEL/5.2>
Options Indexes  
AllowOverride None  
&lt;/Directory>  
Alias /distro/rhel/5.2 /tftpboot/distro/RHEL/5.2

&lt;Directory /tftpboot/distro/RHEL/4.7>
Options Indexes   
AllowOverride None   
&lt;/Directory>   
Alias /distro/rhel/4.7 /tftpboot/distro/RHEL/4.7

&lt;Directory /tftpboot/distro/CentOS/5.2>
Options Indexes    
AllowOverride None    
&lt;/Directory>    
Alias /distro/centos/5.2 /tftpboot/distro/CentOS/5.2    

&lt;Directory /tftpboot/kickstart>
Options Indexes     
AllowOverride None     
&lt;/Directory>     
Alias /kickstart /tftpboot/kickstart

&lt;Directory /tftpboot/CFEngine>
Options Indexes      
AllowOverride None      
&lt;/Directory>      
Alias /CFEngine /tftpboot/CFEngine
        ";

<span class="comment">   # File contains of Kickstart for RHEL5 configuration
</span>


   "kickstart_rhel5_conf"<span class="red"> string </span>=><span class="blue"></span>
        "
<span class="comment">###########################################
</span>

<span class="comment">### This file is protected by CFEngine. ###
</span>

<span class="comment">### Whatever you do, it will be changed ###
</span>

<span class="comment">###     back to a promissing state.     ###
</span>

<span class="comment">###########################################
</span>

	
auth  --useshadow  --enablemd5 
bootloader --location=mbr
clearpart --all --initlabel 
graphical
firewall --disabled
firstboot --disable
key 77244a6377a8044a
keyboard no
lang en_US
logging --level=info
<span class="red">url --url=http://192.168.0.1/distro/rhel/5.2
</span>network --bootproto=dhcp --device=eth0 --onboot=on
reboot
rootpw --iscrypted $1$eOnXdDPF$279sQ//zry6rnQktkATeM0
selinux --disabled
timezone --isUtc Europe/Oslo
install
part swap --bytes-per-inode=4096 --fstype=\"swap\" --recommended
part / --bytes-per-inode=4096 --fstype=\"ext3\" --grow --size=1

%packages
@core
@base
db4-devel
openssl-devel
gcc
flex
bison
libacl-devel
libselinux-devel
pcre-devel
<span class="comment">#httpd
</span>

device-mapper-multipath
-sysreport

%post
cd /root
<span class="red">rpm -i http://192.168.0.1/CFEngine/rpm/CFEngine-3.0.1b1-1.el5.i386.rpm
</span><span class="comment">#/sbin/chkconfig httpd on
</span>

cd /etc/yum.repos.d
<span class="red">wget http://192.168.0.1/repos/RHEL5.Base.repo
</span>rpm --import /etc/pki/rpm-gpg/*
yum clean all
yum update
mkdir -p /root/CFEngine_init
cd /root/CFEngine_init
<span class="red">wget -nd -r http://192.168.0.1/CFEngine/inputs/
</span>/usr/local/sbin/cf-agent -B
/usr/local/sbin/cf-agent
        ";

<span class="comment">   # File contains of PXElinux boot menu
</span>


   "pxelinux_boot_menu"<span class="red"> string </span>=><span class="blue"></span>
        "
<span class="comment">###########################################
</span>

<span class="comment">### This file is protected by CFEngine. ###
</span>

<span class="comment">### Whatever you do, it will be changed ###
</span>

<span class="comment">###     back to a promissing state.     ###
</span>

<span class="comment">###########################################
</span>


<span class="red">boot options:
</span>     rhel5   - install 32 bit i386 RHEL 5.2             (MANUAL)
     rhel5w  - install 32 bit i386 RHEL 5.2             (AUTO)
     rhel4   - install 32 bit i386 RHEL 4.7 AS          (MANUAL)    
     centos5 - install 32 bit i386 CentOS 5.2 (Desktop) (MANUAL)
        ";
<span class="comment">   # File contains of PXElinux default configuration
</span>


   "pxelinux_default"<span class="red"> string </span>=><span class="blue"></span>
        "
<span class="comment">###########################################
</span>

<span class="comment">### This file is protected by CFEngine. ###
</span>

<span class="comment">### Whatever you do, it will be changed ###
</span>

<span class="comment">###     back to a promissing state.     ###
</span>

<span class="comment">###########################################
</span>

	
default rhel5
timeout 300
prompt 1
display pxelinux.cfg/boot.msg
F1 pxelinux.cfg/boot.msg

<span class="comment"># install i386 RHEL 5.2
</span>

label rhel5
   kernel vmlinuz-RHEL5U2
<span class="red">   append initrd=initrd-RHEL5U2 load_ramdisk=1 ramdisk_size=16384 install=http://192.168.0.1/distro/rhel/5.2
</span>
<span class="comment"># install i386 RHEL 5.2 using Kickstart
</span>

label rhel5w
   kernel vmlinuz-RHEL5U2
<span class="red">   append initrd=initrd-RHEL5U2 load_ramdisk=1 ramdisk_size=16384 ks=http://192.168.0.1/kickstart/kickstart-RHEL5U2.cfg
</span>
<span class="comment"># install i386 RHEL 4.7
</span>

label rhel4
   kernel vmlinuz-RHEL4U7
<span class="red">   append initrd=initrd-RHEL4U7 load_ramdisk=1 ramdisk_size=16384 install=http://192.168.0.1/distro/rhel/4.7
</span>
<span class="comment"># install i386 CentOS 5.2
</span>

label centos5
   kernel vmlinuz-CentOS5.2
<span class="red">   append initrd=initrd-CentOS5.2 load_ramdisk=1 ramdisk_size=16384 install=http://192.168.0.1/distro/centos/5.2
</span>        ";

<span class="comment">   # File contains of specified PXElinux default to be a RHEL5 webserver
</span>


   "pxelinux_rhel5_webserver"<span class="red"> string </span>=><span class="blue"></span>
        "
<span class="comment">###########################################
</span>

<span class="comment">### This file is protected by CFEngine. ###
</span>

<span class="comment">### Whatever you do, it will be changed ###
</span>

<span class="comment">###     back to a promissing state.     ###
</span>

<span class="comment">###########################################
</span>


<span class="comment"># install i386 RHEL 5.2 using Kickstart
</span>

default rhel5w
label rhel5w
   kernel vmlinuz-RHEL5U2
<span class="red">   append initrd=initrd-RHEL5U2 load_ramdisk=1 ramdisk_size=16384 ks=http://192.168.0.1/kickstart/kickstart-RHEL5U2.cfg
</span>        ";

<span class="comment">   # File contains of a local repository for RHEL5
</span>


   "rhel5_base_repo"<span class="red"> string </span>=><span class="blue"></span>
        "
<span class="comment">###########################################
</span>

<span class="comment">### This file is protected by CFEngine. ###
</span>

<span class="comment">### Whatever you do, it will be changed ###
</span>

<span class="comment">###     back to a promissing state.     ###
</span>

<span class="comment">###########################################
</span>


<span class="comment"># Local Repository
</span>

[Server]
name=Server
<span class="red">baseurl=http://192.168.0.1/repos/rhel5/Server/
</span>enable=1
[VT]
name=VT
<span class="red">baseurl=http://192.168.0.1/repos/rhel5/VT/
</span>enable=1
[Cluster]
name=Cluster
<span class="red">baseurl=http://192.168.0.1/repos/rhel5/Cluster/
</span>enable=1
[ClusterStorage]
name=Cluster Storage
<span class="red">baseurl=http://192.168.0.1/repos/rhel5/ClusterStorage/
</span>enable=1
        ";
<span class="comment">#####################################################
</span>



<span class="red">files:
</span>
 packages_ok::

<span class="comment">  # Create files/dirs and edit the new files
</span>


  "/tftpboot/distro/RHEL/$(rh_distros)/."
<span class="red">       create </span>=><span class="green"> "true";</span>

  "/tftpboot/distro/CentOS/$(centos_distros)/."
<span class="red">       create </span>=><span class="green"> "true";</span>

  "$(dirs)/."   
<span class="red">       create </span>=><span class="green"> "true";</span>

  "/tftpboot/pxelinux.cfg/boot.msg"
<span class="red">       create </span>=><span class="green"> "true",</span>
<span class="red">       perms </span>=><span class="blue"> mo("644","root"),</span>
<span class="red">       edit_line </span>=><span class="blue"> append_if_no_line("$(pxelinux_boot_menu)"),</span>
<span class="red">       edit_defaults </span>=><span class="blue"> empty;</span>

  "/tftpboot/pxelinux.cfg/default"
<span class="red">       create </span>=><span class="green"> "true",</span>
<span class="red">       perms </span>=><span class="blue"> mo("644","root"),</span>
<span class="red">       edit_line </span>=><span class="blue"> append_if_no_line("$(pxelinux_default)"),</span>
<span class="red">       edit_defaults </span>=><span class="blue"> empty;</span>

  "/tftpboot/pxelinux.cfg/default.RHEL5.webserver"
<span class="red">       create </span>=><span class="green"> "true",</span>
<span class="red">       perms </span>=><span class="blue"> mo("644","root"),</span>
<span class="red">       edit_line </span>=><span class="blue"> append_if_no_line("$(pxelinux_rhel5_webserver)"),</span>
<span class="red">       edit_defaults </span>=><span class="blue"> empty;</span>
  
  "/tftpboot/kickstart/kickstart-RHEL5U2.cfg"
<span class="red">       create </span>=><span class="green"> "true",</span>
<span class="red">       perms </span>=><span class="blue"> mo("644","root"),</span>
<span class="red">       edit_line </span>=> append_if_no_line("$(kickstart_rhel5_conf)"),
<span class="red">       edit_defaults </span>=><span class="blue"> empty;</span>

  "/srv/www/repos/RHEL5.Base.repo"
<span class="red">       create </span>=><span class="green"> "true",</span>
<span class="red">       perms </span>=><span class="blue"> mo("644","root"),</span>
<span class="red">       edit_line </span>=><span class="blue"> append_if_no_line("$(rhel5_base_repo)"),</span>
<span class="red">       edit_defaults </span>=><span class="blue"> empty;</span>

<span class="comment">  # Copy files
</span>


  "/tftpboot"

<span class="red">    copy_from </span>=><span class="blue"> local_cp("/usr/share/syslinux"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf"),</span>
<span class="red">    file_select </span>=><span class="blue"> pxelinux_files,</span>
<span class="red">    action </span>=><span class="blue"> immediate;</span>

  "$(tmp_location)"

<span class="red">    perms </span>=><span class="blue"> m("644"),</span>
<span class="red">    copy_from </span>=><span class="blue"> local_cp("/var/cfengine/inputs"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf"),</span>
<span class="red">    file_select </span>=><span class="blue"> input_files,</span>
<span class="red">    action </span>=><span class="blue"> immediate;</span>

<span class="comment">  # Edit atftp, dhcp and apache2 configurations
</span>


  "/etc/sysconfig/atftpd"
<span class="red">     edit_line </span>=> append_if_no_line("$(atftpd_conf)"),
<span class="red">     edit_defaults </span>=><span class="blue"> empty,</span>
<span class="red">     classes </span>=><span class="blue"> satisfied("atftpd_ready");</span>

  "/etc/sysconfig/dhcpd"
<span class="red">     edit_line </span>=><span class="blue"> append_if_no_line("$(dhcpd)"),</span>
<span class="red">     edit_defaults </span>=><span class="blue"> empty;</span>

  "/etc/dhcpd.conf"
<span class="red">     edit_line </span>=> append_if_no_line("$(dhcpd_conf)"),
<span class="red">     edit_defaults </span>=><span class="blue"> empty,</span>
<span class="red">     classes </span>=><span class="blue"> satisfied("dhcpd_ready");</span>

  "/etc/apache2/httpd.conf"
<span class="red">     edit_line </span>=> append_if_no_line("$(httpd_conf)"),
<span class="red">     edit_defaults </span>=><span class="blue"> std_defs,</span>
<span class="red">     classes </span>=><span class="blue"> satisfied("apache2_ok");</span>

<span class="comment">  # Make a static link
</span>


  "/tftpboot/pxelinux.cfg/C0A8000C"
<span class="red">     link_from </span>=><span class="blue"> mylink("/tftpboot/pxelinux.cfg/default.RHEL5.webserver");</span>

<span class="comment">  # Hash comment some lines for apaches
</span>


  apache2_ok::
  "/etc/apache2/httpd.conf"
<span class="red">     edit_line </span>=><span class="blue"> comment_lines_matching_apache2("#"),</span>
<span class="red">     classes </span>=><span class="blue"> satisfied("apache2_ready");</span>

<span class="red">commands:
</span>
<span class="comment">  # Restart services
</span>

  atftpd_ready::
  "/etc/init.d/atftpd restart";

  dhcpd_ready::
  "/etc/init.d/dhcpd restart";

  apache2_ready::
  "/etc/init.d/apache2 restart";


<span class="comment">#####################################################
</span>


<span class="red">packages:
</span>  
 ipv4_192_168_0_1::
<span class="comment"> # Only the PXE boot server
</span>


 "$(software)"

<span class="red">     package_policy </span>=><span class="green"> "add",</span>
<span class="red">     package_method </span>=><span class="blue"> zypper,</span>
<span class="red">     classes </span>=><span class="blue"> satisfied("packages_ok");</span>

}

<span class="comment">#####################################################
</span>

<span class="comment">########### *** Bodies are here *** #################
</span>

<span class="comment">#####################################################
</span>


<span class="red">body file_select</span> <span class="blue">pxelinux_files</span>

{
<span class="red">leaf_name </span>=> { "pxelinux.0" };

<span class="red">file_result </span>=><span class="green"> "leaf_name";</span>
}

<span class="comment">#####################################################
</span>


<span class="red">body copy_from</span> <span class="blue">mycopy_local(from,server)</span>

{
<span class="red">source      </span>=><span class="green"> "$(from)";</span>
<span class="red">compare     </span>=><span class="green"> "digest";</span>
}

<span class="comment">#########################################################
</span>


<span class="red">body link_from</span> <span class="blue">mylink(x)</span>
{
<span class="red">source </span>=><span class="green"> "$(x)";</span>
<span class="red">link_type </span>=><span class="green"> "symlink";</span>
}

<span class="comment">#######################################################
</span>


<span class="red">body classes</span> <span class="blue">satisfied(new_class)</span>

{
<span class="red">promise_kept </span>=> { "$(new_class)"};
<span class="red">promise_repaired </span>=> { "$(new_class)"};
}

<span class="comment">#######################################################
</span>


<span class="red">bundle edit_line</span> <span class="blue">comment_lines_matching_apache2(comment)</span>
  {
  
<span class="red">  vars:
</span>   "regex"<span class="red"> slist </span>=> { "\s.*Options\sNone", "\s.*AllowOverride\sNone", "\s.*Deny\sfrom\sall" };

<span class="red">  replace_patterns:
</span>
   "^($(regex))$"
<span class="red">      replace_with </span>=><span class="blue"> comment("$(comment)");</span>
  }

<span class="comment">#######################################################
</span>

<span class="red">body file_select</span> <span class="blue">input_files</span>
{
<span class="red"> leaf_name </span>=> { ".*.cf",".*.dat",".*.txt" };
<span class="red"> file_result </span>=><span class="green"> "leaf_name";</span>
}

<span class="comment">#######################################################
</span>

</pre>

<!--  -->
<div class="node">
<a name="Tidying-garbage-files"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Software-distribution">Software distribution</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Set-up-a-PXE-boot-server">Set up a PXE boot server</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.55 Tidying garbage files</h3>

<p>Emulating the `tidy' feature of CFEngine 2.

<pre class="verbatim">#######################################################
<span class="comment">#
</span>
<span class="comment"># Deleting files, like cf2 tidy age=0 r=inf
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
 any::

<span class="red">  bundlesequence  </span>=> { "testbundle" };   
}

<span class="comment">############################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/tmp/test" 

<span class="red">    delete </span>=><span class="blue"> tidyfiles,</span>
<span class="red">    file_select </span>=><span class="blue"> zero_age,</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("inf");</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body depth_search</span> <span class="blue">recurse(d)</span>

{
<span class="comment">#include_basedir => "true";
</span>
<span class="red">depth </span>=><span class="green"> "$(d)";</span>
}

<span class="comment">#########################################################
</span>

<span class="red">body delete</span> <span class="blue">tidy</span>

{
<span class="red">dirlinks </span>=><span class="green"> "delete";</span>
<span class="red">rmdirs   </span>=><span class="green"> "false"; </span>
}

<span class="comment">#########################################################
</span>

<span class="red">body file_select</span> <span class="blue">zero_age</span>

<span class="comment">#
</span>
<span class="comment"># we can build old "include", "exclude", and "ignore" 
</span>
<span class="comment"># from these as standard patterns - these bodies can
</span>
<span class="comment"># form a library of standard patterns
</span>
<span class="comment">#
</span>

{
<span class="red">mtime     </span>=> irange(ago(1,0,0,0,0,0),now);  
<span class="red">file_result </span>=><span class="green"> "mtime"; </span>
}

</pre>

<!--  -->
<ul class="menu">
<li><a accesskey="1" href="#Software-distribution">Software distribution</a>
<li><a accesskey="2" href="#Trigger-classes">Trigger classes</a>
</ul>

<div class="node">
<a name="Software-distribution"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Trigger-classes">Trigger classes</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Tidying-garbage-files">Tidying garbage files</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.56 Software distribution</h3>

<pre class="verbatim">
<span class="comment">#########################################################################
</span>
<span class="comment">#
</span>
<span class="comment">#   software_local.cf - Application Deployment From Directory Repository
</span>
<span class="comment">#
</span>
<span class="comment">#   NOTE: Windows needs to support WMI queries about installed msi files
</span>
<span class="comment">#         in order for Cfengine to detect them. On Windows 2003,
</span>
<span class="comment">#         go to Control Panel -> Add/Remove Programs -> 
</span>
<span class="comment">#         Windows Components -> Mgmnt and Monitoring Tools and check
</span>
<span class="comment">#         WMI Windows Installer Provider.
</span>
<span class="comment">#
</span>
<span class="comment">#   NOTE: Naming conventions are important when updating packages.
</span>
<span class="comment">#         By default, Cfengine expects "name-version-arch.msi" 
</span>
<span class="comment">#         on Windows, where name is lowercase, and arch is 
</span>
<span class="comment">#         i686 or x86_64. No spaces should be included in the filename.
</span>
<span class="comment">#         The Caption and Version fields inside the msi package
</span>
<span class="comment">#         are important. They must correspond to the file name as 
</span>
<span class="comment">#         follows: name = lowercase(spacetodash(Caption)), 
</span>
<span class="comment">#         version = Version. For any msi-file, use InstEd 
</span>
<span class="comment">#         (www.instedit.com) to check/modify the 
</span>
<span class="comment">#         Caption and Version fields 
</span>
<span class="comment">#         (Tables->Property->ProductName/ProductVersion).
</span>
<span class="comment">#
</span>
<span class="comment">#         For example, ProductName "CFEngine Nova" with ProductVersion
</span>
<span class="comment">#         "1.1.2" for 32-bit Windows will correspond to the filename
</span>
<span class="comment">#         "cfengine-nova-1.1.2-i686.msi".
</span>
<span class="comment">#
</span>
<span class="comment">#########################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">check_software</span>
{
<span class="red">vars:
</span>
<span class="comment"># software to install if not installed
</span>
 "include_software"<span class="red"> slist </span>=> {
                             "7-zip-4.50-$(sys.arch).msi"
                             };

<span class="comment"># this software gets updated if it is installed
</span>
 "autoupdate_software"<span class="red"> slist </span>=> { 
                               "7-zip"
                               };							 

<span class="comment"># software to uninstall if it is installed
</span>
 "exclude_software"<span class="red"> slist </span>=> {
                             "7-zip-4.65-$(sys.arch).msi"
                             };

<span class="red">methods:
</span><span class="comment">#  "any" usebundle => add_software( "@(check_software.include_software)", "$(sys.policy_hub)" );
</span>
<span class="comment">#  "any" usebundle => update_software( "@(check_software.autoupdate_software)", "$(sys.policy_hub)" );
</span>
<span class="comment">#  "any" usebundle => remove_software( "@(check_software.exclude_software)", "$(sys.policy_hub)" );
</span>
}

<span class="comment">#########################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">add_software(pkg_name,</span>
{
<span class="red">vars:
</span><span class="comment"># dir to install from locally - can also check multiple directories
</span>
 "local_software_dir"<span class="red"> string </span>=><span class="green"> "C:\Program Files\Cfengine\software\add";</span>
 
<span class="red">files:
</span>
  "$(local_software_dir)"
<span class="red">       copy_from </span>=><span class="blue"> remote_cp("/var/cfengine/master_software_updates/$(sys.flavour)_$(sys.arch)/add", "$(srv)"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("1"),</span>
<span class="red">         classes </span>=><span class="blue"> if_repaired("got_newpkg"),</span>
<span class="red">		 comment </span>=><span class="green"> "Copy software from remote repository";</span>


<span class="red">packages:
</span>
<span class="comment"># When to check if the package is installed ?
</span>
 got_newpkg|any::
  "$(pkg_name)"
<span class="red">    package_policy           </span>=><span class="green"> "add",</span>
<span class="red">    package_method           </span>=><span class="blue"> msi_implicit( "$(local_software_dir)" ),</span>
<span class="red">    classes                  </span>=><span class="blue"> if_else("add_success", "add_fail" ),</span>
<span class="red">    comment                  </span>=><span class="green"> "Install new software, if not already present";</span>

reports::
 add_fail::
   "Failed to install one or more packages";
}

<span class="comment">#########################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">update_software(sw_names,</span>
{
<span class="red">vars:
</span><span class="comment"># dir to install from locally - can also check multiple directories
</span>
 "local_software_dir"<span class="red"> string </span>=><span class="green"> "C:\Program Files\Cfengine\software\update";</span>
 
<span class="red">files:
</span>
  "$(local_software_dir)"
<span class="red">       copy_from </span>=><span class="blue"> remote_cp("/var/cfengine/master_software_updates/$(sys.flavour)_$(sys.arch)/update", "$(srv)"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("1"),</span>
<span class="red">         classes </span>=><span class="blue"> if_repaired("got_newpkg"),</span>
<span class="red">		 comment </span>=><span class="green"> "Copy software updates from remote repository";</span>
 
 
<span class="red">packages:
</span>
<span class="comment"># When to check if the package is updated ?
</span>
 got_newpkg|any::
  "$(sw_names)"
<span class="red">    package_policy           </span>=><span class="green"> "update",</span>
<span class="red">    package_select           </span>=><span class="green"> ">=",                 # picks the newest update available</span>
<span class="red">    package_architectures    </span>=> { "$(sys.arch)" },    # install 32 or 64 bit package ?
<span class="red">    package_version          </span>=><span class="green"> "1.0",                # at least version 1.0</span>
<span class="red">    package_method           </span>=><span class="blue"> msi_explicit( "$(local_software_dir)" ),</span>
<span class="red">    classes                  </span>=><span class="blue"> if_else("update_success", "update_fail");</span>

	
reports::
 update_fail::
   "Failed to update one or more packages";
}

<span class="comment">#########################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">remove_software(pkg_name,</span>
{
<span class="red">vars:
</span><span class="comment"># dir to install from locally - can also check multiple directories
</span>
 "local_software_dir"<span class="red"> string </span>=><span class="green"> "C:\Program Files\Cfengine\software\remove";</span>
 
<span class="red">files:
</span>
  "$(local_software_dir)"
<span class="red">       copy_from </span>=><span class="blue"> remote_cp("/var/cfengine/master_software_updates/$(sys.flavour)_$(sys.arch)/remove", "$(srv)"),</span>
<span class="red">    depth_search </span>=><span class="blue"> recurse("1"),</span>
<span class="red">         classes </span>=><span class="blue"> if_repaired("got_newpkg"),</span>
<span class="red">         comment </span>=><span class="green"> "Copy removable software from remote repository";</span>

<span class="red">packages:
</span>got_newpkg::
  "$(pkg_name)"
<span class="red">    package_policy           </span>=><span class="green"> "delete",</span>
<span class="red">    package_method           </span>=><span class="blue"> msi_implicit( "$(local_software_dir)" ),</span>
<span class="red">    classes                  </span>=><span class="blue"> if_else("remove_success", "remove_fail" ),</span>
<span class="red">    comment                  </span>=><span class="green"> "Remove software, if present";</span>

reports::
 remove_fail::
   "Failed to remove one or more packages";
}
</pre>

<!--  -->
<div class="node">
<a name="Trigger-classes"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Unmount-NFS-filesystem">Unmount NFS filesystem</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Software-distribution">Software distribution</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.57 Trigger classes</h3>

<pre class="verbatim">

<span class="comment">#######################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Insert a number of lines and trigger a followup if edited
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
any::

<span class="red">  bundlesequence  </span>=> { "insert" };   
}


<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">insert</span>

{
<span class="red">vars:
</span>
  "v"<span class="red"> string </span>=><span class="green"> "</span>
                One potato
                Two potato
                Three potahto
                Four
                ";
 
<span class="red">files:
</span>
  "/tmp/test_insert"

<span class="red">     edit_line </span>=><span class="blue"> Insert("$(insert.v)"),</span>
<span class="red">     edit_defaults </span>=><span class="blue"> empty,</span>
<span class="red">     classes </span>=><span class="blue"> trigger("edited");</span>

<span class="red">commands:
</span>
 edited::

  "/bin/echo make bananas";

<span class="red">reports:
</span>
  edited::

    "The potatoes are bananas";

}

<span class="comment">#######################################################
</span>
<span class="comment"># For the library
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">Insert(name)</span>

{
<span class="red">insert_lines:
</span>
  "Begin$(const.n) $(name)$(const.n)End";

}

<span class="comment">#######################################################
</span>

<span class="red">body edit_defaults</span> <span class="blue">empty</span>

{
<span class="red">empty_file_before_editing </span>=><span class="green"> "true";</span>
}

<span class="comment">#######################################################
</span>

<span class="red">body classes</span> <span class="blue">trigger(x)</span>

{
<span class="red">promise_repaired </span>=> { "$(x)" };
}
</pre>

<!--  -->
<div class="node">
<a name="Unmount-NFS-filesystem"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Web-server-modules">Web server modules</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Trigger-classes">Trigger classes</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.58 Unmount NFS filesystem</h3>

<pre class="verbatim">#####################################################################
<span class="comment"># Mount NFS
</span>
<span class="comment">#####################################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence </span>=> { "mounts" };
}

<span class="comment">#####################################################################
</span>

<span class="red">bundle agent</span> <span class="blue">mounts</span>

{
<span class="red">storage:
</span>
<span class="comment">  # Assumes the filesystem has been exported
</span>

  "/mnt"<span class="red"> mount  </span>=><span class="blue"> nfs("server.example.org","/home");</span>
}

<span class="comment">######################################################################
</span>

<span class="red">body mount</span> <span class="blue">nfs(server,source)</span>

{
<span class="red">mount_type </span>=><span class="green"> "nfs";</span>
<span class="red">mount_source </span>=><span class="green"> "$(source)";</span>
<span class="red">mount_server </span>=><span class="green"> "$(server)";</span>
<span class="red">edit_fstab </span>=><span class="green"> "true";</span>
<span class="red">unmount </span>=><span class="green"> "true";</span>
}
</pre>

<!--  -->
<div class="node">
<a name="Web-server-modules"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Warn-if-matching-line-in-file">Warn if matching line in file</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Unmount-NFS-filesystem">Unmount NFS filesystem</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.59 Web server modules</h3>

<p>The problem of editing the correct modules into the list of standard
modules for the Apache web server. This example is based on the
standard configuration deployment of SuSE Linux. Simply provide the
list of modules you want and another list that you don't want.

<pre class="verbatim">#######################################################
<span class="comment">#
</span>
<span class="comment"># Apache 2 reconfig - modelled on SuSE
</span>
<span class="comment">#
</span>
<span class="comment">#######################################################
</span>

<span class="red">body common control
</span>
{
any::

<span class="red">  bundlesequence  </span>=> {
                     apache
                     };   
}

<span class="comment">#######################################################
</span>

<span class="red">bundle agent</span> <span class="blue">apache</span>

{
<span class="red">files:
</span>
 SuSE::

  "/etc/sysconfig/apache2" 

<span class="red">     edit_line </span>=><span class="blue"> fixapache;</span>
}

<span class="comment">#######################################################
</span>
<span class="comment"># For the library
</span>
<span class="comment">#######################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">fixapache</span>

{ 
<span class="red">vars:
</span>
 "add_modules"<span class="red">     slist </span>=> { 
                            "dav", 
                            "dav_fs", 
                            "ssl", 
                            "php5", 
                            "dav_svn",
                            "xyz",
                            "superduper"
                            };

 "del_modules"<span class="red">     slist </span>=> { 
                            "php3",
                            "jk",
                            "userdir",
                            "imagemap",
                            "alias"
                            };

<span class="red">insert_lines:
</span>
 "APACHE_CONF_INCLUDE_FILES=\"/site/masterfiles/local-http.conf\"";

<span class="red">field_edits:
</span>
<span class="comment"> #####################################################################
</span>
<span class="comment"> # APACHE_MODULES="authz_host actions alias ..."
</span>
<span class="comment"> #####################################################################
</span>

<span class="comment">    # Values have the form NAME = "quoted space separated list"
</span>

   "APACHE_MODULES=.*"

<span class="comment">      # Insert module "columns" between the quoted RHS 
</span>
<span class="comment">      # using space separators
</span>

<span class="red">      edit_field </span>=><span class="blue"> quotedvar("$(add_modules)","append");</span>

   "APACHE_MODULES=.*"

<span class="comment">      # Delte module "columns" between the quoted RHS 
</span>
<span class="comment">      # using space separators
</span>

<span class="red">      edit_field </span>=><span class="blue"> quotedvar("$(del_modules)","delete");</span>

<span class="comment">   # if this line already exists, edit it  
</span>

}

</pre>

<!--  -->
<ul class="menu">
<li><a accesskey="1" href="#Warn-if-matching-line-in-file">Warn if matching line in file</a>
<li><a accesskey="2" href="#Windows-registry">Windows registry</a>
<li><a accesskey="3" href="#unit_005fregistry_005fcache_002ecf">unit_registry_cache.cf</a>
<li><a accesskey="4" href="#unit_005fregistry_002ecf">unit_registry.cf</a>
</ul>

<div class="node">
<a name="Warn-if-matching-line-in-file"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#Windows-registry">Windows registry</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Web-server-modules">Web server modules</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.60 Warn if matching line in file</h3>

<pre class="verbatim">
<span class="comment">########################################################
</span>
<span class="comment">#
</span>
<span class="comment"># Warn if line matched
</span>
<span class="comment">#
</span>
<span class="comment">########################################################
</span>

<span class="red">body common control
</span>
{
<span class="red">bundlesequence  </span>=> { "testbundle" };
}

<span class="comment">########################################################
</span>

<span class="red">bundle agent</span> <span class="blue">testbundle</span>

{
<span class="red">files:
</span>
  "/var/cfengine/inputs/.*"

<span class="red">       edit_line </span>=><span class="blue"> DeleteLinesMatching(".*cfenvd.*"),</span>
<span class="red">       action </span>=><span class="blue"> WarnOnly;</span>
}

<span class="comment">########################################################
</span>

<span class="red">bundle edit_line</span> <span class="blue">DeleteLinesMatching(regex)</span>
  {
<span class="red">  delete_lines:
</span>
    "$(regex)"<span class="red"> action </span>=><span class="blue"> WarnOnly;</span>

  }

<span class="comment">########################################################
</span>

<span class="red">body action</span> <span class="blue">WarnOnly</span>
{
<span class="red">action_policy </span>=><span class="green"> "warn";</span>
}
</pre>

<div class="node">
<a name="Windows-registry"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#unit_005fregistry_005fcache_002ecf">unit_registry_cache.cf</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Warn-if-matching-line-in-file">Warn if matching line in file</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.61 Windows registry</h3>

<pre class="verbatim">

<span class="red">body common control
</span>{
<span class="red">bundlesequence </span>=> { "reg" };
}

<span class="red">bundle agent</span> <span class="blue">reg</span>
{
<span class="red">vars:
</span>
  "value"<span class="red"> string </span>=> registryvalue("HKEY_LOCAL_MACHINE\SOFTWARE\Cfengine AS\Cfengine","value3");

<span class="red">reports:
</span>
  windows::

<span class="red">   "Value extracted: $(value)";
</span>
}
</pre>

<div class="node">
<a name="unit_registry_cache.cf"></a>
<a name="unit_005fregistry_005fcache_002ecf"></a>
<p><hr>
Next:&nbsp;<a rel="next" accesskey="n" href="#unit_005fregistry_002ecf">unit_registry.cf</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="#Windows-registry">Windows registry</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.62 unit_registry_cache.cf</h3>

<pre class="verbatim">
<span class="red">body common control
</span>{
<span class="red"> bundlesequence </span>=> {
<span class="comment">#                   "registry_cache"
</span>
<span class="comment">#                   "registry_restore"
</span>
                   };
}

<span class="comment">#########################################
</span>

<span class="red">bundle agent</span> <span class="blue">registry_cache</span>
{
<span class="red"> databases:
</span>  windows::

     "HKEY_LOCAL_MACHINE\SOFTWARE\Adobe"
<span class="red">        database_operation </span>=><span class="green"> "cache",</span>
<span class="red">        database_type      </span>=><span class="green"> "ms_registry",</span>
<span class="red">        comment </span>=><span class="green"> "Save correct registry settings for Adobe products";</span>
}

<span class="comment">#########################################
</span>

<span class="red">bundle agent</span> <span class="blue">registry_restore</span>
{
<span class="red"> databases:
</span>  windows::

     "HKEY_LOCAL_MACHINE\SOFTWARE\Adobe"
<span class="red">        database_operation </span>=><span class="green"> "restore",</span>
<span class="red">        database_type      </span>=><span class="green"> "ms_registry",</span>
<span class="red">        comment </span>=><span class="green"> "Make sure Adobe products have correct registry settings";</span>
}
</pre>

<div class="node">
<a name="unit_registry.cf"></a>
<a name="unit_005fregistry_002ecf"></a>
<p><hr>
Previous:&nbsp;<a rel="previous" accesskey="p" href="#unit_005fregistry_005fcache_002ecf">unit_registry_cache.cf</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="#Low-level">Low level</a>

</div>

<h3 class="section">3.63 unit_registry.cf</h3>

<pre class="verbatim">



<span class="red">body common control
</span>{
 
<span class="red">bundlesequence </span>=> { "databases" };
}


<span class="red">bundle agent</span> <span class="blue">databases</span>

{
<span class="red">databases:
</span>
 windows::

<span class="comment">  # Regsitry has (value,data) pairs in "keys" which are directories
</span>

<span class="comment">#  "HKEY_LOCAL_MACHINE\SOFTWARE\Cfengine AS"
</span>

<span class="comment">#    database_operation => "create", 
</span>
<span class="comment">#    database_type     => "ms_registry";
</span>

<span class="comment">#  "HKEY_LOCAL_MACHINE\SOFTWARE\Cfengine AS\Cfengine"
</span>

<span class="comment">#    database_operation => "create", 
</span>
<span class="comment">#    database_rows => { "value1,REG_SZ,new value 1", "value2,REG_SZ,new val 2"} ,
</span>
<span class="comment">#    database_type     => "ms_registry";
</span>


  "HKEY_LOCAL_MACHINE\SOFTWARE\Cfengine AS\Cfengine"

<span class="red">    database_operation </span>=><span class="green"> "delete", </span>
<span class="red">    database_columns </span>=> { "value1", "value2" } ,
<span class="red">    database_type </span>=><span class="green"> "ms_registry";</span>


<span class="comment"># "HKEY_LOCAL_MACHINE\SOFTWARE\Cfengine AS\Cfengine"
</span>

<span class="comment">#    database_operation => "cache",   # cache,restore
</span>

<span class="comment">#    registry_exclude => { ".*Windows.*CurrentVersion.*", ".*Touchpad.*", ".*Capabilities.FileAssociations.*", ".*Rfc1766.*" , ".*Synaptics.SynTP.*", ".*SupportedDevices.*8086", ".*Microsoft.*ErrorThresholds" },
</span>

<span class="comment">#    database_type     => "ms_registry";
</span>

"HKEY_LOCAL_MACHINE\SOFTWARE\Cfengine AS"

<span class="red">   database_operation </span>=><span class="green"> "restore",</span>
<span class="red">   database_type      </span>=><span class="green"> "ms_registry";</span>

}
</pre>

<!-- ========================================================================= -->
<!-- @node Index,  , CFEngine Methods, Top -->
<!-- @unnumbered Concept Index -->
<!-- @printindex cp -->
<!-- ========================================================================= -->
<p><script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-2576171-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>

<div class="footnote">
<hr>
<a name="texinfo-footnotes-in-document"></a><h4>Footnotes</h4><p class="footnote"><small>[<a name="fn-1" href="#fnd-1">1</a>]</small> In CFEngine 2
there is a separate action type for configuring the system
resolver. In CFEngine 3 this has been deprecated for this standard
method using the basic functionality of CFEngine.</p>

   <hr></div>

</body></html>


