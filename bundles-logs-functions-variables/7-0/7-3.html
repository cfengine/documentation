<h3>7.3 <code>guest_environments</code> promises in <samp><span>agent</span></samp></h3>

<p><br>

   <p>Guest environment promises describe enclosed computing environments that can host physical and virtual machines, Solaris zones, grids, clouds or
other enclosures, including embedded systems. CFEngine will support the convergent maintenance of such inner environments in a fixed location, with interfaces to an external environment.

   <p>CFEngine currently seeks to add convergence properties to existing interfaces for automatic self-healing of guest environments. The current implementation integrates with <i>libvirt</i>, supporting host virtualization for Xen, KVM, VMWare, etc. Thus CFEngine, running on a virtual host, can maintain the state and deployment of virtual guest machines defined within the <i>libvirt</i> framework. Guest environment promises are not meant to manage what goes on within the virtual guests. For that purpose you should run CFEngine directly on the virtual machine, as if it were any other machine.

   <p><br>

<pre>
 site1::

  "unique_name1"

       environment_resources => myresources("2GB","512MB"),
       environment_interface => mymachine("hostname"),
            environment_type => "xen",
            environment_state => "running",
            environment_host => "atlas";

  "unique_name2"

            environment_type => "xen_network",
           environment_state => "create",
            environment_host => "atlas";

</pre>

   <p><br>

   <p>CFEngine currently provides a convergent interface to <i>libvirt</i>.

<ul>
<li><a>environment_host in guest_environments</a>
<li><a>environment_interface in guest_environments</a>
<li><a>environment_resources in guest_environments</a>
<li><a>environment_state in guest_environments</a>
<li><a>environment_type in guest_environments</a>
</ul>

<div>
<a></a>
<a></a>

</div>

<h4>7.3.1 <code>environment_host</code></h4>

<p><b>Type</b>: string

<p><b>Allowed input range</b>: <code>[a-zA-Z0-9_]+</code>

<p><b>Synopsis</b>: A class indicating which physical node will execute this guest machine

<p><b>Example</b>:<br>
<br>

<pre>
guest_environments:

 linux::

 "host1"
                 comment => "Keep this vm suspended",
   environment_resources => myresources,
        environment_type => "kvm",
       environment_state => "suspended",
        environment_host => "ubuntu";

</pre>

<p><b>Notes</b>:<br>
<br>

   <p>The promise will only apply to the machine with this class set. Thus, CFEngine must be running locally on the hypervisor for the promise to
take effect.

   <p>This attribute is required.

   <p><i>History</i>: this feature was introduced in Nova 2.0.0 (2010), Community 3.3.0 (2012)

<div>
<a></a>
<a></a>

</div>

<h4>7.3.2 <code>environment_interface</code> (body template)</h4>

<p><b>Type</b>: (ext body)

     <dl>
<dt><samp><code>env_addresses</code></samp><dd><b>Type</b>: slist

     <p><b>Allowed input range</b>: (arbitrary string)

     <p><b>Synopsis</b>: The IP addresses of the environment's network interfaces

     <p><b>Example</b>:<br>
<br>

     <pre>     
     body environment_interface vnet(primary)
     {
     env_name      => "$(this.promiser)";
     env_addresses => { "$(primary)" };
     
     host1::
     
       env_network => "default_vnet1";
     
     host2::
     
       env_network => "default_vnet2";
     
     }
</pre>

     <p><b>Notes</b>:<br>
<br>

     <p>The IP addresses of the virtual machine can be overridden here at run time.

     <br><dt><samp><code>env_name</code></samp><dd><b>Type</b>: string

     <p><b>Allowed input range</b>: (arbitrary string)

     <p><b>Synopsis</b>: The hostname of the virtual environment

     <p><b>Example</b>:<br>
<br>

     <pre>     body environment_interface vnet(primary)
     {
     env_name      => "$(this.promiser)";
     env_addresses => { "$(primary)" };
     
     host1::
       env_network => "default_vnet1";
     
     host2::
       env_network => "default_vnet2";
     }
</pre>

     <p><b>Notes</b>:<br>
<br>

     <p>The `hostname' of a virtual guest may or may not be the same as the identifier used as `promiser' by the virtualization manager.

     <br><dt><samp><code>env_network</code></samp><dd><b>Type</b>: string

     <p><b>Allowed input range</b>: (arbitrary string)

     <p><b>Synopsis</b>: The hostname of the virtual network

     <p><b>Example</b>:<br>
<br>

     <pre>     
     body environment_interface vnet(primary)
          {
          env_name      => "$(this.promiser)";
          env_addresses => { "$(primary)" };
     
          host1::
            env_network => "default_vnet1";
     
          host2::
            env_network => "default_vnet2";
          }
     
</pre>



   </dl>

<div>
<a></a>
<a></a>

</div>

<h4>7.3.3 <code>environment_resources</code> (body template)</h4>

<p><b>Type</b>: (ext body)

     <dl>
<dt><samp><code>env_cpus</code></samp><dd><b>Type</b>: int

     <p><b>Allowed input range</b>: <code>0,99999999999</code>

     <p><b>Synopsis</b>: Number of virtual CPUs in the environment

     <p><b>Example</b>:<br>
<br>

     <pre>     
     body environment_resources my_environment
     {
     env_cpus => "2";
     env_memory => "512"; # in KB
     env_disk => "1024";  # in MB
     }
     
</pre>

     <p><b>Notes</b>:<br>
<br>

     <p>The maximum number of cores or processors in the physical environment will set a natural limit on this value.

     <p>This attribute conflicts with <code>env_spec</code>.

     <br><dt><samp><code>env_memory</code></samp><dd><b>Type</b>: int

     <p><b>Allowed input range</b>: <code>0,99999999999</code>

     <p><b>Synopsis</b>: Amount of primary storage (RAM) in the virtual environment (KB)

     <p><b>Example</b>:<br>
<br>

     <pre>     
     body environment_resources my_environment
     {
     env_cpus => "2";
     env_memory => "512"; # in KB
     env_disk => "1024";  # in MB
     }
     
</pre>

     <p><b>Notes</b>:<br>
<br>

     <p>The maximum amount of memory in the physical environment will set a natural limit on this value.

     <p>This attribute conflicts with <code>env_spec</code>.

     <br><dt><samp><code>env_disk</code></samp><dd><b>Type</b>: int

     <p><b>Allowed input range</b>: <code>0,99999999999</code>

     <p><b>Synopsis</b>: Amount of secondary storage (DISK) in the virtual environment (MB)

     <p><b>Example</b>:<br>
<br>

     <pre>     
     body environment_resources my_environment
     {
     env_cpus => "2";
     env_memory => "512"; # in KB
     env_disk => "1024";  # in MB
     }
     
</pre>

     <p><b>Notes</b>:<br>
<br>

     <p>This parameter is currently unsupported, for future extension.

     <p>This attribute conflicts with <code>env_spec</code>.

     <br><dt><samp><code>env_baseline</code></samp><dd><b>Type</b>: string

     <p><b>Allowed input range</b>: <code>"?(/.*)</code>

     <p><b>Synopsis</b>: The path to an image with which to baseline the virtual environment

     <p><b>Example</b>:<br>
<br>

     <pre>     
     env_baseline => "/path/to/image";
     
</pre>

     <p><b>Notes</b>:<br>
<br>

     <p>This function is for future development.

     <br><dt><samp><code>env_spec</code></samp><dd><b>Type</b>: string

     <p><b>Allowed input range</b>: <code>.*</code>

     <p><b>Synopsis</b>: A string containing a technology specific set of promises for the virtual instance

     <p><b>Example</b>:<br>
<br>

     <pre>     body environment_resources virt_xml(host)
     {
     env_spec => 
     
     "domain type='xen'>
       name>$(host)/name>
       os>
         type>linux/type>
         kernel>/var/lib/xen/install/vmlinuz-ubuntu10.4-x86_64/kernel>
         initrd>/var/lib/xen/install/initrd-vmlinuz-ubuntu10.4-x86_64/initrd>
         cmdline> kickstart=http://example.com/myguest.ks /cmdline>
       /os>
       memory>131072/memory>
       vcpu>1/vcpu>
       devices>
         disk type='file'>
           source file='/var/lib/xen/images/$(host).img'/>
           target dev='sda1'/>
         /disk>
         interface type='bridge'>
           source bridge='xenbr0'/>
           mac address='aa:00:00:00:00:11'/>
           script path='/etc/xen/scripts/vif-bridge'/>
         /interface>
         graphics type='vnc' port='-1'/>
         console tty='/dev/pts/5'/>
       /devices>
     /domain>
     ";
     }
     
</pre>

     <p><b>Notes</b>:<br>
<br>
The preferred way to specify the resources of an environment on creation; in other words, when <code>environment_state</code> is <samp><span>create</span></samp>.

     <p>This attribute conflicts with <code>env_cpus</code>, <code>env_memory</code> and <code>env_disk</code>.

     <p><i>History</i>: Was introduced in version 3.1.0b1,Nova 2.0.0b1 (2010)

   </dl>

<div>
<a></a>
<a></a>

</div>

<h4>7.3.4 <code>environment_state</code></h4>

<p><b>Type</b>: (menu option)

<p><b>Allowed input range</b>: <br>
<pre>               <code>create</code>
               <code>delete</code>
               <code>running</code>
               <code>suspended</code>
               <code>down</code>
</pre>
   <p><b>Synopsis</b>: The desired dynamical state of the specified environment 

<p><b>Example</b>:<br>
<br>

<pre>
guest_environments:

 linux::

 "bishwa-kvm1"
                 comment => "Keep this vm suspended",
   environment_resources => myresources,
        environment_type => "kvm",
       environment_state => "suspended",
        environment_host => "ubuntu";


</pre>

<p><b>Notes</b>:<br>
<br>

   <p>The allowed states have the following convergent semantics.

     <dl>
<dt><samp><span>create</span></samp><dd>The guest machine is allocated, installed and left in a running state.

     <br><dt><samp><span>delete</span></samp><dd>The guest machine is shut down and deallocated but no files are removed.

     <br><dt><samp><span>running</span></samp><dd>The guest machine is in a running state, if it previously exists.

     <br><dt><samp><span>suspended</span></samp><dd>The guest exists in a suspended state or a shutdown state. If the guest
is running, it is suspended; otherwise it is ignored.

     <br><dt><samp><span>down</span></samp><dd>The guest machine is shut down, but not deallocated.

   </dl>

<div>
<a></a>
<a></a>

</div>

<h4>7.3.5 <code>environment_type</code></h4>

<p><b>Type</b>: (menu option)

<p><b>Allowed input range</b>: <br>
<pre>               <code>xen</code>
               <code>kvm</code>
               <code>esx</code>
               <code>vbox</code>
               <code>test</code>
               <code>xen_net</code>
               <code>kvm_net</code>
               <code>esx_net</code>
               <code>test_net</code>
               <code>zone</code>
               <code>ec2</code>
               <code>eucalyptus</code>
</pre>
   <p><b>Synopsis</b>: Virtual environment type

<p><b>Example</b>:<br>
<br>

<pre>bundle agent my_vm_cloud
{
guest_environments:

 scope::

   "vguest1"

       environment_resources => my_environment_template,
       environment_interface => vnet("eth0,192.168.1.100/24"),
       environment_type      => "test",
       environment_state     => "create",
       environment_host      => "atlas";

   "vguest2"

       environment_resources => my_environment_template,
       environment_interface => vnet("eth0,192.168.1.101/24"),
       environment_type      => "test",
       environment_state     => "delete",
       environment_host      => "atlas";
}
</pre>

<p><b>Notes</b>:<br>
<br>

   <p>The currently supported types are those supported by <i>libvirt</i>. More will be added in the future.

<div>
<a></a>

</div>


